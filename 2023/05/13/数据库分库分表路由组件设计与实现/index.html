

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="bro_wangzai">
  <meta name="keywords" content="">
  
    <meta name="description" content="业务背景 为何自研路由组件？ 随着业务体量的增加，原先的库表存储已经不能支撑海量的并发请求。因此，可能需要考虑分库分表。 无论是业务之初就考虑分库分表，还是项目中期进行分库分表迁移，考虑自研数据库路由组件的出发点都是：现有的技术方案无法实现（不适合、不方便）个性化的业务需求，并且自研组件小而精，易于迭代维护，后续也可加入新的功能（例如事务支持） 分库、分表是两回事，可能只分库不分表，可能分表不">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库路由组件设计与实现">
<meta property="og:url" content="https://mokeeqian.github.io/2023/05/13/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E8%B7%AF%E7%94%B1%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="旺仔哥的小站">
<meta property="og:description" content="业务背景 为何自研路由组件？ 随着业务体量的增加，原先的库表存储已经不能支撑海量的并发请求。因此，可能需要考虑分库分表。 无论是业务之初就考虑分库分表，还是项目中期进行分库分表迁移，考虑自研数据库路由组件的出发点都是：现有的技术方案无法实现（不适合、不方便）个性化的业务需求，并且自研组件小而精，易于迭代维护，后续也可加入新的功能（例如事务支持） 分库、分表是两回事，可能只分库不分表，可能分表不">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868422759-e51f5bdc-93c6-440f-a222-05c6887ecae5.png#averageHue=%232b2b2b&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=205&amp;id=u47873811&amp;originHeight=315&amp;originWidth=474&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=uc57b09b7-9864-4bec-8f35-09d083847c8&amp;title=&amp;width=307.9829406738281">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868433798-1501e5cd-a545-4b25-853c-49563b05d3a8.png#averageHue=%233c3c3c&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=211&amp;id=ua3dd6804&amp;originHeight=267&amp;originWidth=320&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u59c074f1-2acd-4c02-96d7-b25044ba11a&amp;title=&amp;width=252.97726440429688">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868079770-2b0d126e-cb44-429b-8e9d-7093b035ec1b.png#averageHue=%23f5eae0&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=306&amp;id=ud054d93c&amp;originHeight=691&amp;originWidth=710&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=85260&amp;status=done&amp;style=none&amp;taskId=u6876318e-ac82-4ce8-ad7c-71dc104d055&amp;title=&amp;width=313.9829406738281">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/jpeg/29351684/1683870147946-a12a9368-e3fd-44ad-996b-b98af53f4474.jpeg">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/jpeg/29351684/1687596062861-f95c89e5-5c97-4cb5-b476-78e9c8d80ded.jpeg">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683910558463-7c96f9a7-ef81-4557-8c1e-656846b3bf7d.png#averageHue=%23ad8a49&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=244&amp;id=udf6dfd35&amp;originHeight=640&amp;originWidth=640&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=25340&amp;status=done&amp;style=none&amp;taskId=u00c946c1-19d1-42ac-8c68-5e0f049c3e1&amp;title=&amp;width=243.99429321289062">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868674064-09a7741f-ef77-43c6-ba21-843a140c7384.png#averageHue=%231f1f1f&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=459&amp;id=ub1fd1528&amp;originHeight=636&amp;originWidth=863&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=ub8f1269e-c99f-4440-9ba6-e73f329dafe&amp;title=&amp;width=622.1760864257812">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868776523-d993586d-94a9-4285-afac-2e8100de0524.png#averageHue=%231e1e1e&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=490&amp;id=u781d7428&amp;originHeight=661&amp;originWidth=864&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=ud24719c9-abcb-4983-a0c0-7f505cce0d5&amp;title=&amp;width=640.1760864257812">
<meta property="article:published_time" content="2023-05-13T04:16:24.000Z">
<meta property="article:modified_time" content="2023-09-03T08:34:17.536Z">
<meta property="article:author" content="bro_wangzai">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="MyBatis">
<meta property="article:tag" content="ThreadLocal">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868422759-e51f5bdc-93c6-440f-a222-05c6887ecae5.png#averageHue=%232b2b2b&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=205&amp;id=u47873811&amp;originHeight=315&amp;originWidth=474&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=uc57b09b7-9864-4bec-8f35-09d083847c8&amp;title=&amp;width=307.9829406738281">
  
  
  <title>数据库路由组件设计与实现 - 旺仔哥的小站</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  
    
    
      
      
        
          
        
        <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.26.0/themes/prism.min.css" />
      
      
        <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.css" />
      
    
  

  
    <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"mokeeqian.github.io","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>旺仔哥的小站</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="数据库路由组件设计与实现">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-05-13 12:16" pubdate>
        2023年5月13日 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      14k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      115 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">数据库路由组件设计与实现</h1>
            
            <div class="markdown-body">
              <meta name="referrer" content="no-referrer" />
<h1 id="业务背景"><a class="markdownIt-Anchor" href="#业务背景"></a> 业务背景</h1>
<p>为何自研路由组件？<br />
随着业务体量的增加，原先的库表存储已经不能支撑海量的并发请求。因此，可能需要考虑分库分表。<br />
无论是业务之初就考虑分库分表，还是项目中期进行分库分表迁移，考虑自研数据库路由组件的出发点都是：<strong>现有的技术方案无法实现（不适合、不方便）个性化的业务需求，并且自研组件小而精，易于迭代维护，后续也可加入新的功能（例如事务支持）</strong><br />
分库、分表是两回事，可能只分库不分表，可能分表不分库，也可能分库分表</p>
<table>
<thead>
<tr>
<th></th>
<th>分库分表前</th>
<th>分库分表后</th>
</tr>
</thead>
<tbody>
<tr>
<td>并发支撑情况</td>
<td>MySQL 单机部署，扛不住高并发</td>
<td>MySQL 从单机到多机，能承受的并发增加了多倍</td>
</tr>
<tr>
<td>磁盘使用情况</td>
<td>MySQL 单机磁盘容量几乎撑满</td>
<td>拆分为多个库，数据库服务器磁盘使用率大大降低</td>
</tr>
<tr>
<td>SQL 执行性能</td>
<td>单表数据量太大，SQL 越跑越慢</td>
<td>单表数据量减少，SQL 执行效率明显提升</td>
</tr>
</tbody>
</table>
<h2 id="水平拆分"><a class="markdownIt-Anchor" href="#水平拆分"></a> 水平拆分</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868422759-e51f5bdc-93c6-440f-a222-05c6887ecae5.png#averageHue=%232b2b2b&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=205&amp;id=u47873811&amp;originHeight=315&amp;originWidth=474&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=uc57b09b7-9864-4bec-8f35-09d083847c8&amp;title=&amp;width=307.9829406738281" srcset="/img/loading.gif" lazyload alt="" /></p>
<h2 id="垂直拆分"><a class="markdownIt-Anchor" href="#垂直拆分"></a> 垂直拆分</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868433798-1501e5cd-a545-4b25-853c-49563b05d3a8.png#averageHue=%233c3c3c&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=211&amp;id=ua3dd6804&amp;originHeight=267&amp;originWidth=320&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u59c074f1-2acd-4c02-96d7-b25044ba11a&amp;title=&amp;width=252.97726440429688" srcset="/img/loading.gif" lazyload alt="" /></p>
<h1 id="技术调研"><a class="markdownIt-Anchor" href="#技术调研"></a> 技术调研</h1>
<p>现有的分库分表组件主要有如下两种：</p>
<h2 id="基于代理"><a class="markdownIt-Anchor" href="#基于代理"></a> 基于代理</h2>
<p>在应用和数据中间加了一个代理层。应用程序所有的数据请求都交给代理层处理，代理层负责分离读写请求，将它们路由到对应的数据库中。<br />
提供类似功能的中间件有 MySQL Router（官方）、Atlas（基于 MySQL Proxy）、MaxScale、MyCat。</p>
<h2 id="基于组件"><a class="markdownIt-Anchor" href="#基于组件"></a> 基于组件</h2>
<p>基于组件的则直接基于独立的 jar 包就可以进行开发，不用部署，运维成本低，不需要代理层的二次转发请求，性能很高**。**比较经典的就是 Sharding-JDBC<br />
<img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868079770-2b0d126e-cb44-429b-8e9d-7093b035ec1b.png#averageHue=%23f5eae0&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=306&amp;id=ud054d93c&amp;originHeight=691&amp;originWidth=710&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=85260&amp;status=done&amp;style=none&amp;taskId=u6876318e-ac82-4ce8-ad7c-71dc104d055&amp;title=&amp;width=313.9829406738281" srcset="/img/loading.gif" lazyload alt="image.png" /></p>
<h1 id="方案设计"><a class="markdownIt-Anchor" href="#方案设计"></a> 方案设计</h1>
<h2 id="挑战"><a class="markdownIt-Anchor" href="#挑战"></a> 挑战</h2>
<p>:::warning</p>
<ol>
<li>实现层面：组件需要知道<strong>数据需要从哪个具体的数据库的子表中获取，并且对用户透明</strong></li>
</ol>
<ul>
<li>**数据源切换：**如何在组件中实现_动态数据源切换_</li>
<li>**路由算法：**如何实现比较均匀的_路由散列算法_</li>
<li>**SQL 改写：**如何_拦截并修改 SQL_</li>
</ul>
<ol start="2">
<li>引入数据分片带来的问题：主要考虑<strong>跨表连接查询、跨库事务问题</strong></li>
</ol>
<ul>
<li>**跨表连接查询：**通常两种方案：（1）解决跨表查询；（2）规避跨表连接，采用第三方中间件汇总查询</li>
<li>**跨库事务：**这块也是痛点，通常有两种做法：（1）分布式事务；（2）规避分布式事务问题，采用最终一致性方案<br />
:::</li>
</ul>
<blockquote>
<p>Tips：<br />
关于以上跨表连接查询、跨库事务具体解决方案，<em>需要根据业务场景、对于数据一致性的要求、综合性能等综合考虑</em>。<br />
例如：</p>
<ul>
<li>秒杀场景下，关于库存的处理，就不太适合使用繁重的分布式事务，采用最终一致性方案（MQ+JOB兜底）比较合适；反之，对于金融等场景，考虑分布式事务比较合适</li>
<li>对于 B 端系统的跨表查询场景，业务访问量也不会很大，考虑适配跨表连接方案代价就比较高了，相反采用 ES 汇总查询，相对来说容易接受一点</li>
</ul>
</blockquote>
<h2 id="架构图"><a class="markdownIt-Anchor" href="#架构图"></a> 架构图</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/29351684/1683870147946-a12a9368-e3fd-44ad-996b-b98af53f4474.jpeg" srcset="/img/loading.gif" lazyload alt="" /><br />
主要包括：</p>
<ul>
<li>AOP 切面拦截：拦截需要使用DB 路由的方法，这里采用自定义注解</li>
<li>数据库连接池配置：分库分表需要按需配置数据库连接源，在这些连接池的集合中进行<strong>动态数据源切换</strong></li>
<li><code>AbstractRoutingDataSource</code>：是用于动态数据源切换的 Spring 服务类，提供了数据源切换的抽象方法 <code>determineCurrentLookupKey</code></li>
<li>路由哈希算法设计：在路由设计时，需要根据分库分表字段进行路由计算，让数据均匀地分布至各个库表之中。这里参考 HashMap 的 扰动函数设计</li>
<li>MyBatis 拦截器：实现 sql 动态拦截和修改</li>
</ul>
<h2 id="流程图"><a class="markdownIt-Anchor" href="#流程图"></a> 流程图</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/29351684/1687596062861-f95c89e5-5c97-4cb5-b476-78e9c8d80ded.jpeg" srcset="/img/loading.gif" lazyload alt="" /></p>
<h1 id="技术实现"><a class="markdownIt-Anchor" href="#技术实现"></a> 技术实现</h1>
<h2 id="工程结构"><a class="markdownIt-Anchor" href="#工程结构"></a> 工程结构</h2>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">├─src
│  ├─main
│  │  ├─java
│  │  │  └─cn
│  │  │      └─mokeeqian
│  │  │          └─middleware
│  │  │              └─db
│  │  │                  └─router
│  │  │                      ├─annotation
│  │  │                      ├─config
│  │  │                      ├─dynamic
│  │  │                      ├─strategy
│  │  │                      │  └─impl
│  │  │                      └─util
│  │  └─resources
│  │      └─META-INF
│  └─test
│      └─java
│          └─cn
│              └─mokeeqian
│                  └─middleware
│                      └─test
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><strong>代码仓库</strong><br />
<a target="_blank" rel="noopener" href="https://github.com/mokeeqian/mokeeqian-spring-boot-starter/tree/main/db-router-spring-boot-starter">mokeeqian-spring-boot-starter/db-router-spring-boot-starter at main · mokeeqian/mokeeqian-spring-boot-starter</a></p>
<h2 id="自定义路由注解"><a class="markdownIt-Anchor" href="#自定义路由注解"></a> 自定义路由注解</h2>
<p><strong>路由注解</strong><br />
为切面提供切点，同时获取被注解的方法入参属性中的路由字段</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DBRouter</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 路由字段
     * @return
     */</span>
    <span class="token class-name">String</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<ul>
<li>@Retention：告诉编译程序如何处理，也可理解为注解类的生命周期。</li>
<li>@Target：该注解的作用点，主要有：TYPE（类、接口）、METHOD（方法）、PACKAGE、FIELD、PARAMETER等。这里我们选择作用在方法上。</li>
</ul>
<p><strong>路由策略注解</strong></p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DBRouterStrategy</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 是否分表
     * @return
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">splitTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2 id="动态数据源切换"><a class="markdownIt-Anchor" href="#动态数据源切换"></a> 🔃动态数据源切换</h2>
<p>继承抽象类 <code>AbstractRoutingDataSource</code>，实现其 <code>determineCurrentLookupKey</code> 方法，从 DBContextHolder中获取 DB key，用以实现动态切换数据源</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicDataSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutingDataSource</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 返回 db 路由
     * @return aka db01, db02, ...
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"db"</span> <span class="token operator">+</span> <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">getDbKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>AbstractRoutingDataSource的getConnection() ⽅法根据查找 lookup key 键对不同⽬标数据源的调⽤， 通常是通过(但不⼀定)某些线程绑定的事物上下⽂来实现<br />
AbstractRoutingDataSource的多数据源动态 切换的核⼼逻辑是：在程序运⾏时，把数据源数据源通过AbstractRoutingDataSource 动态织⼊到程序 中，灵活的进⾏数据源切换<br />
基于AbstractRoutingDataSource的多数据源动态切换，可以实现读写分离，这么做缺点也很明显，⽆法 动态的增加数据源</p>
<h2 id="️配置-加载-创建数据源"><a class="markdownIt-Anchor" href="#️配置-加载-创建数据源"></a> ⚙️配置、加载、创建数据源</h2>
<p>对于较复杂的数据源配置，一般使用 <code>org.springframework.context.EnvironmentAware</code>来实现：<br />
<strong>EnvironmentAware#setEnvironment：读取 yml 配置文件中的自定义分库分表配置</strong></p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> prefix <span class="token operator">=</span> <span class="token string">"mini-db-router.jdbc.datasource."</span><span class="token punctuation">;</span>

	dbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"dbCount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	tbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"tbCount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	routerKey <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"routerKey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 分库列表 db01,db02</span>
	<span class="token class-name">String</span> dataSources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">assert</span> dataSources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSources<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> dataSourceProps <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> dbInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> dataSourceProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 默认数据源</span>
	<span class="token class-name">String</span> defaultData <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	defaultDataSourceConfig <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> defaultData<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">router</span><span class="token punctuation">:</span>
  <span class="token key atrule">jdbc</span><span class="token punctuation">:</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
	    <span class="token comment"># 从这里开始就是数据源的配置了</span>
      <span class="token key atrule">dbCount</span><span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token key atrule">tbCount</span><span class="token punctuation">:</span> <span class="token number">4</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span> db00
      <span class="token key atrule">routerKey</span><span class="token punctuation">:</span> uId	<span class="token comment"># 路由字段</span>
      <span class="token key atrule">list</span><span class="token punctuation">:</span> db01<span class="token punctuation">,</span>db02 <span class="token comment"># 分库</span>
      <span class="token key atrule">db00</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/lottery<span class="token punctuation">?</span>useUnicode=true
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx
      <span class="token key atrule">db01</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/lottery_01<span class="token punctuation">?</span>useUnicode=true
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx
      <span class="token key atrule">db02</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/lottery_02<span class="token punctuation">?</span>useUnicode=true
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><strong>创建数据源：DynamicDataSource#setTargetDataSources，DynamicDataSource#setDefaultTargetDataSource</strong></p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 创建数据源</span>
	<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> targetDataSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> objMap <span class="token operator">=</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>
				objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 设置数据源</span>
	<span class="token class-name">DynamicDataSource</span> dynamicDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dynamicDataSource<span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dynamicDataSource<span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>
		defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
		defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
		defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> dynamicDataSource<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2 id="threadlocal-保存路由结果"><a class="markdownIt-Anchor" href="#threadlocal-保存路由结果"></a> ThreadLocal 保存路由结果</h2>
<p>使用 ThreadLocal 保存分库、分表的路由结果，借鉴 SecurityContextHolder</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DBContextHolder</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dbKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> tbKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getDBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> dbKey<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getTBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> tbKey<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setDBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbKeyIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        dbKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dbKeyIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setTBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> tbKeyIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        tbKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tbKeyIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clearDBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        dbKey<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clearTBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        tbKey<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2 id="具体路由策略"><a class="markdownIt-Anchor" href="#具体路由策略"></a> 具体路由策略</h2>
<p>这里采用接口 <code>IDBRouterStrategy</code> ，后续可以实现该接口，进行个性化的路由策略配置<br />
<img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683910558463-7c96f9a7-ef81-4557-8c1e-656846b3bf7d.png#averageHue=%23ad8a49&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=244&amp;id=udf6dfd35&amp;originHeight=640&amp;originWidth=640&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=25340&amp;status=done&amp;style=none&amp;taskId=u00c946c1-19d1-42ac-8c68-5e0f049c3e1&amp;title=&amp;width=243.99429321289062" srcset="/img/loading.gif" lazyload alt="image.png" /><br />
<strong>基于HashMap 扰动函数思想实现路由分发</strong></p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbKeyAttr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> size <span class="token operator">=</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getDbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 扰动函数；在 JDK 的 HashMap 中，对于一个元素的存放，需要进行哈希散列。而为了让散列更加均匀，所以添加了扰动函数。</span>
	<span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 库表索引；相当于是把一个长条的桶，切割成段，对应分库分表中的库编号和表编号</span>
	<span class="token keyword">int</span> dbIdx <span class="token operator">=</span> idx <span class="token operator">/</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tbIdx <span class="token operator">=</span> idx <span class="token operator">-</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>dbIdx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 设置到 ThreadLocal</span>
	<span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">setDBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%02d"</span><span class="token punctuation">,</span> dbIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">setTBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%03d"</span><span class="token punctuation">,</span> tbIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"数据库路由 dbIdx：&#123;&#125; tbIdx：&#123;&#125;"</span><span class="token punctuation">,</span>  dbIdx<span class="token punctuation">,</span> tbIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2 id="动态-sql-修改"><a class="markdownIt-Anchor" href="#动态-sql-修改"></a> ✅动态 SQL 修改</h2>
<p>基于以上，分库功能已经实现，但是，如何分表？即将<strong>逻辑 SQL</strong> 转化为 **物理 SQL，**例如：<br />
逻辑SQL：<code>SELECT * FROM tb_user WHERE id = 123;</code><br />
物理SQL：<code>SELECT * FROM tb_user_01 WHERE id = 123;</code><br />
<strong>一种思路是：使用 MyBatis 的 Interceptor 进行 SQL 拦截，然后动态修改 SQL</strong><br />
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/286476884">mybatis：自定义实现拦截器插件Interceptor</a></p>
<ul>
<li>**@**Intercepts注解：拦截器<br />
可以被拦截的四种类型：
<ul>
<li>Executor：拦截执行器的方法</li>
<li>ParameterHandler：拦截参数的处理</li>
<li>ResultHandler：拦截结果集的处理</li>
<li><em>StatementHandler：拦截Sql语法构建的处理</em></li>
</ul>
</li>
<li>@Signature注解：拦截点，指定拦截哪个对象里面的哪个方法<br />
其参数如下：
<ul>
<li>type：要被拦截的类型（上述四种之一）</li>
<li>method：在类型基础上，指定被拦截的方法</li>
<li>args：在方法基础上，指定方法入参参数（Java里可能存在重载，故要注意参数顺序和类型）</li>
</ul>
</li>
<li>类型&amp;方法一览<br />
| 拦截类型 | 拦截方法 |<br />
| — | — |<br />
| Executor | update、query、flushStatements、commit、rollback、getTransaction、close、isClosed |<br />
| ParameterHandler | getParameterObject、setParameters |<br />
| ResultHandler | handleResultSets、handleOutputParameters |<br />
| StatementHandler | prepare、parameterize、batch、update、query |</li>
</ul>
<p>StatementHandler 的具体方法：</p>
<ul>
<li>prepare: ⽤于创建⼀个具体的 Statement 对象的实现类或者是 Statement 对象</li>
<li>parametersize: ⽤于初始化 Statement 对象以及对sql的占位符进⾏赋值</li>
<li>update: ⽤于通知 Statement 对象将 insert、update、delete 操作推送到数据库</li>
<li>query: ⽤于通知 Statement 对象将 select 操作推送数据库并返回对应的查询结果</li>
</ul>
<p>我们主要使用 StatementHandler 的 prepare 方法，拦截 sql 语句</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">StatementHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"prepare"</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div>
<p><em>这里的 Interceptor#intercept 方法就是我们要实现的方法，其中，invocation 就是被拦截的对象（StatementHandler#prepare方法）</em></p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author Clinton Begin
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>
  <span class="token keyword">default</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// NOP</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><strong>如何获取 MyBatis 中的 SQL 语句？</strong><br />
基于 <code>StatementHandler</code>，然后 获取其 BoundSql</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 获取 StatementHandler</span>
<span class="token class-name">StatementHandler</span> statementHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatementHandler</span><span class="token punctuation">)</span> invocation<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MetaObject</span> metaObject <span class="token operator">=</span> <span class="token class-name">MetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>statementHandler<span class="token punctuation">,</span> <span class="token class-name">SystemMetaObject</span><span class="token punctuation">.</span>DEFAULT_OBJECT_FACTORY<span class="token punctuation">,</span>
		<span class="token class-name">SystemMetaObject</span><span class="token punctuation">.</span>DEFAULT_OBJECT_WRAPPER_FACTORY<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MappedStatement</span> mappedStatement <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MappedStatement</span><span class="token punctuation">)</span> metaObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"delegate.mappedStatement"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取 MyBatis 原始 SQL</span>
<span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> statementHandler<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> originalSql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><strong>如何识别 SQL 中的表名称？</strong><br />
使用正则表达式匹配：from，into，update 这三个关键字，其之后就是表名称</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Pattern</span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"(from|into|update)[\\s]&#123;1,&#125;(\\w&#123;1,&#125;)"</span><span class="token punctuation">,</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span>CASE_INSENSITIVE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div>
<p><strong>识别之后如何替换？</strong><br />
使用反射，直接修改 <code>BoundSql#sql</code> 字段</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 通过反射修改 sql 语句</span>
<span class="token comment">// getDeclaredField：可以获取所有已声明字段（无视访问限定符）; getField：只能获取public 字段</span>
<span class="token class-name">Field</span> field <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">,</span> replacedSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<ul>
<li>使用反射可以访问 Java 类的私有成员、私有方法。在框架开发中，用处十分广泛</li>
</ul>
<h2 id="aop-实现调用方法拦截"><a class="markdownIt-Anchor" href="#aop-实现调用方法拦截"></a> 🚫AOP 实现调用方法拦截</h2>
<p>目前为止，底层逻辑已经全部实现，现在只需要使用AOP对调用方法进行拦截处理即可<br />
<strong>定义切点</strong><br />
这里直接拦截先前定义的自定义注解，也可以是使用表达式匹配</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 切点
 */</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"@annotation(cn.mokeeqian.middleware.db.router.annotation.DBRouter)"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aopPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><strong>定义切面拦截具体逻辑</strong></p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 切面拦截后的具体操作
 * @param proceedingJoinPoint
 * @param dbRouter
 * @return
 * @throws Throwable
 */</span>
<span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"aopPoint() &amp;&amp; @annotation(dbRouter)"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> proceedingJoinPoint<span class="token punctuation">,</span> <span class="token class-name">DBRouter</span> dbRouter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> dbKey <span class="token operator">=</span> dbRouter<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">.</span><span class="token function">getRouterKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"annotation DBRouter key is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 如果注解中没配置 key，则使用配置文件的 key</span>
	dbKey <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">)</span> <span class="token operator">?</span> dbKey <span class="token operator">:</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getRouterKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 计算路由</span>
	<span class="token class-name">String</span> dbKeyAttr <span class="token operator">=</span> <span class="token function">getAttrValue</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">,</span> proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 路由分发</span>
	dbRouterStrategy<span class="token punctuation">.</span><span class="token function">doRouter</span><span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 返回结果</span>
	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 放行</span>
		<span class="token keyword">return</span> proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 清除 ThreadLocal</span>
		dbRouterStrategy<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<ul>
<li>几种切面环绕逻辑：
<ul>
<li>@Before：前置通知，在方法执行之前执行</li>
<li>@After：后置通知，在方法执行之后执行（即使出现异常，后置通知也会执行）</li>
<li>@Around：环绕通知，围绕着方法执行（可以实现其他四种通知）</li>
<li>@AfterReturning：返回通知，在方法返回结果之后执行</li>
<li>@AfterThrowing：异常通知，在方法抛出异常之后</li>
</ul>
</li>
<li>AspectJ 注解的执行顺序：<br />
<em>@Around 都会出现两次：@Before、@AfterReturning、@AfterReturning、@After 这四个都会在两次@Around 执行之间被执行</em>
<ul>
<li>无异常时：@Aspect、@Pointcut、@Around、@Before、@AfterReturning、@After、@Around</li>
<li>有异常时：@Aspect、@Pointcut、@Around、@Before、@AfterThrowing、@After、@Around</li>
</ul>
</li>
<li><code>@Around(&quot;aopPoint() &amp;&amp; @annotation(dbRouter)&quot;)</code>的理解</li>
</ul>
<h2 id="封装起步依赖"><a class="markdownIt-Anchor" href="#封装起步依赖"></a> 封装起步依赖</h2>
<p>最后的最后，将项目封装成 SpringBoot 起步依赖，编写配置类，然后利用自动装配机制。</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceAutoConfigure</span> <span class="token keyword">implements</span> <span class="token class-name">EnvironmentAware</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 数据源配置组
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> dataSourceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 默认数据源配置
     * 也就是：不走路由组件的数据源
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> defaultDataSourceConfig<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 分库数目
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> dbCount<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 分表数目
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> tbCount<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 路由字段
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> routerKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">IDBRouterStrategy</span> <span class="token function">doRouterStrategy</span><span class="token punctuation">(</span><span class="token class-name">DBRouterConfig</span> dbRouterConfig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterStrategyHashCode</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DBRouterConfig</span> <span class="token function">dbRouterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dbCount<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tbCount<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>routerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Interceptor</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DynamicMybatisPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"db-router-point"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">DBRouterJoinPoint</span> <span class="token function">dbRouterJoinPoint</span><span class="token punctuation">(</span><span class="token class-name">DBRouterConfig</span> dbRouterConfig<span class="token punctuation">,</span> <span class="token class-name">IDBRouterStrategy</span> dbRouterStrategy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterJoinPoint</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">,</span> dbRouterStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 创建动态数据源
     * 这个数据源就会被 MyBatis SpringBoot Starter 中 SqlSessionFactory sqlSessionFactory(DataSource dataSource) 注入使用
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建数据源</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> targetDataSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> objMap <span class="token operator">=</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>
                    objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 设置数据源</span>
        <span class="token class-name">DynamicDataSource</span> dynamicDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dynamicDataSource<span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dynamicDataSource<span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> dynamicDataSource<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionTemplate</span> <span class="token function">transactionTemplate</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DataSourceTransactionManager</span> dataSourceTransactionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceTransactionManager<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TransactionTemplate</span> transactionTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transactionTemplate<span class="token punctuation">.</span><span class="token function">setTransactionManager</span><span class="token punctuation">(</span>dataSourceTransactionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transactionTemplate<span class="token punctuation">.</span><span class="token function">setPropagationBehaviorName</span><span class="token punctuation">(</span><span class="token string">"PROPAGATION_REQUIRED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transactionTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 读取 yml 中自定义的配置
     * @param environment
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> prefix <span class="token operator">=</span> <span class="token string">"mini-db-router.jdbc.datasource."</span><span class="token punctuation">;</span>

        dbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"dbCount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"tbCount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        routerKey <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"routerKey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 分库列表 db01,db02</span>
        <span class="token class-name">String</span> dataSources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> dataSources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSources<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> dataSourceProps <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> dbInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> dataSourceProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 默认数据源</span>
        <span class="token class-name">String</span> defaultData <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultDataSourceConfig <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> defaultData<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>随后，需要编写 <code>resources/META_INF/spring.factories</code> 文件，配置数据源配置类</p>
<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span>EnableAutoConfiguration</span><span class="token operator">=</span><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>mokeeqian<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>db<span class="token punctuation">.</span>router<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>DataSourceAutoConfigure</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div>
<p>最后，将项目打包到 maven 仓库，即可使用啦</p>
<h1 id="番外分库分表平滑过渡"><a class="markdownIt-Anchor" href="#番外分库分表平滑过渡"></a> 【番外】分库分表平滑过渡？</h1>
<p>基于原先的单库单表，现在如何做迁移？</p>
<h2 id="停机迁移"><a class="markdownIt-Anchor" href="#停机迁移"></a> 停机迁移</h2>
<p>最简单的就是直接停机迁移，停止一切写入。然后将旧库数据迁移至新库。<br />
<img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868674064-09a7741f-ef77-43c6-ba21-843a140c7384.png#averageHue=%231f1f1f&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=459&amp;id=ub1fd1528&amp;originHeight=636&amp;originWidth=863&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=ub8f1269e-c99f-4440-9ba6-e73f329dafe&amp;title=&amp;width=622.1760864257812" srcset="/img/loading.gif" lazyload alt="" /></p>
<h2 id="双写迁移"><a class="markdownIt-Anchor" href="#双写迁移"></a> 双写迁移</h2>
<p>如果线上业务不能停机怎么办？</p>
<ul>
<li>我们对老库的更新操作（增删改），同时也要写入新库（双写）。如果操作的数据不存在于新库的话，需要插入到新库中。 这样就能保证，咱们新库里的数据是最新的。</li>
<li>在迁移过程，双写只会让被更新操作过的老库中的数据同步到新库，我们_还需要自己写脚本将老库中的数据和新库的数据做比对_。如果新库中没有，那咱们就把数据插入到新库。如果新库有，旧库没有，就把新库对应的数据删除（冗余数据清理）。</li>
<li>重复上一步的操作，直到老库和新库的数据一致为止</li>
</ul>
<p>这块其实可以借助 Canal 等中间件（binlog主从同步原理）来实现<br />
<img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868776523-d993586d-94a9-4285-afac-2e8100de0524.png#averageHue=%231e1e1e&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=490&amp;id=u781d7428&amp;originHeight=661&amp;originWidth=864&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=ud24719c9-abcb-4983-a0c0-7f505cce0d5&amp;title=&amp;width=640.1760864257812" srcset="/img/loading.gif" lazyload alt="" /></p>
<h1 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章"></a> 参考文章</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/">apache shardingsphere</a></li>
<li><a target="_blank" rel="noopener" href="https://bugstack.cn/">bugstack</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/MySQL/">MySQL</a>
                    
                      <a class="hover-with-bg" href="/tags/MyBatis/">MyBatis</a>
                    
                      <a class="hover-with-bg" href="/tags/ThreadLocal/">ThreadLocal</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/09/03/NACOS%E5%AD%A6%E4%B9%A0&amp;%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">NACOS学习&最佳实践</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/12/20/%E5%9B%BE%E8%AE%BA%E6%90%9C%E7%B4%A2%E6%A8%A1%E6%9D%BF/">
                        <span class="hidden-mobile">图论搜索模板</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  
    
  



  
    <script  src="https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js" ></script>
  
  
    <script  src="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js" ></script>
  
  
    <script defer src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js" ></script>
  






  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
