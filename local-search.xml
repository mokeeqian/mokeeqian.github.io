<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>æ•°æ®åº“åˆ†åº“åˆ†è¡¨è·¯ç”±ç»„ä»¶è®¾è®¡ä¸å®ç°</title>
    <link href="/2023/05/13/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E8%B7%AF%E7%94%B1%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/05/13/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E8%B7%AF%E7%94%B1%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸šåŠ¡èƒŒæ™¯"><a class="markdownIt-Anchor" href="#ä¸šåŠ¡èƒŒæ™¯"></a> ä¸šåŠ¡èƒŒæ™¯</h1><p>ä¸ºä½•è‡ªç ”è·¯ç”±ç»„ä»¶ï¼Ÿ<br />éšç€ä¸šåŠ¡ä½“é‡çš„å¢åŠ ï¼ŒåŸå…ˆçš„åº“è¡¨å­˜å‚¨å·²ç»ä¸èƒ½æ”¯æ’‘æµ·é‡çš„å¹¶å‘è¯·æ±‚ã€‚å› æ­¤ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘åˆ†åº“åˆ†è¡¨ã€‚<br />æ— è®ºæ˜¯ä¸šåŠ¡ä¹‹åˆå°±è€ƒè™‘åˆ†åº“åˆ†è¡¨ï¼Œè¿˜æ˜¯é¡¹ç›®ä¸­æœŸè¿›è¡Œåˆ†åº“åˆ†è¡¨è¿ç§»ï¼Œè€ƒè™‘è‡ªç ”æ•°æ®åº“è·¯ç”±ç»„ä»¶çš„å‡ºå‘ç‚¹éƒ½æ˜¯ï¼š<strong>ç°æœ‰çš„æŠ€æœ¯æ–¹æ¡ˆæ— æ³•å®ç°ï¼ˆä¸é€‚åˆã€ä¸æ–¹ä¾¿ï¼‰ä¸ªæ€§åŒ–çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå¹¶ä¸”è‡ªç ”ç»„ä»¶å°è€Œç²¾ï¼Œæ˜“äºè¿­ä»£ç»´æŠ¤ï¼Œåç»­ä¹Ÿå¯åŠ å…¥æ–°çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚äº‹åŠ¡æ”¯æŒï¼‰</strong><br />åˆ†åº“ã€åˆ†è¡¨æ˜¯ä¸¤å›äº‹ï¼Œå¯èƒ½åªåˆ†åº“ä¸åˆ†è¡¨ï¼Œå¯èƒ½åˆ†è¡¨ä¸åˆ†åº“ï¼Œä¹Ÿå¯èƒ½åˆ†åº“åˆ†è¡¨</p><h2 id="æ°´å¹³æ‹†åˆ†"><a class="markdownIt-Anchor" href="#æ°´å¹³æ‹†åˆ†"></a> æ°´å¹³æ‹†åˆ†</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868422759-e51f5bdc-93c6-440f-a222-05c6887ecae5.png#averageHue=%232b2b2b&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=205&amp;id=u47873811&amp;originHeight=315&amp;originWidth=474&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=uc57b09b7-9864-4bec-8f35-09d083847c8&amp;title=&amp;width=307.9829406738281" alt="" /></p><h2 id="å‚ç›´æ‹†åˆ†"><a class="markdownIt-Anchor" href="#å‚ç›´æ‹†åˆ†"></a> å‚ç›´æ‹†åˆ†</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868433798-1501e5cd-a545-4b25-853c-49563b05d3a8.png#averageHue=%233c3c3c&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=211&amp;id=ua3dd6804&amp;originHeight=267&amp;originWidth=320&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u59c074f1-2acd-4c02-96d7-b25044ba11a&amp;title=&amp;width=252.97726440429688" alt="" /></p><h1 id="æŠ€æœ¯è°ƒç ”"><a class="markdownIt-Anchor" href="#æŠ€æœ¯è°ƒç ”"></a> æŠ€æœ¯è°ƒç ”</h1><p>ç°æœ‰çš„åˆ†åº“åˆ†è¡¨ç»„ä»¶ä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ç§ï¼š</p><h2 id="åŸºäºä»£ç†"><a class="markdownIt-Anchor" href="#åŸºäºä»£ç†"></a> åŸºäºä»£ç†</h2><p>åœ¨åº”ç”¨å’Œæ•°æ®ä¸­é—´åŠ äº†ä¸€ä¸ªä»£ç†å±‚ã€‚åº”ç”¨ç¨‹åºæ‰€æœ‰çš„æ•°æ®è¯·æ±‚éƒ½äº¤ç»™ä»£ç†å±‚å¤„ç†ï¼Œä»£ç†å±‚è´Ÿè´£åˆ†ç¦»è¯»å†™è¯·æ±‚ï¼Œå°†å®ƒä»¬è·¯ç”±åˆ°å¯¹åº”çš„æ•°æ®åº“ä¸­ã€‚<br />æä¾›ç±»ä¼¼åŠŸèƒ½çš„ä¸­é—´ä»¶æœ‰ MySQL Routerï¼ˆå®˜æ–¹ï¼‰ã€Atlasï¼ˆåŸºäº MySQL Proxyï¼‰ã€MaxScaleã€MyCatã€‚</p><h2 id="åŸºäºç»„ä»¶"><a class="markdownIt-Anchor" href="#åŸºäºç»„ä»¶"></a> åŸºäºç»„ä»¶</h2><p>åŸºäºç»„ä»¶çš„åˆ™ç›´æ¥åŸºäºç‹¬ç«‹çš„ jar åŒ…å°±å¯ä»¥è¿›è¡Œå¼€å‘ï¼Œä¸ç”¨éƒ¨ç½²ï¼Œè¿ç»´æˆæœ¬ä½ï¼Œä¸éœ€è¦ä»£ç†å±‚çš„äºŒæ¬¡è½¬å‘è¯·æ±‚ï¼Œæ€§èƒ½å¾ˆé«˜**ã€‚**æ¯”è¾ƒç»å…¸çš„å°±æ˜¯ Sharding-JDBC</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868079770-2b0d126e-cb44-429b-8e9d-7093b035ec1b.png#averageHue=%23f5eae0&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=306&amp;id=ud054d93c&amp;originHeight=691&amp;originWidth=710&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=85260&amp;status=done&amp;style=none&amp;taskId=u6876318e-ac82-4ce8-ad7c-71dc104d055&amp;title=&amp;width=313.9829406738281" alt="image.png" /></p><h1 id="æ–¹æ¡ˆè®¾è®¡"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆè®¾è®¡"></a> æ–¹æ¡ˆè®¾è®¡</h1><p>ä¸»è¦æ€è€ƒç‚¹åœ¨äºï¼š</p><ul><li>å¦‚ä½•åœ¨ç»„ä»¶ä¸­å®ç°åŠ¨æ€æ•°æ®æºåˆ‡æ¢</li><li>å¦‚ä½•å®ç°æ¯”è¾ƒå‡åŒ€çš„è·¯ç”±æ•£åˆ—ç®—æ³•</li><li>å¦‚ä½•æ‹¦æˆªå¹¶ä¿®æ”¹ SQL</li></ul><h2 id="æ¶æ„å›¾"><a class="markdownIt-Anchor" href="#æ¶æ„å›¾"></a> æ¶æ„å›¾</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/29351684/1683870147946-a12a9368-e3fd-44ad-996b-b98af53f4474.jpeg" alt="" /></p><p>ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>AOP åˆ‡é¢æ‹¦æˆªï¼šæ‹¦æˆªéœ€è¦ä½¿ç”¨DB è·¯ç”±çš„æ–¹æ³•ï¼Œè¿™é‡Œé‡‡ç”¨è‡ªå®šä¹‰æ³¨è§£</li><li>æ•°æ®åº“è¿æ¥æ± é…ç½®ï¼šåˆ†åº“åˆ†è¡¨éœ€è¦æŒ‰éœ€é…ç½®æ•°æ®åº“è¿æ¥æºï¼Œåœ¨è¿™äº›è¿æ¥æ± çš„é›†åˆä¸­è¿›è¡Œ<strong>åŠ¨æ€æ•°æ®æºåˆ‡æ¢</strong></li><li><code>AbstractRoutingDataSource</code>ï¼šæ˜¯ç”¨äºåŠ¨æ€æ•°æ®æºåˆ‡æ¢çš„ Spring æœåŠ¡ç±»ï¼Œæä¾›äº†æ•°æ®æºåˆ‡æ¢çš„æŠ½è±¡æ–¹æ³• <code>determineCurrentLookupKey</code></li><li>è·¯ç”±å“ˆå¸Œç®—æ³•è®¾è®¡ï¼šåœ¨è·¯ç”±è®¾è®¡æ—¶ï¼Œéœ€è¦æ ¹æ®åˆ†åº“åˆ†è¡¨å­—æ®µè¿›è¡Œè·¯ç”±è®¡ç®—ï¼Œè®©æ•°æ®å‡åŒ€åœ°åˆ†å¸ƒè‡³å„ä¸ªåº“è¡¨ä¹‹ä¸­ã€‚è¿™é‡Œå‚è€ƒ HashMap çš„ æ‰°åŠ¨å‡½æ•°è®¾è®¡</li><li>MyBatis æ‹¦æˆªå™¨ï¼šå®ç° sql åŠ¨æ€æ‹¦æˆªå’Œä¿®æ”¹</li></ul><h1 id="æŠ€æœ¯å®ç°"><a class="markdownIt-Anchor" href="#æŠ€æœ¯å®ç°"></a> æŠ€æœ¯å®ç°</h1><h2 id="å·¥ç¨‹ç»“æ„"><a class="markdownIt-Anchor" href="#å·¥ç¨‹ç»“æ„"></a> å·¥ç¨‹ç»“æ„</h2><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">â”œâ”€srcâ”‚  â”œâ”€mainâ”‚  â”‚  â”œâ”€javaâ”‚  â”‚  â”‚  â””â”€cnâ”‚  â”‚  â”‚      â””â”€mokeeqianâ”‚  â”‚  â”‚          â””â”€middlewareâ”‚  â”‚  â”‚              â””â”€dbâ”‚  â”‚  â”‚                  â””â”€routerâ”‚  â”‚  â”‚                      â”œâ”€annotationâ”‚  â”‚  â”‚                      â”œâ”€configâ”‚  â”‚  â”‚                      â”œâ”€dynamicâ”‚  â”‚  â”‚                      â”œâ”€strategyâ”‚  â”‚  â”‚                      â”‚  â””â”€implâ”‚  â”‚  â”‚                      â””â”€utilâ”‚  â”‚  â””â”€resourcesâ”‚  â”‚      â””â”€META-INFâ”‚  â””â”€testâ”‚      â””â”€javaâ”‚          â””â”€cnâ”‚              â””â”€mokeeqianâ”‚                  â””â”€middlewareâ”‚                      â””â”€test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p><strong>ä»£ç ä»“åº“</strong></p><p><a href="https://github.com/mokeeqian/mokeeqian-spring-boot-starter/tree/main/db-router-spring-boot-starter">https://github.com/mokeeqian/mokeeqian-spring-boot-starter/tree/main/db-router-spring-boot-starter</a></p><h2 id="è‡ªå®šä¹‰è·¯ç”±æ³¨è§£"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰è·¯ç”±æ³¨è§£"></a> è‡ªå®šä¹‰è·¯ç”±æ³¨è§£</h2><p><strong>è·¯ç”±æ³¨è§£</strong><br />ä¸ºåˆ‡é¢æä¾›åˆ‡ç‚¹ï¼ŒåŒæ—¶è·å–è¢«æ³¨è§£çš„æ–¹æ³•å…¥å‚å±æ€§ä¸­çš„è·¯ç”±å­—æ®µ</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DBRouter</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * è·¯ç”±å­—æ®µ     * @return     */</span>    <span class="token class-name">String</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li>@Retentionï¼šå‘Šè¯‰ç¼–è¯‘ç¨‹åºå¦‚ä½•å¤„ç†ï¼Œä¹Ÿå¯ç†è§£ä¸ºæ³¨è§£ç±»çš„ç”Ÿå‘½å‘¨æœŸã€‚</li><li>@Targetï¼šè¯¥æ³¨è§£çš„ä½œç”¨ç‚¹ï¼Œä¸»è¦æœ‰ï¼šTYPEï¼ˆç±»ã€æ¥å£ï¼‰ã€METHODï¼ˆæ–¹æ³•ï¼‰ã€PACKAGEã€FIELDã€PARAMETERç­‰ã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½œç”¨åœ¨æ–¹æ³•ä¸Šã€‚</li></ul><p><strong>è·¯ç”±ç­–ç•¥æ³¨è§£</strong></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DBRouterStrategy</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * æ˜¯å¦åˆ†è¡¨     * @return     */</span>    <span class="token keyword">boolean</span> <span class="token function">splitTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="åŠ¨æ€æ•°æ®æºåˆ‡æ¢"><a class="markdownIt-Anchor" href="#åŠ¨æ€æ•°æ®æºåˆ‡æ¢"></a> ğŸ”ƒåŠ¨æ€æ•°æ®æºåˆ‡æ¢</h2><p>ç»§æ‰¿æŠ½è±¡ç±» <code>AbstractRoutingDataSource</code>ï¼Œå®ç°å…¶ <code>determineCurrentLookupKey</code> æ–¹æ³•ï¼Œä» DBContextHolderä¸­è·å– DB keyï¼Œç”¨ä»¥å®ç°åŠ¨æ€åˆ‡æ¢æ•°æ®æº</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicDataSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutingDataSource</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * è¿”å› db è·¯ç”±     * @return aka db01, db02, ...     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"db"</span> <span class="token operator">+</span> <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">getDbKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>AbstractRoutingDataSourceçš„getConnection() â½…æ³•æ ¹æ®æŸ¥æ‰¾ lookup key é”®å¯¹ä¸åŒâ½¬æ ‡æ•°æ®æºçš„è°ƒâ½¤ï¼Œ é€šå¸¸æ˜¯é€šè¿‡(ä½†ä¸â¼€å®š)æŸäº›çº¿ç¨‹ç»‘å®šçš„äº‹ç‰©ä¸Šä¸‹â½‚æ¥å®ç°<br />AbstractRoutingDataSourceçš„å¤šæ•°æ®æºåŠ¨æ€ åˆ‡æ¢çš„æ ¸â¼¼é€»è¾‘æ˜¯ï¼šåœ¨ç¨‹åºè¿â¾æ—¶ï¼ŒæŠŠæ•°æ®æºæ•°æ®æºé€šè¿‡AbstractRoutingDataSource åŠ¨æ€ç»‡â¼Šåˆ°ç¨‹åº ä¸­ï¼Œçµæ´»çš„è¿›â¾æ•°æ®æºåˆ‡æ¢<br />åŸºäºAbstractRoutingDataSourceçš„å¤šæ•°æ®æºåŠ¨æ€åˆ‡æ¢ï¼Œå¯ä»¥å®ç°è¯»å†™åˆ†ç¦»ï¼Œè¿™ä¹ˆåšç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œâ½†æ³• åŠ¨æ€çš„å¢åŠ æ•°æ®æº</p><h2 id="ï¸é…ç½®-åŠ è½½-åˆ›å»ºæ•°æ®æº"><a class="markdownIt-Anchor" href="#ï¸é…ç½®-åŠ è½½-åˆ›å»ºæ•°æ®æº"></a> âš™ï¸é…ç½®ã€åŠ è½½ã€åˆ›å»ºæ•°æ®æº</h2><p>å¯¹äºè¾ƒå¤æ‚çš„æ•°æ®æºé…ç½®ï¼Œä¸€èˆ¬ä½¿ç”¨ <code>org.springframework.context.EnvironmentAware</code>æ¥å®ç°ï¼š<br /><strong>EnvironmentAware#setEnvironmentï¼šè¯»å– yml é…ç½®æ–‡ä»¶ä¸­çš„è‡ªå®šä¹‰åˆ†åº“åˆ†è¡¨é…ç½®</strong></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> prefix <span class="token operator">=</span> <span class="token string">"mini-db-router.jdbc.datasource."</span><span class="token punctuation">;</span>dbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"dbCount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>tbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"tbCount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>routerKey <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"routerKey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åˆ†åº“åˆ—è¡¨ db01,db02</span><span class="token class-name">String</span> dataSources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">assert</span> dataSources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSources<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> dataSourceProps <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> dbInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> dataSourceProps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// é»˜è®¤æ•°æ®æº</span><span class="token class-name">String</span> defaultData <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>defaultDataSourceConfig <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> defaultData<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">router</span><span class="token punctuation">:</span>  <span class="token key atrule">jdbc</span><span class="token punctuation">:</span>    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token comment"># ä»è¿™é‡Œå¼€å§‹å°±æ˜¯æ•°æ®æºçš„é…ç½®äº†</span>      <span class="token key atrule">dbCount</span><span class="token punctuation">:</span> <span class="token number">2</span>      <span class="token key atrule">tbCount</span><span class="token punctuation">:</span> <span class="token number">4</span>      <span class="token key atrule">default</span><span class="token punctuation">:</span> db00      <span class="token key atrule">routerKey</span><span class="token punctuation">:</span> uId<span class="token comment"># è·¯ç”±å­—æ®µ</span>      <span class="token key atrule">list</span><span class="token punctuation">:</span> db01<span class="token punctuation">,</span>db02 <span class="token comment"># åˆ†åº“</span>      <span class="token key atrule">db00</span><span class="token punctuation">:</span>        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/lottery<span class="token punctuation">?</span>useUnicode=true        <span class="token key atrule">username</span><span class="token punctuation">:</span> root        <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx      <span class="token key atrule">db01</span><span class="token punctuation">:</span>        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/lottery_01<span class="token punctuation">?</span>useUnicode=true        <span class="token key atrule">username</span><span class="token punctuation">:</span> root        <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx      <span class="token key atrule">db02</span><span class="token punctuation">:</span>        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/lottery_02<span class="token punctuation">?</span>useUnicode=true        <span class="token key atrule">username</span><span class="token punctuation">:</span> root        <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p><strong>åˆ›å»ºæ•°æ®æºï¼šDynamicDataSource#setTargetDataSourcesï¼ŒDynamicDataSource#setDefaultTargetDataSource</strong></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// åˆ›å»ºæ•°æ®æº</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> targetDataSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> objMap <span class="token operator">=</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// è®¾ç½®æ•°æ®æº</span><span class="token class-name">DynamicDataSource</span> dynamicDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>dynamicDataSource<span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">)</span><span class="token punctuation">;</span>dynamicDataSource<span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> dynamicDataSource<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="threadlocal-ä¿å­˜è·¯ç”±ç»“æœ"><a class="markdownIt-Anchor" href="#threadlocal-ä¿å­˜è·¯ç”±ç»“æœ"></a> ThreadLocal ä¿å­˜è·¯ç”±ç»“æœ</h2><p>ä½¿ç”¨ ThreadLocal ä¿å­˜åˆ†åº“ã€åˆ†è¡¨çš„è·¯ç”±ç»“æœï¼Œå€Ÿé‰´ SecurityContextHolder</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DBContextHolder</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dbKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> tbKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getDBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> dbKey<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getTBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> tbKey<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setDBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbKeyIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        dbKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dbKeyIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setTBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> tbKeyIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        tbKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tbKeyIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clearDBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        dbKey<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clearTBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        tbKey<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="å…·ä½“è·¯ç”±ç­–ç•¥"><a class="markdownIt-Anchor" href="#å…·ä½“è·¯ç”±ç­–ç•¥"></a> å…·ä½“è·¯ç”±ç­–ç•¥</h2><p>è¿™é‡Œé‡‡ç”¨æ¥å£ <code>IDBRouterStrategy</code> ï¼Œåç»­å¯ä»¥å®ç°è¯¥æ¥å£ï¼Œè¿›è¡Œä¸ªæ€§åŒ–çš„è·¯ç”±ç­–ç•¥é…ç½®</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683910558463-7c96f9a7-ef81-4557-8c1e-656846b3bf7d.png" alt="image.png" /></p><p><strong>åŸºäºHashMap æ‰°åŠ¨å‡½æ•°æ€æƒ³å®ç°è·¯ç”±åˆ†å‘</strong></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbKeyAttr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> size <span class="token operator">=</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getDbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ‰°åŠ¨å‡½æ•°ï¼›åœ¨ JDK çš„ HashMap ä¸­ï¼Œå¯¹äºä¸€ä¸ªå…ƒç´ çš„å­˜æ”¾ï¼Œéœ€è¦è¿›è¡Œå“ˆå¸Œæ•£åˆ—ã€‚è€Œä¸ºäº†è®©æ•£åˆ—æ›´åŠ å‡åŒ€ï¼Œæ‰€ä»¥æ·»åŠ äº†æ‰°åŠ¨å‡½æ•°ã€‚</span><span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åº“è¡¨ç´¢å¼•ï¼›ç›¸å½“äºæ˜¯æŠŠä¸€ä¸ªé•¿æ¡çš„æ¡¶ï¼Œåˆ‡å‰²æˆæ®µï¼Œå¯¹åº”åˆ†åº“åˆ†è¡¨ä¸­çš„åº“ç¼–å·å’Œè¡¨ç¼–å·</span><span class="token keyword">int</span> dbIdx <span class="token operator">=</span> idx <span class="token operator">/</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">int</span> tbIdx <span class="token operator">=</span> idx <span class="token operator">-</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>dbIdx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è®¾ç½®åˆ° ThreadLocal</span><span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">setDBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%02d"</span><span class="token punctuation">,</span> dbIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">setTBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%03d"</span><span class="token punctuation">,</span> tbIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"æ•°æ®åº“è·¯ç”± dbIdxï¼š&#123;&#125; tbIdxï¼š&#123;&#125;"</span><span class="token punctuation">,</span>  dbIdx<span class="token punctuation">,</span> tbIdx<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="åŠ¨æ€-sql-ä¿®æ”¹"><a class="markdownIt-Anchor" href="#åŠ¨æ€-sql-ä¿®æ”¹"></a> âœ…åŠ¨æ€ SQL ä¿®æ”¹</h2><p>åŸºäºä»¥ä¸Šï¼Œåˆ†åº“åŠŸèƒ½å·²ç»å®ç°ï¼Œä½†æ˜¯ï¼Œå¦‚ä½•åˆ†è¡¨ï¼Ÿå³å°†<strong>é€»è¾‘ SQL</strong> è½¬åŒ–ä¸º <strong>ç‰©ç† SQLï¼Œ</strong> ä¾‹å¦‚ï¼š</p><p>é€»è¾‘SQLï¼š<code>SELECT * FROM tb_user WHERE id = 123;</code></p><p>ç‰©ç†SQLï¼š<code>SELECT * FROM tb_user_01 WHERE id = 123;</code></p><p><strong>ä¸€ç§æ€è·¯æ˜¯ï¼šä½¿ç”¨ MyBatis çš„ Interceptor è¿›è¡Œ SQL æ‹¦æˆªï¼Œç„¶ååŠ¨æ€ä¿®æ”¹ SQL</strong></p><ul><li>@Interceptsæ³¨è§£ï¼šæ‹¦æˆªå™¨<br />å¯ä»¥è¢«æ‹¦æˆªçš„å››ç§ç±»å‹ï¼š<ul><li>Executorï¼šæ‹¦æˆªæ‰§è¡Œå™¨çš„æ–¹æ³•</li><li>ParameterHandlerï¼šæ‹¦æˆªå‚æ•°çš„å¤„ç†</li><li>ResultHandlerï¼šæ‹¦æˆªç»“æœé›†çš„å¤„ç†</li><li><em>StatementHandlerï¼šæ‹¦æˆªSqlè¯­æ³•æ„å»ºçš„å¤„ç†</em></li></ul></li><li>@Signatureæ³¨è§£ï¼šæ‹¦æˆªç‚¹ï¼ŒæŒ‡å®šæ‹¦æˆªå“ªä¸ªå¯¹è±¡é‡Œé¢çš„å“ªä¸ªæ–¹æ³•<br />å…¶å‚æ•°å¦‚ä¸‹ï¼š<ul><li>typeï¼šè¦è¢«æ‹¦æˆªçš„ç±»å‹ï¼ˆä¸Šè¿°å››ç§ä¹‹ä¸€ï¼‰</li><li>methodï¼šåœ¨ç±»å‹åŸºç¡€ä¸Šï¼ŒæŒ‡å®šè¢«æ‹¦æˆªçš„æ–¹æ³•</li><li>argsï¼šåœ¨æ–¹æ³•åŸºç¡€ä¸Šï¼ŒæŒ‡å®šæ–¹æ³•å…¥å‚å‚æ•°ï¼ˆJavaé‡Œå¯èƒ½å­˜åœ¨é‡è½½ï¼Œæ•…è¦æ³¨æ„å‚æ•°é¡ºåºå’Œç±»å‹ï¼‰</li></ul></li><li>ç±»å‹&amp;æ–¹æ³•ä¸€è§ˆ</li></ul><table><thead><tr><th>æ‹¦æˆªç±»å‹</th><th>æ‹¦æˆªæ–¹æ³•</th></tr></thead><tbody><tr><td>Executor</td><td>updateã€queryã€flushStatementsã€commitã€rollbackã€getTransactionã€closeã€isClosed</td></tr><tr><td>ParameterHandler</td><td>getParameterObjectã€setParameters</td></tr><tr><td>ResultHandler</td><td>handleResultSetsã€handleOutputParameters</td></tr><tr><td>StatementHandler</td><td>prepareã€parameterizeã€batchã€updateã€query</td></tr></tbody></table><p>StatementHandler çš„å…·ä½“æ–¹æ³•ï¼š</p><ul><li>prepare: â½¤äºåˆ›å»ºâ¼€ä¸ªå…·ä½“çš„ Statement å¯¹è±¡çš„å®ç°ç±»æˆ–è€…æ˜¯ Statement å¯¹è±¡</li><li>parametersize: â½¤äºåˆå§‹åŒ– Statement å¯¹è±¡ä»¥åŠå¯¹sqlçš„å ä½ç¬¦è¿›â¾èµ‹å€¼</li><li>update: â½¤äºé€šçŸ¥ Statement å¯¹è±¡å°† insertã€updateã€delete æ“ä½œæ¨é€åˆ°æ•°æ®åº“</li><li>query: â½¤äºé€šçŸ¥ Statement å¯¹è±¡å°† select æ“ä½œæ¨é€æ•°æ®åº“å¹¶è¿”å›å¯¹åº”çš„æŸ¥è¯¢ç»“æœ</li></ul><p>æˆ‘ä»¬ä¸»è¦ä½¿ç”¨ StatementHandler çš„ prepare æ–¹æ³•ï¼Œæ‹¦æˆª sql è¯­å¥</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span>        <span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">StatementHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"prepare"</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div><p><em>è¿™é‡Œçš„ Interceptor#intercept æ–¹æ³•å°±æ˜¯æˆ‘ä»¬è¦å®ç°çš„æ–¹æ³•ï¼Œå…¶ä¸­ï¼Œinvocation å°±æ˜¯è¢«æ‹¦æˆªçš„å¯¹è±¡ï¼ˆStatementHandler#prepareæ–¹æ³•ï¼‰</em></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * @author Clinton Begin */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>  <span class="token keyword">default</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// NOP</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p><strong>å¦‚ä½•è·å– MyBatis ä¸­çš„ SQL è¯­å¥ï¼Ÿ</strong><br />åŸºäº <code>StatementHandler</code>ï¼Œç„¶å è·å–å…¶ BoundSql</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// è·å– StatementHandler</span><span class="token class-name">StatementHandler</span> statementHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatementHandler</span><span class="token punctuation">)</span> invocation<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">MetaObject</span> metaObject <span class="token operator">=</span> <span class="token class-name">MetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>statementHandler<span class="token punctuation">,</span> <span class="token class-name">SystemMetaObject</span><span class="token punctuation">.</span>DEFAULT_OBJECT_FACTORY<span class="token punctuation">,</span><span class="token class-name">SystemMetaObject</span><span class="token punctuation">.</span>DEFAULT_OBJECT_WRAPPER_FACTORY<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">MappedStatement</span> mappedStatement <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MappedStatement</span><span class="token punctuation">)</span> metaObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"delegate.mappedStatement"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è·å– MyBatis åŸå§‹ SQL</span><span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> statementHandler<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> originalSql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p><strong>å¦‚ä½•è¯†åˆ« SQL ä¸­çš„è¡¨åç§°ï¼Ÿ</strong><br />ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼šfromï¼Œintoï¼Œupdate è¿™ä¸‰ä¸ªå…³é”®å­—ï¼Œå…¶ä¹‹åå°±æ˜¯è¡¨åç§°</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Pattern</span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"(from|into|update)[\\s]&#123;1,&#125;(\\w&#123;1,&#125;)"</span><span class="token punctuation">,</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span>CASE_INSENSITIVE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p><strong>è¯†åˆ«ä¹‹åå¦‚ä½•æ›¿æ¢ï¼Ÿ</strong><br />ä½¿ç”¨åå°„ï¼Œç›´æ¥ä¿®æ”¹ <code>BoundSql#sql</code> å­—æ®µ</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// é€šè¿‡åå°„ä¿®æ”¹ sql è¯­å¥</span><span class="token comment">// getDeclaredFieldï¼šå¯ä»¥è·å–æ‰€æœ‰å·²å£°æ˜å­—æ®µï¼ˆæ— è§†è®¿é—®é™å®šç¬¦ï¼‰; getFieldï¼šåªèƒ½è·å–public å­—æ®µ</span><span class="token class-name">Field</span> field <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">,</span> replacedSql<span class="token punctuation">)</span><span class="token punctuation">;</span>field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li>ä½¿ç”¨åå°„å¯ä»¥è®¿é—® Java ç±»çš„ç§æœ‰æˆå‘˜ã€ç§æœ‰æ–¹æ³•ã€‚åœ¨æ¡†æ¶å¼€å‘ä¸­ï¼Œç”¨å¤„ååˆ†å¹¿æ³›</li></ul><h2 id="aop-å®ç°è°ƒç”¨æ–¹æ³•æ‹¦æˆª"><a class="markdownIt-Anchor" href="#aop-å®ç°è°ƒç”¨æ–¹æ³•æ‹¦æˆª"></a> ğŸš«AOP å®ç°è°ƒç”¨æ–¹æ³•æ‹¦æˆª</h2><p>ç›®å‰ä¸ºæ­¢ï¼Œåº•å±‚é€»è¾‘å·²ç»å…¨éƒ¨å®ç°ï¼Œç°åœ¨åªéœ€è¦ä½¿ç”¨AOPå¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œæ‹¦æˆªå¤„ç†å³å¯<br /><strong>å®šä¹‰åˆ‡ç‚¹</strong><br />è¿™é‡Œç›´æ¥æ‹¦æˆªå…ˆå‰å®šä¹‰çš„è‡ªå®šä¹‰æ³¨è§£ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨è¡¨è¾¾å¼åŒ¹é…</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * åˆ‡ç‚¹ */</span><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"@annotation(cn.mokeeqian.middleware.db.router.annotation.DBRouter)"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aopPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p><strong>å®šä¹‰åˆ‡é¢æ‹¦æˆªå…·ä½“é€»è¾‘</strong></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * åˆ‡é¢æ‹¦æˆªåçš„å…·ä½“æ“ä½œ * @param proceedingJoinPoint * @param dbRouter * @return * @throws Throwable */</span><span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"aopPoint() &amp;&amp; @annotation(dbRouter)"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> proceedingJoinPoint<span class="token punctuation">,</span> <span class="token class-name">DBRouter</span> dbRouter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> dbKey <span class="token operator">=</span> dbRouter<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">.</span><span class="token function">getRouterKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"annotation DBRouter key is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœæ³¨è§£ä¸­æ²¡é…ç½® keyï¼Œåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶çš„ key</span>dbKey <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">)</span> <span class="token operator">?</span> dbKey <span class="token operator">:</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getRouterKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è®¡ç®—è·¯ç”±</span><span class="token class-name">String</span> dbKeyAttr <span class="token operator">=</span> <span class="token function">getAttrValue</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">,</span> proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è·¯ç”±åˆ†å‘</span>dbRouterStrategy<span class="token punctuation">.</span><span class="token function">doRouter</span><span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è¿”å›ç»“æœ</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ”¾è¡Œ</span><span class="token keyword">return</span> proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ¸…é™¤ ThreadLocal</span>dbRouterStrategy<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li>å‡ ç§åˆ‡é¢ç¯ç»•é€»è¾‘ï¼š<ul><li>@Beforeï¼šå‰ç½®é€šçŸ¥ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œ</li><li>@Afterï¼šåç½®é€šçŸ¥ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œï¼ˆå³ä½¿å‡ºç°å¼‚å¸¸ï¼Œåç½®é€šçŸ¥ä¹Ÿä¼šæ‰§è¡Œï¼‰</li><li>@Aroundï¼šç¯ç»•é€šçŸ¥ï¼Œå›´ç»•ç€æ–¹æ³•æ‰§è¡Œï¼ˆå¯ä»¥å®ç°å…¶ä»–å››ç§é€šçŸ¥ï¼‰</li><li>@AfterReturningï¼šè¿”å›é€šçŸ¥ï¼Œåœ¨æ–¹æ³•è¿”å›ç»“æœä¹‹åæ‰§è¡Œ</li><li>@AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥ï¼Œåœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ä¹‹å</li></ul></li><li>AspectJ æ³¨è§£çš„æ‰§è¡Œé¡ºåºï¼š<br /><em>@Around éƒ½ä¼šå‡ºç°ä¸¤æ¬¡ï¼š@Beforeã€@AfterReturningã€@AfterReturningã€@After è¿™å››ä¸ªéƒ½ä¼šåœ¨ä¸¤æ¬¡@Around æ‰§è¡Œä¹‹é—´è¢«æ‰§è¡Œ</em><ul><li>æ— å¼‚å¸¸æ—¶ï¼š@Aspectã€@Pointcutã€@Aroundã€@Beforeã€@AfterReturningã€@Afterã€@Around</li><li>æœ‰å¼‚å¸¸æ—¶ï¼š@Aspectã€@Pointcutã€@Aroundã€@Beforeã€@AfterThrowingã€@Afterã€@Around</li></ul></li><li><code>@Around(&quot;aopPoint() &amp;&amp; @annotation(dbRouter)&quot;)</code>çš„ç†è§£</li></ul><h2 id="å°è£…èµ·æ­¥ä¾èµ–"><a class="markdownIt-Anchor" href="#å°è£…èµ·æ­¥ä¾èµ–"></a> å°è£…èµ·æ­¥ä¾èµ–</h2><p>æœ€åçš„æœ€åï¼Œå°†é¡¹ç›®å°è£…æˆ SpringBoot èµ·æ­¥ä¾èµ–ï¼Œç¼–å†™é…ç½®ç±»ï¼Œç„¶ååˆ©ç”¨è‡ªåŠ¨è£…é…æœºåˆ¶ã€‚</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceAutoConfigure</span> <span class="token keyword">implements</span> <span class="token class-name">EnvironmentAware</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * æ•°æ®æºé…ç½®ç»„     */</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> dataSourceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * é»˜è®¤æ•°æ®æºé…ç½®     * ä¹Ÿå°±æ˜¯ï¼šä¸èµ°è·¯ç”±ç»„ä»¶çš„æ•°æ®æº     */</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> defaultDataSourceConfig<span class="token punctuation">;</span>    <span class="token comment">/**     * åˆ†åº“æ•°ç›®     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> dbCount<span class="token punctuation">;</span>    <span class="token comment">/**     * åˆ†è¡¨æ•°ç›®     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> tbCount<span class="token punctuation">;</span>    <span class="token comment">/**     * è·¯ç”±å­—æ®µ     */</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> routerKey<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">IDBRouterStrategy</span> <span class="token function">doRouterStrategy</span><span class="token punctuation">(</span><span class="token class-name">DBRouterConfig</span> dbRouterConfig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterStrategyHashCode</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">DBRouterConfig</span> <span class="token function">dbRouterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dbCount<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tbCount<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>routerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Interceptor</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DynamicMybatisPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"db-router-point"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>    <span class="token keyword">public</span> <span class="token class-name">DBRouterJoinPoint</span> <span class="token function">dbRouterJoinPoint</span><span class="token punctuation">(</span><span class="token class-name">DBRouterConfig</span> dbRouterConfig<span class="token punctuation">,</span> <span class="token class-name">IDBRouterStrategy</span> dbRouterStrategy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterJoinPoint</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">,</span> dbRouterStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * åˆ›å»ºåŠ¨æ€æ•°æ®æº     * è¿™ä¸ªæ•°æ®æºå°±ä¼šè¢« MyBatis SpringBoot Starter ä¸­ SqlSessionFactory sqlSessionFactory(DataSource dataSource) æ³¨å…¥ä½¿ç”¨     * @return     */</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// åˆ›å»ºæ•°æ®æº</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> targetDataSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> objMap <span class="token operator">=</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>            targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>                    objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// è®¾ç½®æ•°æ®æº</span>        <span class="token class-name">DynamicDataSource</span> dynamicDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dynamicDataSource<span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">)</span><span class="token punctuation">;</span>        dynamicDataSource<span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> dynamicDataSource<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">TransactionTemplate</span> <span class="token function">transactionTemplate</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">DataSourceTransactionManager</span> dataSourceTransactionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataSourceTransactionManager<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TransactionTemplate</span> transactionTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        transactionTemplate<span class="token punctuation">.</span><span class="token function">setTransactionManager</span><span class="token punctuation">(</span>dataSourceTransactionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>        transactionTemplate<span class="token punctuation">.</span><span class="token function">setPropagationBehaviorName</span><span class="token punctuation">(</span><span class="token string">"PROPAGATION_REQUIRED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> transactionTemplate<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * è¯»å– yml ä¸­è‡ªå®šä¹‰çš„é…ç½®     * @param environment     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> prefix <span class="token operator">=</span> <span class="token string">"mini-db-router.jdbc.datasource."</span><span class="token punctuation">;</span>        dbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"dbCount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"tbCount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        routerKey <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"routerKey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// åˆ†åº“åˆ—è¡¨ db01,db02</span>        <span class="token class-name">String</span> dataSources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">assert</span> dataSources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSources<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> dataSourceProps <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> dbInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> dataSourceProps<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// é»˜è®¤æ•°æ®æº</span>        <span class="token class-name">String</span> defaultData <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        defaultDataSourceConfig <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> defaultData<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>éšåï¼Œéœ€è¦ç¼–å†™ <code>resources/META_INF/spring.factories</code> æ–‡ä»¶ï¼Œé…ç½®æ•°æ®æºé…ç½®ç±»</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span>EnableAutoConfiguration</span><span class="token operator">=</span><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>mokeeqian<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>db<span class="token punctuation">.</span>router<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>DataSourceAutoConfigure</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>æœ€åï¼Œå°†é¡¹ç›®æ‰“åŒ…åˆ° maven ä»“åº“ï¼Œå³å¯ä½¿ç”¨å•¦</p><h1 id="ç•ªå¤–åˆ†åº“åˆ†è¡¨å¹³æ»‘è¿‡æ¸¡"><a class="markdownIt-Anchor" href="#ç•ªå¤–åˆ†åº“åˆ†è¡¨å¹³æ»‘è¿‡æ¸¡"></a> ã€ç•ªå¤–ã€‘åˆ†åº“åˆ†è¡¨å¹³æ»‘è¿‡æ¸¡ï¼Ÿ</h1><p>åŸºäºåŸå…ˆçš„å•åº“å•è¡¨ï¼Œç°åœ¨å¦‚ä½•åšè¿ç§»ï¼Ÿ</p><h2 id="åœæœºè¿ç§»"><a class="markdownIt-Anchor" href="#åœæœºè¿ç§»"></a> åœæœºè¿ç§»</h2><p>æœ€ç®€å•çš„å°±æ˜¯ç›´æ¥åœæœºè¿ç§»ï¼Œåœæ­¢ä¸€åˆ‡å†™å…¥ã€‚ç„¶åå°†æ—§åº“æ•°æ®è¿ç§»è‡³æ–°åº“ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868674064-09a7741f-ef77-43c6-ba21-843a140c7384.png#averageHue=%231f1f1f&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=459&amp;id=ub1fd1528&amp;originHeight=636&amp;originWidth=863&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=ub8f1269e-c99f-4440-9ba6-e73f329dafe&amp;title=&amp;width=622.1760864257812" alt="" /></p><h2 id="åŒå†™è¿ç§»"><a class="markdownIt-Anchor" href="#åŒå†™è¿ç§»"></a> åŒå†™è¿ç§»</h2><p>å¦‚æœçº¿ä¸Šä¸šåŠ¡ä¸èƒ½åœæœºæ€ä¹ˆåŠï¼Ÿ</p><ul><li>æˆ‘ä»¬å¯¹è€åº“çš„æ›´æ–°æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰ï¼ŒåŒæ—¶ä¹Ÿè¦å†™å…¥æ–°åº“ï¼ˆåŒå†™ï¼‰ã€‚å¦‚æœæ“ä½œçš„æ•°æ®ä¸å­˜åœ¨äºæ–°åº“çš„è¯ï¼Œéœ€è¦æ’å…¥åˆ°æ–°åº“ä¸­ã€‚ è¿™æ ·å°±èƒ½ä¿è¯ï¼Œå’±ä»¬æ–°åº“é‡Œçš„æ•°æ®æ˜¯æœ€æ–°çš„ã€‚</li><li>åœ¨è¿ç§»è¿‡ç¨‹ï¼ŒåŒå†™åªä¼šè®©è¢«æ›´æ–°æ“ä½œè¿‡çš„è€åº“ä¸­çš„æ•°æ®åŒæ­¥åˆ°æ–°åº“ï¼Œæˆ‘ä»¬_è¿˜éœ€è¦è‡ªå·±å†™è„šæœ¬å°†è€åº“ä¸­çš„æ•°æ®å’Œæ–°åº“çš„æ•°æ®åšæ¯”å¯¹_ã€‚å¦‚æœæ–°åº“ä¸­æ²¡æœ‰ï¼Œé‚£å’±ä»¬å°±æŠŠæ•°æ®æ’å…¥åˆ°æ–°åº“ã€‚å¦‚æœæ–°åº“æœ‰ï¼Œæ—§åº“æ²¡æœ‰ï¼Œå°±æŠŠæ–°åº“å¯¹åº”çš„æ•°æ®åˆ é™¤ï¼ˆå†—ä½™æ•°æ®æ¸…ç†ï¼‰ã€‚</li><li>é‡å¤ä¸Šä¸€æ­¥çš„æ“ä½œï¼Œç›´åˆ°è€åº“å’Œæ–°åº“çš„æ•°æ®ä¸€è‡´ä¸ºæ­¢</li></ul><p>è¿™å—å…¶å®å¯ä»¥å€ŸåŠ© Canal ç­‰ä¸­é—´ä»¶ï¼ˆbinlogä¸»ä»åŒæ­¥åŸç†ï¼‰æ¥å®ç°<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868776523-d993586d-94a9-4285-afac-2e8100de0524.png#averageHue=%231e1e1e&amp;clientId=u5534c067-c81b-4&amp;from=paste&amp;height=490&amp;id=u781d7428&amp;originHeight=661&amp;originWidth=864&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=ud24719c9-abcb-4983-a0c0-7f505cce0d5&amp;title=&amp;width=640.1760864257812" alt="" /></p>]]></content>
    
    
    <categories>
      
      <category>ä¸­é—´ä»¶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL</tag>
      
      <tag>MyBatis</tag>
      
      <tag>ThreadLocal</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å›¾è®ºæœç´¢æ¨¡æ¿</title>
    <link href="/2022/12/20/%E5%9B%BE%E8%AE%BA%E6%90%9C%E7%B4%A2%E6%A8%A1%E6%9D%BF/"/>
    <url>/2022/12/20/%E5%9B%BE%E8%AE%BA%E6%90%9C%E7%B4%A2%E6%A8%A1%E6%9D%BF/</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h1 id="0-å‰è¨€"><a class="markdownIt-Anchor" href="#0-å‰è¨€"></a> 0. å‰è¨€</h1><p>ä¸€ç›´ä»¥æ¥ï¼Œå›¾è®ºç›¸å…³çš„ç®—æ³•æŒæ¡å°±ä¸æ˜¯å¾ˆå¥½ï¼Œç”šè‡³äºï¼Œä½•æ—¶è¯¥ç”¨DFSï¼Œä½•æ—¶è¯¥ç”¨BFSæœ‰æ—¶éƒ½åˆ†ä¸æ¸…ã€‚ç¢°å·§æœ€è¿‘åœ¨åˆ·å›¾è®ºç›¸å…³çš„ä¸“é¢˜ï¼Œå½“ç„¶ä½œä¸ºéç§‘ç­é€‰æ‰‹ï¼ŒæŒæ¡åŸºç¡€çš„DFSã€BFSã€æœ€çŸ­è·¯ã€è¿é€šå—ç­‰çŸ¥è¯†ï¼Œåº”ä»˜é¢è¯•åº”è¯¥æ˜¯å¤Ÿäº†ã€‚</p><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæœ‰å¿…è¦è¯´ä¸€ä¸‹DFSå…¶å®æ˜¯æœ‰ä¸¤ç§åº”ç”¨åœºæ™¯çš„ï¼š</p><ul><li>æœç´¢ï¼šæ­¤æœç´¢ä¸€èˆ¬æ˜¯ç”¨äºæš´åŠ›é€’å½’æœç´¢è§£ç©ºé—´ï¼Œå¾—åˆ°æ‰€æœ‰çš„å¯è¡Œè§£ï¼ˆä¾‹å¦‚å›æº¯ï¼‰</li><li>å›¾è®ºï¼šåœ¨å›¾çš„åœºæ™¯ä¸‹ï¼Œæ˜¯å¯¹å›¾çš„éå†</li></ul><h2 id="dfsæš´åŠ›æœç´¢"><a class="markdownIt-Anchor" href="#dfsæš´åŠ›æœç´¢"></a> DFSæš´åŠ›æœç´¢</h2><p>é¡ºä¾¿è®°å½•ä¸€ä¸‹DFSæš´æœçš„è¿‡ç¨‹å§ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å›æº¯ï¼Œæ¨¡æ¿å¦‚ä¸‹ï¼š</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Gao</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// æœ€ç»ˆç­”æ¡ˆ</span>    <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ä¸­é—´ç­”æ¡ˆ</span>    <span class="token keyword">void</span> <span class="token function">gao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">back_trace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> æ¡ä»¶æ»¡è¶³ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// æšä¸¾æ‰€æœ‰å¯èƒ½çš„æƒ…å†µ</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> x in valids <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            path<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// åŠ å…¥ç­”æ¡ˆ</span>            <span class="token function">back_trace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// é€’å½’æœç´¢</span>            path<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// æ’¤é”€</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>æœ€ç»å…¸çš„é—®é¢˜ï¼Œä¾‹å¦‚æ’åˆ—é—®é¢˜ã€ç»„åˆé—®é¢˜ã€Nçš‡åé—®é¢˜ç­‰ã€‚<br />ä¾‹å¦‚ï¼š</p><p>LC797. æ‰€æœ‰å¯èƒ½çš„è·¯å¾„</p><blockquote><p>ç»™ä½ ä¸€ä¸ªæœ‰Â nÂ ä¸ªèŠ‚ç‚¹çš„ æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ï¼Œè¯·ä½ æ‰¾å‡ºæ‰€æœ‰ä»èŠ‚ç‚¹ 0Â åˆ°èŠ‚ç‚¹ n-1Â çš„è·¯å¾„å¹¶è¾“å‡ºï¼ˆä¸è¦æ±‚æŒ‰ç‰¹å®šé¡ºåºï¼‰ã€‚</p><p>graph[i]Â æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ i å¯ä»¥è®¿é—®çš„æ‰€æœ‰èŠ‚ç‚¹çš„åˆ—è¡¨ï¼ˆå³ä»èŠ‚ç‚¹ i åˆ°èŠ‚ç‚¹Â graph[i][j]å­˜åœ¨ä¸€æ¡æœ‰å‘è¾¹ï¼‰ã€‚</p><p>æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰<br />é“¾æ¥ï¼š<a href="https://leetcode.cn/problems/all-paths-from-source-to-target">https://leetcode.cn/problems/all-paths-from-source-to-target</a><br />è‘—ä½œæƒå½’é¢†æ‰£ç½‘ç»œæ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»å®˜æ–¹æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Solution</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">allPathsSourceTarget</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> graph<span class="token punctuation">:</span> List<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>        res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        n <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span>        <span class="token comment"># x: å½“å‰å¤„ç†åˆ°çš„èŠ‚ç‚¹</span>        <span class="token keyword">def</span> <span class="token function">back_trace</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> x <span class="token operator">==</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>                res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token keyword">return</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>graph<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>graph<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>                back_trace<span class="token punctuation">(</span>graph<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>                path<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        back_trace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> res<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h1 id="1-äºŒç»´ç½‘æ ¼é—®é¢˜"><a class="markdownIt-Anchor" href="#1-äºŒç»´ç½‘æ ¼é—®é¢˜"></a> 1. äºŒç»´ç½‘æ ¼é—®é¢˜</h1><p>äºŒç»´ç½‘æ ¼é—®é¢˜æ˜¯ä¸€ç±»ç‰¹æ®Šçš„å›¾è®ºé—®é¢˜ã€‚åŸºäºä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œå…¶ä¸­ï¼Œå•å…ƒæ ¼å¯çœ‹ä½œæ˜¯nodeï¼Œä¸å•å…ƒæ ¼ä¸Šä¸‹å·¦å³ç›¸é‚»çš„å•å…ƒæ ¼å¯çœ‹ä½œæ˜¯å…¶é‚»å±…nodeï¼Œä¸Šä¸‹å·¦å³å…³ç³»å¯çœ‹ä½œæ˜¯edgeã€‚</p><h2 id="ä¸€äº›trick"><a class="markdownIt-Anchor" href="#ä¸€äº›trick"></a> ä¸€äº›trick</h2><ul><li>dir æ•°ç»„æ§åˆ¶æ–¹å‘æµè½¬</li><li>æœ‰æ—¶åˆå§‹çš„ grid æ•°ç»„å¯ä»¥åŸåœ°ä¿®æ”¹ï¼Œä½œä¸º vis æ ‡è®°å’Œç­”æ¡ˆè®°å½•</li><li>BFS ä¸­çš„é˜Ÿåˆ—è®¾è®¡ï¼Œå¯ä»¥åŠ å…¥çŠ¶æ€è®°å½•</li><li>å…³äºä»è°å¼€å§‹æœç´¢ï¼šæœ‰æ—¶å¯ä»¥è½¬æ¢æ€è·¯ï¼Œæºç‚¹å’Œç»ˆç‚¹åè¿‡æ¥ï¼Œé¿å… TLEï¼ˆLC 1162ï¼‰</li><li>æœ‰æ—¶å¯ä»¥ä½¿ç”¨å¤šæº BFS åŠ é€Ÿæœç´¢è¿‡ç¨‹ï¼ˆLC 934ï¼‰</li></ul><h2 id="dfs"><a class="markdownIt-Anchor" href="#dfs"></a> DFS</h2><p>ç½‘æ ¼ä¸Šçš„DFSæ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><p>LC 200. å²›å±¿æ•°é‡</p><div class="code-wrapper"><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">numIslands</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token operator">&amp;</span> grid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// è¿é€šå—ä¸ªæ•°</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> grid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// æ ‡è®°è¿é€šå—</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'1'</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token operator">++</span>res<span class="token punctuation">;</span>                    <span class="token function">dfs</span><span class="token punctuation">(</span>grid<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// (i, j)æ˜¯åæ ‡</span>    <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">>=</span> g<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> j <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> j <span class="token operator">>=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'1'</span> <span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'2'</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="bfs"><a class="markdownIt-Anchor" href="#bfs"></a> BFS</h2><p>ä½¿ç”¨åœºæ™¯</p><ul><li>æœ€çŸ­è·¯å¾„é—®é¢˜ï¼šåŸºäºBFSçš„æ€§è´¨ï¼ŒBFSé¦–å…ˆè®¿é—®çš„ï¼Œä¸€å®šæ˜¯æœ€çŸ­è·¯</li><li>éœ€è¦æ¨¡æ‹Ÿå±‚æ¬¡æ‰©æ•£é€»è¾‘</li></ul><p>LC 1091. äºŒè¿›åˆ¶çŸ©é˜µä¸­çš„æœ€çŸ­è·¯å¾„</p><div class="code-wrapper"><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">shortestPathBinaryMatrix</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span><span class="token operator">&amp;</span> grid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> grid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> grid<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> dirs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        queue<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">>></span> q<span class="token punctuation">;</span>        q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">pair</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// gridå……å½“viså’Œç­”æ¡ˆè®°å½•</span>        grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">auto</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å½“å‰çš„è·ç¦»</span>            <span class="token keyword">int</span> dis <span class="token operator">=</span> grid<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> d <span class="token operator">:</span> dirs <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> nx <span class="token operator">=</span> d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> ny <span class="token operator">=</span> d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> y<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> nx <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> nx <span class="token operator">>=</span> n <span class="token operator">||</span> ny <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> ny <span class="token operator">>=</span> n <span class="token operator">||</span> grid<span class="token punctuation">[</span>nx<span class="token punctuation">]</span><span class="token punctuation">[</span>ny<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>                grid<span class="token punctuation">[</span>nx<span class="token punctuation">]</span><span class="token punctuation">[</span>ny<span class="token punctuation">]</span> <span class="token operator">=</span> dis <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">pair</span><span class="token punctuation">(</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>                        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> grid<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> grid<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h1 id="2-æ™®é€šå›¾é—®é¢˜"><a class="markdownIt-Anchor" href="#2-æ™®é€šå›¾é—®é¢˜"></a> 2. æ™®é€šå›¾é—®é¢˜</h1><p>ä¸€èˆ¬çš„ï¼Œå›¾çš„å­˜å‚¨å®ç°æœ‰é‚»æ¥è¡¨ã€é‚»æ¥çŸ©é˜µã€é“¾å¼å‰å‘æ˜Ÿç­‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­˜å‚¨æ–¹å¼ä¸åŒï¼ŒDFSã€BFSçš„å®ç°ä¹Ÿæœ‰ä¸€äº›ä¸åŒã€‚</p><h2 id="dfs-2"><a class="markdownIt-Anchor" href="#dfs-2"></a> DFS</h2><p>å¤§è‡´ç»“æ„</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">DFS(v) &#x2F;&#x2F; v å¯ä»¥æ˜¯å›¾ä¸­çš„ä¸€ä¸ªé¡¶ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯æŠ½è±¡çš„æ¦‚å¿µï¼Œå¦‚ dp çŠ¶æ€ç­‰ã€‚  åœ¨ v ä¸Šæ‰“è®¿é—®æ ‡è®°  for u in v çš„ç›¸é‚»èŠ‚ç‚¹    if u æ²¡æœ‰æ‰“è¿‡è®¿é—®æ ‡è®° then      DFS(u)    end  endend<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="bfs-2"><a class="markdownIt-Anchor" href="#bfs-2"></a> BFS</h2><p>BFS ç®—æ³•æ‰¾åˆ°çš„è·¯å¾„æ˜¯ä»èµ·ç‚¹å¼€å§‹çš„ æœ€çŸ­ åˆæ³•è·¯å¾„ã€‚æ¢è¨€ä¹‹ï¼Œè¿™æ¡è·¯å¾„æ‰€åŒ…å«çš„è¾¹æ•°æœ€å°ã€‚</p><p>åœ¨ BFS ç»“æŸæ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯é€šè¿‡ä»èµ·ç‚¹åˆ°è¯¥ç‚¹çš„æœ€çŸ­è·¯å¾„è®¿é—®çš„ã€‚</p><p>åº”ç”¨åœºæ™¯</p><ul><li>åœ¨ä¸€ä¸ªæ— æƒå›¾ä¸Šæ±‚ä»èµ·ç‚¹åˆ°å…¶ä»–æ‰€æœ‰ç‚¹çš„æœ€çŸ­è·¯å¾„</li><li>åœ¨ä¸€ä¸ªæœ‰å‘æ— æƒå›¾ä¸­æ‰¾æœ€å°ç¯ï¼ˆä»æ¯ä¸ªç‚¹å¼€å§‹ BFSï¼Œåœ¨æˆ‘ä»¬å³å°†æŠµè¾¾ä¸€ä¸ªä¹‹å‰è®¿é—®è¿‡çš„ç‚¹å¼€å§‹çš„æ—¶å€™ï¼Œå°±çŸ¥é“é‡åˆ°äº†ä¸€ä¸ªç¯ã€‚å›¾çš„æœ€å°ç¯æ˜¯æ¯æ¬¡ BFS å¾—åˆ°çš„æœ€å°ç¯çš„å¹³å‡å€¼ã€‚ï¼‰</li><li>åœ¨ä¸€ä¸ªè¾¹æƒä¸º 0/1 çš„å›¾ä¸Šæ±‚æœ€çŸ­è·¯ï¼ˆ0-1 BFSï¼‰</li></ul><p>å¤§è‡´ç»“æ„</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">bfs(s) &#123;  q &#x3D; new queue()  q.push(s), visited[s] &#x3D; true  while (!q.empty()) &#123;    &#x2F;&#x2F; å¦‚æœè¦æ¶‰åŠåˆ°å±‚çº§å…³ç³»çš„ï¼Œè¦æŠŠåˆ†å±‚é€»è¾‘æŠ½å‡ºæ¥    u &#x3D; q.pop()    for each edge(u, v) &#123;      if (!visited[v]) &#123;        q.push(v)        visited[v] &#x3D; true      &#125;    &#125;  &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="å¤šæºbfs"><a class="markdownIt-Anchor" href="#å¤šæºbfs"></a> å¤šæºBFS</h2><p>å‰é¢æ‰€è¯´çš„ï¼Œä¸€èˆ¬éƒ½æ˜¯ä»å•ä¸ªæºç‚¹åˆ°å•ä¸ªç»ˆç‚¹çš„BFSï¼Œæ­¤æ—¶æ±‚æœ€çŸ­è·¯è¿‡ç¨‹ä¸­ï¼Œæå…¶å®¹æ˜“ TLE ï¼Œå¯ä»¥ä½¿ç”¨å¤šæº BFS åŠ é€Ÿã€‚</p><p>LC 542. 01 çŸ©é˜µ</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">updateMatrix</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> g<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> m <span class="token operator">=</span> g<span class="token punctuation">.</span>length<span class="token punctuation">,</span> n <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dirs <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">Deque</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// çŠ¶æ€æè¿°ï¼š0 è·ç¦»ä¸º0ï¼›-1,å½“å‰çš„â€œ1â€æœªè®¿é—®; > 0ï¼Œè·ç¦» </span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>i<span class="token punctuation">,</span> j<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// å½“å‰çš„ 1 æœªè®¿é—®</span>                <span class="token keyword">else</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ä»æ‰€æœ‰çš„ 0 å¼€å§‹å¤šæºBFS</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> xy <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> x <span class="token operator">=</span> xy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y <span class="token operator">=</span> xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> d <span class="token operator">:</span> dirs <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> nx <span class="token operator">=</span> x <span class="token operator">+</span> d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ny <span class="token operator">=</span> y <span class="token operator">+</span> d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token comment">// å…¶é‚»å±…æ˜¯æœªè¢«è®¿é—®çš„ 1ï¼Œå³å¯ç¡®å®šæœ€çŸ­è·ç¦»</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> nx <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nx <span class="token operator">&lt;</span> m <span class="token operator">&amp;&amp;</span> ny <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ny <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span> g<span class="token punctuation">[</span>nx<span class="token punctuation">]</span><span class="token punctuation">[</span>ny<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    g<span class="token punctuation">[</span>nx<span class="token punctuation">]</span><span class="token punctuation">[</span>ny<span class="token punctuation">]</span> <span class="token operator">=</span> g<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> g<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>LC 934. æœ€çŸ­çš„æ¡¥</p><blockquote><p>ç»™ä½ ä¸€ä¸ªå¤§å°ä¸º n x n çš„äºŒå…ƒçŸ©é˜µ grid ï¼Œå…¶ä¸­ 1 è¡¨ç¤ºé™†åœ°ï¼Œ0 è¡¨ç¤ºæ°´åŸŸã€‚</p><p>å²›æ˜¯ç”±å››é¢ç›¸è¿çš„ 1 å½¢æˆçš„ä¸€ä¸ªæœ€å¤§ç»„ï¼Œå³ä¸ä¼šä¸éç»„å†…çš„ä»»ä½•å…¶ä»– 1 ç›¸è¿ã€‚grid ä¸­ æ°å¥½å­˜åœ¨ä¸¤åº§å²› ã€‚<br />ä½ å¯ä»¥å°†ä»»æ„æ•°é‡çš„ 0 å˜ä¸º 1 ï¼Œä»¥ä½¿ä¸¤åº§å²›è¿æ¥èµ·æ¥ï¼Œå˜æˆ ä¸€åº§å²› ã€‚è¿”å›å¿…é¡»ç¿»è½¬çš„ 0 çš„æœ€å°æ•°ç›®</p><p>æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰<br />é“¾æ¥ï¼š<a href="https://leetcode.cn/problems/shortest-bridge">https://leetcode.cn/problems/shortest-bridge</a><br />è‘—ä½œæƒå½’é¢†æ‰£ç½‘ç»œæ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»å®˜æ–¹æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    queue<span class="token generics"><span class="token punctuation">&lt;</span>pair<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">></span><span class="token punctuation">></span></span> q<span class="token punctuation">;</span>    <span class="token keyword">int</span> dirs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">shortestBridge</span><span class="token punctuation">(</span>vector<span class="token generics"><span class="token punctuation">&lt;</span>vector<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token operator">&amp;</span> grid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> grid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// å°†å…¶ä¸­ä¸€ä¸ªè¿é€šå—æ ‡è®°ä¸º2 </span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">dfs</span><span class="token punctuation">(</span>grid<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// å¤šæº BFS</span>                    <span class="token keyword">return</span> <span class="token function">bfs</span><span class="token punctuation">(</span>grid<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// æœç´¢è¿é€šå—</span>    <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span>vector<span class="token generics"><span class="token punctuation">&lt;</span>vector<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">>=</span> g<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> j <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> j <span class="token operator">>=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment">// visited</span>        g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token function">make_pair</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// ç›´æ¥emplace(i, j)ä¹Ÿè¡Œ</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> auto<span class="token operator">&amp;</span> d <span class="token operator">:</span> dirs <span class="token punctuation">)</span> <span class="token function">dfs</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>i<span class="token punctuation">,</span> d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">bfs</span><span class="token punctuation">(</span>vector<span class="token generics"><span class="token punctuation">&lt;</span>vector<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> size <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span> size<span class="token operator">--</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                auto <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span> auto<span class="token operator">&amp;</span> d <span class="token operator">:</span> dirs <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">int</span> nx <span class="token operator">=</span> x<span class="token operator">+</span>d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ny <span class="token operator">=</span> y<span class="token operator">+</span>d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span> nx <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nx <span class="token operator">&lt;</span> g<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ny <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ny <span class="token operator">&lt;</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>nx<span class="token punctuation">]</span><span class="token punctuation">[</span>ny<span class="token punctuation">]</span> <span class="token operator">==</span>  <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            g<span class="token punctuation">[</span>nx<span class="token punctuation">]</span><span class="token punctuation">[</span>ny<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                            q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token function">make_pair</span><span class="token punctuation">(</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">&#125;</span>                        <span class="token comment">// BFS ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ï¼Œä¸€å®šæ˜¯æœ€çŸ­è·¯</span>                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>nx<span class="token punctuation">]</span><span class="token punctuation">[</span>ny<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">++</span>res<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h1 id="3-äºŒåˆ†å›¾"><a class="markdownIt-Anchor" href="#3-äºŒåˆ†å›¾"></a> 3. äºŒåˆ†å›¾</h1><p>äºŒåˆ†å›¾ï¼Œåˆç§°äºŒéƒ¨å›¾ï¼Œè‹±æ–‡åå« Bipartite graphã€‚</p><p>äºŒåˆ†å›¾æ˜¯ä»€ä¹ˆï¼ŸèŠ‚ç‚¹ç”±ä¸¤ä¸ªé›†åˆç»„æˆï¼Œä¸”ä¸¤ä¸ªé›†åˆå†…éƒ¨æ²¡æœ‰è¾¹çš„å›¾ã€‚</p><p>æ¢è¨€ä¹‹ï¼Œå­˜åœ¨ä¸€ç§æ–¹æ¡ˆï¼Œå°†èŠ‚ç‚¹åˆ’åˆ†æˆæ»¡è¶³ä»¥ä¸Šæ€§è´¨çš„ä¸¤ä¸ªé›†åˆã€‚</p><p><img src="https://oi-wiki.org/graph/images/bi-graph.svg" alt="äºŒåˆ†å›¾" /></p><p>æ€§è´¨</p><ul><li>å¦‚æœä¸¤ä¸ªé›†åˆä¸­çš„ç‚¹åˆ†åˆ«æŸ“æˆé»‘è‰²å’Œç™½è‰²ï¼Œå¯ä»¥å‘ç°äºŒåˆ†å›¾ä¸­çš„æ¯ä¸€æ¡è¾¹éƒ½ä¸€å®šæ˜¯è¿æ¥ä¸€ä¸ªé»‘è‰²ç‚¹å’Œä¸€ä¸ªç™½è‰²ç‚¹ã€‚</li><li>äºŒåˆ†å›¾ä¸å­˜åœ¨é•¿åº¦ä¸ºå¥‡æ•°çš„ç¯ï¼ˆå› ä¸ºæ¯ä¸€æ¡è¾¹éƒ½æ˜¯ä»ä¸€ä¸ªé›†åˆèµ°åˆ°å¦ä¸€ä¸ªé›†åˆï¼Œåªæœ‰èµ°å¶æ•°æ¬¡æ‰å¯èƒ½å›åˆ°åŒä¸€ä¸ªé›†åˆã€‚ï¼‰</li></ul><p>åˆ¤å®š</p><ul><li>çº¢è“æŸ“è‰²æ³•</li></ul><p>LC 785. åˆ¤æ–­äºŒåˆ†å›¾</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> color<span class="token punctuation">;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> g<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isBipartite</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> graph<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        color <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>graph<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>        g <span class="token operator">=</span> graph<span class="token punctuation">;</span>        <span class="token comment">// éå†æ¯ä¸ªè”é€šåˆ†é‡</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> g<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> color<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">dfs</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>valid <span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// æŸ“è‰²æ³•åˆ¤å®šäºŒåˆ†å›¾</span>        color<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> next <span class="token operator">:</span> g<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// æœªè®¿é—®ï¼Œé—´éš”æŸ“è‰²</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> color<span class="token punctuation">[</span>next<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">dfs</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token operator">-</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>valid <span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> color<span class="token punctuation">[</span>next<span class="token punctuation">]</span> <span class="token operator">==</span> c <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// ç›¸é‚»èŠ‚ç‚¹é¢œè‰²ä¸€æ ·ï¼Œå¿…ç„¶ä¸æ˜¯äºŒåˆ†å›¾</span>                valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h1 id="4-å›¾è®ºæ€§è´¨"><a class="markdownIt-Anchor" href="#4-å›¾è®ºæ€§è´¨"></a> 4. å›¾è®ºæ€§è´¨</h1><p>æœ‰äº›é¢˜ç›®ï¼Œå±äºè„‘ç­‹æ€¥è½¬å¼¯ä¸€ç±»ï¼Œå¯èƒ½å¹¶ä¸éœ€è¦éå†å›¾ï¼Œè€Œæ˜¯åˆ©ç”¨å›¾çš„æ€§è´¨ã€‚</p><ul><li>å…¥åº¦ã€å‡ºåº¦ï¼ˆLC 997ï¼‰</li><li>è¿é€šåˆ†é‡ï¼ˆLC 1319ï¼‰</li><li>etc</li></ul>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•ä¸æ•°æ®ç»“æ„</category>
      
    </categories>
    
    
    <tags>
      
      <tag>DFS</tag>
      
      <tag>BFS</tag>
      
      <tag>å¹¶æŸ¥é›†</tag>
      
      <tag>æœ€çŸ­è·¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LeetCode 2022ç§‹å­£ç¼–ç¨‹èµ›æ€»ç»“</title>
    <link href="/2022/09/24/LeetCode2022%E7%A7%8B%E5%AD%A3%E7%BC%96%E7%A8%8B%E8%B5%9B%E6%80%BB%E7%BB%93/"/>
    <url>/2022/09/24/LeetCode2022%E7%A7%8B%E5%AD%A3%E7%BC%96%E7%A8%8B%E8%B5%9B%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h1 id="0å‰è¨€"><a class="markdownIt-Anchor" href="#0å‰è¨€"></a> 0.å‰è¨€</h1><p>åˆšå¼€å§‹è¿Ÿåˆ°äº†åå‡ åˆ†é’Ÿï¼Œä¸€ä¸ªåŠå°æ—¶ï¼ŒåªAäº†ä¸‰é“ï¼Œåé¢ä¸¤é“æˆ˜æœ¯æ€§æ”¾å¼ƒã€‚æœ€ç»ˆæ’å836ï¼Œä¹Ÿç®—æ˜¯æ„æ–™ä¹‹å¤–äº†ã€‚</p><h1 id="1æ°”æ¸©å˜åŒ–è¶‹åŠ¿"><a class="markdownIt-Anchor" href="#1æ°”æ¸©å˜åŒ–è¶‹åŠ¿"></a> 1.æ°”æ¸©å˜åŒ–è¶‹åŠ¿</h1><h2 id="é¢˜ç›®"><a class="markdownIt-Anchor" href="#é¢˜ç›®"></a> é¢˜ç›®</h2><p>åŠ›æ‰£åŸè®¡åˆ’åœ¨ä¸¤åœ°è®¾ç«‹ã€ŒåŠ›æ‰£å˜‰å¹´åã€çš„åˆ†ä¼šåœºï¼Œæ°”è±¡å°ç»„æ­£åœ¨åˆ†æä¸¤åœ°åŒºçš„æ°”æ¸©å˜åŒ–è¶‹åŠ¿ï¼Œå¯¹äºç¬¬ i ~ (i+1) å¤©çš„æ°”æ¸©å˜åŒ–è¶‹åŠ¿ï¼Œå°†æ ¹æ®ä»¥ä¸‹è§„åˆ™åˆ¤æ–­ï¼š</p><p>è‹¥ç¬¬ i+1 å¤©çš„æ°”æ¸© é«˜äº ç¬¬ i å¤©ï¼Œä¸º ä¸Šå‡ è¶‹åŠ¿<br />è‹¥ç¬¬ i+1 å¤©çš„æ°”æ¸© ç­‰äº ç¬¬ i å¤©ï¼Œä¸º å¹³ç¨³ è¶‹åŠ¿<br />è‹¥ç¬¬ i+1 å¤©çš„æ°”æ¸© ä½äº ç¬¬ i å¤©ï¼Œä¸º ä¸‹é™ è¶‹åŠ¿<br />å·²çŸ¥ temperatureA[i] å’Œ temperatureB[i] åˆ†åˆ«è¡¨ç¤ºç¬¬ i å¤©ä¸¤åœ°åŒºçš„æ°”æ¸©ã€‚<br />ç»„å§”ä¼šå¸Œæœ›æ‰¾åˆ°ä¸€æ®µå¤©æ•°å°½å¯èƒ½å¤šï¼Œä¸”ä¸¤åœ°æ°”æ¸©å˜åŒ–è¶‹åŠ¿ç›¸åŒçš„æ—¶é—´ä¸¾åŠå˜‰å¹´åæ´»åŠ¨ã€‚è¯·åˆ†æå¹¶è¿”å›<strong>ä¸¤åœ°æ°”æ¸©å˜åŒ–è¶‹åŠ¿ç›¸åŒçš„æœ€å¤§è¿ç»­å¤©æ•°</strong>ã€‚</p><p>å³æœ€å¤§çš„ nï¼Œä½¿å¾—ç¬¬ i~i+n å¤©ä¹‹é—´ï¼Œä¸¤åœ°æ°”æ¸©å˜åŒ–è¶‹åŠ¿ç›¸åŒ</p><p>ç¤ºä¾‹ 1ï¼š</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">è¾“å…¥ï¼štemperatureA <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">]</span>temperatureB <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">]</span>è¾“å‡ºï¼š<span class="token number">2</span>è§£é‡Šï¼šå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œ ç¬¬ <span class="token number">2</span>ï½<span class="token number">4</span> å¤©ä¸¤åœ°æ°”æ¸©å˜åŒ–è¶‹åŠ¿ç›¸åŒï¼Œä¸”æŒç»­æ—¶é—´æœ€é•¿ï¼Œå› æ­¤è¿”å› <span class="token number">4</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="æ€è·¯"><a class="markdownIt-Anchor" href="#æ€è·¯"></a> æ€è·¯</h2><ul><li>ç›´æ¥è®¡ç®—å‡ºAã€Bä¸¤åœ°çš„æ°”æ¸©å˜æ¢è¶‹åŠ¿ï¼Œå­˜å…¥ä¸¤ä¸ªæ•°ç»„</li><li>éå†æ•°ç»„ï¼Œæ›´æ–°æœ€å¤§ç›¸åŒå­æ•°ç»„é•¿åº¦</li><li>æ—¶é—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ï¼›ç©ºé—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></li></ul><h2 id="ä»£ç "><a class="markdownIt-Anchor" href="#ä»£ç "></a> ä»£ç </h2><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">temperatureTrend</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temperatureA<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temperatureB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> temperatureA<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            a<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">gao</span><span class="token punctuation">(</span>temperatureA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> temperatureA<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            b<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">gao</span><span class="token punctuation">(</span>temperatureB<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> temperatureB<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span> cnt<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">// æ›´æ–°æœ€å¤§å€¼ï¼Œé‡æ–°è®¡æ•°</span>            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                res <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>                cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">gao</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> a <span class="token operator">==</span> b <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>a <span class="token operator">></span> b <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h1 id="2äº¤é€šæ¢çº½"><a class="markdownIt-Anchor" href="#2äº¤é€šæ¢çº½"></a> 2.äº¤é€šæ¢çº½</h1><h2 id="é¢˜ç›®-2"><a class="markdownIt-Anchor" href="#é¢˜ç›®-2"></a> é¢˜ç›®</h2><p>ä¸ºäº†ç¼“è§£ã€ŒåŠ›æ‰£å˜‰å¹´åã€æœŸé—´çš„äººæµå‹åŠ›ï¼Œç»„å§”ä¼šåœ¨æ´»åŠ¨æœŸé—´å¼€è®¾äº†ä¸€äº›äº¤é€šä¸“çº¿ã€‚path[i] = [a, b] è¡¨ç¤ºæœ‰ä¸€æ¡ä»åœ°ç‚¹ aé€šå¾€åœ°ç‚¹ b çš„ å•å‘ äº¤é€šä¸“çº¿ã€‚<br />è‹¥å­˜åœ¨ä¸€ä¸ªåœ°ç‚¹ï¼Œæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼Œæˆ‘ä»¬åˆ™ç§°ä¹‹ä¸º äº¤é€šæ¢çº½ï¼š</p><ul><li>æ‰€æœ‰åœ°ç‚¹ï¼ˆé™¤è‡ªèº«å¤–ï¼‰å‡æœ‰ä¸€æ¡ å•å‘ ä¸“çº¿ ç›´æ¥ é€šå¾€è¯¥åœ°ç‚¹ï¼›</li><li>è¯¥åœ°ç‚¹ä¸å­˜åœ¨ä»»ä½• é€šå¾€å…¶ä»–åœ°ç‚¹ çš„å•å‘ä¸“çº¿ã€‚<br />è¯·è¿”å›äº¤é€šä¸“çº¿çš„ äº¤é€šæ¢çº½ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› -1ã€‚</li></ul><p>æ³¨æ„ï¼š</p><ul><li>å¯¹äºä»»æ„ä¸€ä¸ªåœ°ç‚¹ï¼Œè‡³å°‘è¢«ä¸€æ¡ä¸“çº¿è¿é€šã€‚</li></ul><p>ç¤ºä¾‹ 1ï¼š</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">è¾“å…¥ï¼špath <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>è¾“å‡ºï¼š<span class="token number">3</span>è§£é‡Šï¼šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šåœ°ç‚¹ <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span> å„æœ‰ä¸€æ¡é€šå¾€åœ°ç‚¹ <span class="token number">3</span> çš„äº¤é€šä¸“çº¿ï¼Œä¸”åœ°ç‚¹ <span class="token number">3</span> ä¸å­˜åœ¨ä»»ä½•é€šå¾€å…¶ä»–åœ°ç‚¹çš„äº¤é€šä¸“çº¿ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="æ€è·¯-2"><a class="markdownIt-Anchor" href="#æ€è·¯-2"></a> æ€è·¯</h2><p>æ— éœ€å»ºå›¾ï¼Œç›´æ¥ç»Ÿè®¡èŠ‚ç‚¹å‡ºå…¥åº¦æ•°ã€‚å‡ºåº¦<mark>0 &amp;&amp; å…¥åº¦</mark>n-1çš„èŠ‚ç‚¹å°±æ˜¯äº¤é€šæ¢çº½</p><h2 id="ä»£ç -2"><a class="markdownIt-Anchor" href="#ä»£ç -2"></a> ä»£ç </h2><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">transportationHub</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">1001</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">1001</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// ç»Ÿè®¡èŠ‚ç‚¹ä¸ªæ•°</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> p <span class="token operator">:</span> path <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            out<span class="token punctuation">[</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>            in<span class="token punctuation">[</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>            set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1001</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> in<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> set<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> out<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> i<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h1 id="3å¼¹ç æ¸¸æˆ"><a class="markdownIt-Anchor" href="#3å¼¹ç æ¸¸æˆ"></a> 3.å¼¹ç æ¸¸æˆ</h1><h2 id="é¢˜ç›®-3"><a class="markdownIt-Anchor" href="#é¢˜ç›®-3"></a> é¢˜ç›®</h2><p>æ¬¢è¿å„ä½æ¥åˆ°ã€ŒåŠ›æ‰£å˜‰å¹´åã€ï¼Œæ¥ä¸‹æ¥å°†ä¸ºå„ä½ä»‹ç»åœ¨æ´»åŠ¨ä¸­å¹¿å—å¥½è¯„çš„å¼¹ç æ¸¸æˆã€‚</p><p>N*M å¤§å°çš„å¼¹ç ç›˜çš„åˆå§‹çŠ¶æ€ä¿¡æ¯è®°å½•äºä¸€ç»´å­—ç¬¦ä¸²å‹æ•°ç»„ plate ä¸­ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ä¸ºä»…ç”± â€œOâ€ã€â€œWâ€ã€â€œEâ€ã€&quot;.&quot; ç»„æˆçš„å­—ç¬¦ä¸²ã€‚å…¶ä¸­ï¼š</p><ul><li>â€œOâ€ è¡¨ç¤ºå¼¹ç æ´ï¼ˆå¼¹ç åˆ°è¾¾åä¼šè½å…¥æ´ä¸­ï¼Œå¹¶åœæ­¢å‰è¿›ï¼‰ï¼›</li><li>â€œWâ€ è¡¨ç¤ºé€†æ—¶é’ˆè½¬å‘å™¨ï¼ˆå¼¹ç ç»è¿‡æ—¶æ–¹å‘å°†é€†æ—¶é’ˆæ—‹è½¬ 90 åº¦ï¼‰ï¼›</li><li>â€œEâ€ è¡¨ç¤ºé¡ºæ—¶é’ˆè½¬å‘å™¨ï¼ˆå¼¹ç ç»è¿‡æ—¶æ–¹å‘å°†é¡ºæ—¶é’ˆæ—‹è½¬ 90 åº¦ï¼‰ï¼›</li><li>â€œ.â€ è¡¨ç¤ºç©ºç™½åŒºåŸŸï¼ˆå¼¹ç å¯é€šè¡Œï¼‰ã€‚</li><li></li></ul><p>æ¸¸æˆè§„åˆ™è¦æ±‚ä»…èƒ½åœ¨è¾¹ç¼˜ä½ç½®çš„ ç©ºç™½åŒºåŸŸ å¤„ï¼ˆå¼¹ç ç›˜çš„å››è§’é™¤å¤–ï¼‰æ²¿ ä¸è¾¹ç¼˜å‚ç›´ çš„æ–¹å‘æ‰“å…¥å¼¹ç ï¼Œå¹¶ä¸”æ‰“å…¥åçš„æ¯é¢—å¼¹ç æœ€å¤šèƒ½ å‰è¿› num æ­¥ã€‚è¯·è¿”å›ç¬¦åˆä¸Šè¿°è¦æ±‚ä¸”å¯ä»¥ä½¿å¼¹ç æœ€ç»ˆå…¥æ´çš„æ‰€æœ‰æ‰“å…¥ä½ç½®ã€‚ä½ å¯ä»¥ æŒ‰ä»»æ„é¡ºåº è¿”å›ç­”æ¡ˆã€‚</p><p>æ³¨æ„ï¼š</p><ul><li>è‹¥å¼¹ç å·²åˆ°è¾¾å¼¹ç ç›˜è¾¹ç¼˜å¹¶ä¸”ä»æ²¿ç€å‡ºç•Œæ–¹å‘ç»§ç»­å‰è¿›ï¼Œåˆ™å°†ç›´æ¥å‡ºç•Œ</li></ul><p>ç¤ºä¾‹ 1ï¼š</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">è¾“å…¥ï¼šnum <span class="token operator">=</span> <span class="token number">4</span>plate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"..E."</span><span class="token punctuation">,</span><span class="token string">".EOW"</span><span class="token punctuation">,</span><span class="token string">"..W."</span><span class="token punctuation">]</span>è¾“å‡ºï¼š<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>è§£é‡Šï¼šåœ¨ <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> å¤„æ‰“å…¥å¼¹ç ï¼Œå¼¹ç å‰è¿› <span class="token number">1</span> æ­¥åé‡åˆ°è½¬å‘å™¨ï¼Œå‰è¿›æ–¹å‘é¡ºæ—¶é’ˆæ—‹è½¬ <span class="token number">90</span> åº¦ï¼Œå†å‰è¿› <span class="token number">1</span> æ­¥è¿›å…¥æ´ä¸­ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰<br />é“¾æ¥ï¼š<a href="https://leetcode.cn/problems/EXvqDp">https://leetcode.cn/problems/EXvqDp</a><br />è‘—ä½œæƒå½’é¢†æ‰£ç½‘ç»œæ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»å®˜æ–¹æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><h2 id="æ€è·¯-3"><a class="markdownIt-Anchor" href="#æ€è·¯-3"></a> æ€è·¯</h2><p>ç›´æ¥DFSï¼Œä»å››ä¸ªè¾¹ç•Œå¼€å§‹ï¼Œçœ‹åœ¨numæ­¥ä¹‹å†…æ˜¯å¦èƒ½åˆ°è¾¾â€œOâ€ä¹‹å¤„ã€‚æ³¨æ„ï¼Œå››ä¸ªè¾¹è§’è¦é™¤å¤–ï¼›å¦å¤–ï¼Œæ–¹å‘çš„å¤„ç†ä½¿ç”¨diræ•°ç»„æ¥å–æ¨¡è½¬ç§»ã€‚</p><p><code>int[][] dirs = new int[][]&#123;&#123;-1, 0&#125;, &#123;0, 1&#125;, &#123;1, 0&#125;, &#123;0, -1&#125;&#125;;</code></p><h2 id="ä»£ç -3"><a class="markdownIt-Anchor" href="#ä»£ç -3"></a> ä»£ç </h2><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> g<span class="token punctuation">;</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span>    <span class="token comment">// ä¸Šï¼Œå³ï¼Œä¸‹ï¼Œå·¦ï¼ˆé¡ºæ—¶é’ˆï¼‰</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dirs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">ballGame</span><span class="token punctuation">(</span><span class="token keyword">int</span> _num<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        num <span class="token operator">=</span> _num<span class="token punctuation">;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> plate<span class="token punctuation">.</span>length<span class="token punctuation">,</span> m <span class="token operator">=</span> plate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> plate<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// ä»ç¬¬ä¸€è¡Œï¼Œæœ€åä¸€è¡Œå¼€å§‹è¿›å…¥</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dfs</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ç¬¬ä¸€åˆ—ï¼Œæœ€åä¸€åˆ—</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dfs</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>m<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dfs</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> m<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>i<span class="token punctuation">,</span> m<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>res<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tt <span class="token operator">:</span> res<span class="token punctuation">)</span> ans<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span>tt<span class="token punctuation">;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">boolean</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">,</span> <span class="token keyword">int</span> step<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> step <span class="token operator">></span> num <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'O'</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token comment">// æ–°åæ ‡</span>        <span class="token keyword">int</span> dx <span class="token operator">=</span> i <span class="token operator">+</span> dirs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dy <span class="token operator">=</span> j <span class="token operator">+</span> dirs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">out</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">dfs</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">,</span> step<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">nextIdx</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">boolean</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">>=</span> g<span class="token punctuation">.</span>length <span class="token operator">||</span> j<span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> j <span class="token operator">>=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">nextIdx</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// é€†æ—¶é’ˆï¼Œ+3</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'W'</span> <span class="token punctuation">)</span> idx <span class="token operator">=</span> <span class="token punctuation">(</span>idx<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">;</span>        <span class="token comment">// é¡ºæ—¶é’ˆï¼Œ+1</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'E'</span> <span class="token punctuation">)</span> idx <span class="token operator">=</span> <span class="token punctuation">(</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> idx<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•ä¸æ•°æ®ç»“æ„</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ·é¢˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redisé«˜å¯æ‹“å±•-åˆ†ç‰‡æŠ€æœ¯</title>
    <link href="/2022/08/09/Redis%E9%AB%98%E5%8F%AF%E6%8B%93%E5%B1%95-%E5%88%86%E7%89%87%E6%8A%80%E6%9C%AF/"/>
    <url>/2022/08/09/Redis%E9%AB%98%E5%8F%AF%E6%8B%93%E5%B1%95-%E5%88%86%E7%89%87%E6%8A%80%E6%9C%AF/</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h1 id="0å‰è¨€"><a class="markdownIt-Anchor" href="#0å‰è¨€"></a> 0.å‰è¨€</h1><p>Redisæä¾›ä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤æœºåˆ¶ï¼Œæ­å»ºä¸»ä»æ¶æ„æ¥ä¿è¯é«˜å¯ç”¨ã€‚<br />å¦‚æœ<strong>æµ·é‡æ•°æ®+é«˜å¹¶å‘+é«˜å¯ç”¨</strong>åœºæ™¯ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ<br />Redis clusterï¼Œä¸»è¦æ˜¯é’ˆå¯¹æµ·é‡æ•°æ®+é«˜å¹¶å‘+é«˜å¯ç”¨çš„åœºæ™¯ã€‚Redis cluster æ”¯æ’‘ N ä¸ª Redis master nodeï¼Œæ¯ä¸ª master node éƒ½å¯ä»¥æŒ‚è½½å¤šä¸ª slave nodeã€‚è¿™æ ·æ•´ä¸ª Redis å°±å¯ä»¥æ¨ªå‘æ‰©å®¹äº†ã€‚å¦‚æœä½ è¦æ”¯æ’‘æ›´å¤§æ•°æ®é‡çš„ç¼“å­˜ï¼Œé‚£å°±æ¨ªå‘æ‰©å®¹æ›´å¤šçš„ master èŠ‚ç‚¹ï¼Œæ¯ä¸ª master èŠ‚ç‚¹å°±èƒ½å­˜æ”¾æ›´å¤šçš„æ•°æ®äº†ã€‚</p><h1 id="1redis-clusterä»‹ç»"><a class="markdownIt-Anchor" href="#1redis-clusterä»‹ç»"></a> 1.Redis Clusterä»‹ç»</h1><ul><li>è‡ªåŠ¨å°†æ•°æ®è¿›è¡Œåˆ†ç‰‡ï¼Œæ¯ä¸ª master ä¸Šæ”¾ä¸€éƒ¨åˆ†æ•°æ®</li><li>æä¾›å†…ç½®çš„é«˜å¯ç”¨æ”¯æŒï¼Œéƒ¨åˆ† master ä¸å¯ç”¨æ—¶ï¼Œè¿˜æ˜¯å¯ä»¥ç»§ç»­å·¥ä½œçš„</li></ul><p>åœ¨ Redis cluster æ¶æ„ä¸‹ï¼Œæ¯ä¸ª Redis è¦æ”¾å¼€ä¸¤ä¸ªç«¯å£å·ï¼Œæ¯”å¦‚ä¸€ä¸ªæ˜¯ 6379ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯ åŠ  1w çš„ç«¯å£å·ï¼Œæ¯”å¦‚ 16379ã€‚<br />16379 ç«¯å£å·æ˜¯ç”¨æ¥è¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡çš„ï¼Œä¹Ÿå°±æ˜¯ cluster bus çš„ä¸œè¥¿ï¼Œcluster bus çš„é€šä¿¡ï¼Œç”¨æ¥è¿›è¡Œæ•…éšœæ£€æµ‹ã€é…ç½®æ›´æ–°ã€æ•…éšœè½¬ç§»æˆæƒã€‚cluster bus ç”¨äº†å¦å¤–ä¸€ç§äºŒè¿›åˆ¶çš„åè®®ï¼Œ gossip åè®®ï¼Œç”¨äºèŠ‚ç‚¹é—´è¿›è¡Œé«˜æ•ˆçš„æ•°æ®äº¤æ¢ï¼Œå ç”¨æ›´å°‘çš„ç½‘ç»œå¸¦å®½å’Œå¤„ç†æ—¶é—´ã€‚</p><h1 id="2èŠ‚ç‚¹é—´é€šä¿¡æœºåˆ¶"><a class="markdownIt-Anchor" href="#2èŠ‚ç‚¹é—´é€šä¿¡æœºåˆ¶"></a> 2.èŠ‚ç‚¹é—´é€šä¿¡æœºåˆ¶</h1><h2 id="åŸºæœ¬é€šä¿¡æœºåˆ¶"><a class="markdownIt-Anchor" href="#åŸºæœ¬é€šä¿¡æœºåˆ¶"></a> åŸºæœ¬é€šä¿¡æœºåˆ¶</h2><p>é›†ç¾¤å…ƒæ•°æ®çš„ç»´æŠ¤æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>é›†ä¸­å¼</li><li>Gossip åè®®</li></ul><p>Redis cluster èŠ‚ç‚¹é—´é‡‡ç”¨ gossip åè®®è¿›è¡Œé€šä¿¡ã€‚</p><h3 id="é›†ä¸­å¼"><a class="markdownIt-Anchor" href="#é›†ä¸­å¼"></a> é›†ä¸­å¼</h3><p>é›†ä¸­å¼æ˜¯å°†é›†ç¾¤å…ƒæ•°æ®ï¼ˆèŠ‚ç‚¹ä¿¡æ¯ã€æ•…éšœç­‰ç­‰ï¼‰<strong>é›†ä¸­å­˜å‚¨åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Š</strong>ã€‚é›†ä¸­å¼å…ƒæ•°æ®é›†ä¸­å­˜å‚¨çš„ä¸€ä¸ªå…¸å‹ä»£è¡¨ï¼Œå°±æ˜¯å¤§æ•°æ®é¢†åŸŸçš„ storm ã€‚å®ƒæ˜¯åˆ†å¸ƒå¼çš„å¤§æ•°æ®å®æ—¶è®¡ç®—å¼•æ“ï¼Œæ˜¯é›†ä¸­å¼çš„å…ƒæ•°æ®å­˜å‚¨çš„ç»“æ„ï¼Œåº•å±‚åŸºäº zookeeperï¼ˆåˆ†å¸ƒå¼åè°ƒçš„ä¸­é—´ä»¶ï¼‰å¯¹æ‰€æœ‰å…ƒæ•°æ®è¿›è¡Œå­˜å‚¨ç»´æŠ¤ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659926419484-092f1a0b-98f3-4ee4-b07e-3b5f3a448a09.jpeg" alt="" /></p><h4 id="ä¼˜ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#ä¼˜ç¼ºç‚¹"></a> ä¼˜ç¼ºç‚¹</h4><p>ä¼˜ç‚¹ï¼š</p><ul><li>å…ƒæ•°æ®çš„è¯»å–å’Œæ›´æ–°ï¼Œæ—¶æ•ˆæ€§éå¸¸å¥½ï¼Œä¸€æ—¦å…ƒæ•°æ®å‡ºç°äº†å˜æ›´ï¼Œå°±ç«‹å³æ›´æ–°åˆ°é›†ä¸­å¼çš„å­˜å‚¨ä¸­ï¼Œå…¶å®ƒèŠ‚ç‚¹è¯»å–çš„æ—¶å€™å°±å¯ä»¥æ„ŸçŸ¥åˆ°ï¼›</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æ‰€æœ‰çš„å…ƒæ•°æ®çš„æ›´æ–°å‹åŠ›å…¨éƒ¨é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…ƒæ•°æ®çš„å­˜å‚¨æœ‰å‹åŠ›ã€‚</li></ul><h3 id="gossipåè®®"><a class="markdownIt-Anchor" href="#gossipåè®®"></a> Gossipåè®®</h3><p>gossip åè®®ï¼Œ<strong>æ‰€æœ‰èŠ‚ç‚¹éƒ½æŒæœ‰ä¸€ä»½å…ƒæ•°æ®</strong>ï¼Œä¸åŒçš„èŠ‚ç‚¹å¦‚æœå‡ºç°äº†å…ƒæ•°æ®çš„å˜æ›´ï¼Œå°±ä¸æ–­å°†å…ƒæ•°æ®å‘é€ç»™å…¶å®ƒçš„èŠ‚ç‚¹ï¼Œè®©å…¶å®ƒèŠ‚ç‚¹ä¹Ÿè¿›è¡Œå…ƒæ•°æ®çš„å˜æ›´ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659926906420-0a53a878-298f-49f3-bb74-d4dc1df011f7.jpeg" alt="" /></p><h4 id="ä¼˜ç¼ºç‚¹-2"><a class="markdownIt-Anchor" href="#ä¼˜ç¼ºç‚¹-2"></a> ä¼˜ç¼ºç‚¹</h4><p>ä¼˜ç‚¹ï¼š</p><ul><li>å…ƒæ•°æ®çš„æ›´æ–°æ¯”è¾ƒåˆ†æ•£ï¼Œä¸æ˜¯é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œæ›´æ–°è¯·æ±‚ä¼šé™†é™†ç»­ç»­æ‰“åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸Šå»æ›´æ–°ï¼Œé™ä½äº†å‹åŠ›</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>å…ƒæ•°æ®çš„æ›´æ–°æœ‰å»¶æ—¶ï¼Œå¯èƒ½å¯¼è‡´é›†ç¾¤ä¸­çš„ä¸€äº›æ“ä½œä¼šæœ‰ä¸€äº›æ»å</li></ul><h1 id="3åˆ†å¸ƒå¼é€‰å€ç®—æ³•"><a class="markdownIt-Anchor" href="#3åˆ†å¸ƒå¼é€‰å€ç®—æ³•"></a> 3.åˆ†å¸ƒå¼é€‰å€ç®—æ³•</h1><blockquote><p>æ—¢ç„¶Rediséƒ¨ç½²äº†å¤šä¸ªClusterï¼Œé‚£ä¹ˆå¿…ç„¶æ¶‰åŠè®¿é—®å“ªä¸€ä¸ªèŠ‚ç‚¹çš„é—®é¢˜ï¼Œå³åˆ†å¸ƒå¼é€‰å€ã€‚</p></blockquote><p>åœ¨åŠ¨æ€å˜åŒ–çš„Cacheç¯å¢ƒä¸­ï¼Œåˆ¤å®šå“ˆå¸Œç®—æ³•å¥½åçš„å››ä¸ªå®šä¹‰:</p><ul><li><strong>å¹³è¡¡æ€§(Balance)</strong>: å¹³è¡¡æ€§æ˜¯æŒ‡å“ˆå¸Œçš„ç»“æœèƒ½å¤Ÿå°½å¯èƒ½åˆ†å¸ƒåˆ°æ‰€æœ‰çš„åˆ†ç‰‡ä¸­å»ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—æ‰€æœ‰çš„ç¼“å†²ç©ºé—´éƒ½å¾—åˆ°åˆ©ç”¨ã€‚å¾ˆå¤šå“ˆå¸Œç®—æ³•éƒ½èƒ½å¤Ÿæ»¡è¶³è¿™ä¸€æ¡ä»¶ã€‚</li><li><strong>å•è°ƒæ€§(Monotonicity)</strong>: å•è°ƒæ€§æ˜¯æŒ‡å¦‚æœå·²ç»æœ‰ä¸€äº›å†…å®¹é€šè¿‡å“ˆå¸Œåˆ†æ´¾åˆ°äº†ç›¸åº”çš„ç¼“å†²ä¸­ï¼Œåˆæœ‰æ–°çš„ç¼“å†²åŠ å…¥åˆ°ç³»ç»Ÿä¸­ã€‚å“ˆå¸Œçš„ç»“æœåº”èƒ½å¤Ÿä¿è¯åŸæœ‰å·²åˆ†é…çš„å†…å®¹å¯ä»¥è¢«æ˜ å°„åˆ°åŸæœ‰çš„æˆ–è€…æ–°çš„ç¼“å†²ä¸­å»ï¼Œè€Œä¸ä¼šè¢«æ˜ å°„åˆ°æ—§çš„ç¼“å†²é›†åˆä¸­çš„å…¶ä»–ç¼“å†²åŒºã€‚</li><li><strong>åˆ†æ•£æ€§(Spread)</strong>: åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œç»ˆç«¯æœ‰å¯èƒ½çœ‹ä¸åˆ°æ‰€æœ‰çš„ç¼“å†²ï¼Œè€Œæ˜¯åªèƒ½çœ‹åˆ°å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚å½“ç»ˆç«¯å¸Œæœ›é€šè¿‡å“ˆå¸Œè¿‡ç¨‹å°†å†…å®¹æ˜ å°„åˆ°ç¼“å†²ä¸Šæ—¶ï¼Œç”±äºä¸åŒç»ˆç«¯æ‰€è§çš„ç¼“å†²èŒƒå›´æœ‰å¯èƒ½ä¸åŒï¼Œä»è€Œå¯¼è‡´å“ˆå¸Œçš„ç»“æœä¸ä¸€è‡´ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ç›¸åŒçš„å†…å®¹è¢«ä¸åŒçš„ç»ˆç«¯æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ã€‚è¿™ç§æƒ…å†µæ˜¾ç„¶æ˜¯åº”è¯¥é¿å…çš„ï¼Œå› ä¸ºå®ƒå¯¼è‡´ç›¸åŒå†…å®¹è¢«å­˜å‚¨åˆ°ä¸åŒç¼“å†²ä¸­å»ï¼Œé™ä½äº†ç³»ç»Ÿå­˜å‚¨çš„æ•ˆç‡ã€‚åˆ†æ•£æ€§çš„å®šä¹‰å°±æ˜¯ä¸Šè¿°æƒ…å†µå‘ç”Ÿçš„ä¸¥é‡ç¨‹åº¦ã€‚å¥½çš„å“ˆå¸Œç®—æ³•åº”èƒ½å¤Ÿå°½é‡é¿å…ä¸ä¸€è‡´çš„æƒ…å†µå‘ç”Ÿï¼Œä¹Ÿå°±æ˜¯å°½é‡é™ä½åˆ†æ•£æ€§ã€‚</li><li><strong>è´Ÿè½½(Load)</strong>: è´Ÿè½½é—®é¢˜å®é™…ä¸Šæ˜¯ä»å¦ä¸€ä¸ªè§’åº¦çœ‹å¾…åˆ†æ•£æ€§é—®é¢˜ã€‚æ—¢ç„¶ä¸åŒçš„ç»ˆç«¯å¯èƒ½å°†ç›¸åŒçš„å†…å®¹æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªç‰¹å®šçš„ç¼“å†²åŒºè€Œè¨€ï¼Œä¹Ÿå¯èƒ½è¢«ä¸åŒçš„ç”¨æˆ·æ˜ å°„ä¸ºä¸åŒ çš„å†…å®¹ã€‚ä¸åˆ†æ•£æ€§ä¸€æ ·ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ˜¯åº”å½“é¿å…çš„ï¼Œå› æ­¤å¥½çš„å“ˆå¸Œç®—æ³•åº”èƒ½å¤Ÿå°½é‡é™ä½ç¼“å†²çš„è´Ÿè·ã€‚</li></ul><p>é€šå¸¸ï¼Œæœ‰ä»¥ä¸‹å‡ ç§é€‰å€ç®—æ³•ï¼š</p><ul><li>hash ç®—æ³•ï¼ˆå¤§é‡ç¼“å­˜é‡å»ºï¼‰</li><li>ä¸€è‡´æ€§ hash ç®—æ³•ï¼ˆè‡ªåŠ¨ç¼“å­˜è¿ç§»ï¼‰+ è™šæ‹ŸèŠ‚ç‚¹ï¼ˆè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼‰</li><li>Redis cluster çš„ hash slot ç®—æ³•</li></ul><h2 id="hashç®—æ³•"><a class="markdownIt-Anchor" href="#hashç®—æ³•"></a> hashç®—æ³•</h2><p>å¯¹ä¸€ä¸ªkeyï¼Œå…ˆè®¡ç®—hashæ•°å€¼ï¼Œç„¶åå¯¹èŠ‚ç‚¹æ•°ç›®å–æ¨¡ï¼Œéšåæ‹¿è¿™ä¸ªç»“æœå»è®¿é—®å¯¹åº”çš„masterã€‚</p><h3 id="å±€é™æ€§"><a class="markdownIt-Anchor" href="#å±€é™æ€§"></a> å±€é™æ€§</h3><p>ä½†æ˜¯ï¼Œå½“æŸä¸ªmasteræŒ‚æ‰åï¼ŒèŠ‚ç‚¹æ•°ç›®å°±è¦æ”¹å˜ï¼Œå¯¼è‡´å¤§é‡çš„è¯·æ±‚æ— æ³•è·å¾—æ­£ç¡®æœ‰æ•ˆçš„æ•°æ®ï¼Œç”šè‡³ç¼“å­˜æœ‰å®•æœºé£é™©ã€‚</p><h2 id="ä¸€è‡´æ€§hashç®—æ³•"><a class="markdownIt-Anchor" href="#ä¸€è‡´æ€§hashç®—æ³•"></a> ä¸€è‡´æ€§hashç®—æ³•</h2><blockquote><p>hashç¯è§£å†³å•è°ƒæ€§é—®é¢˜ã€è™šæ‹ŸèŠ‚ç‚¹è§£å†³ä¸å¹³è¡¡é—®é¢˜ã€‚</p></blockquote><p>ä¸ºäº†è§£å†³ä¼ ç»Ÿhashçš„å•è°ƒæ€§é—®é¢˜ï¼Œä¸€è‡´æ€§hashå¼•å…¥äº†hashç¯çš„æ¦‚å¿µï¼š</p><h3 id="hashç¯"><a class="markdownIt-Anchor" href="#hashç¯"></a> hashç¯</h3><p>ä¸€è‡´æ€§ hash ç®—æ³•å°†æ•´ä¸ª hash å€¼ç©ºé—´ç»„ç»‡æˆä¸€ä¸ªè™šæ‹Ÿçš„åœ†ç¯ï¼Œæ•´ä¸ªç©ºé—´æŒ‰<strong>é¡ºæ—¶é’ˆæ–¹å‘</strong>ç»„ç»‡ï¼Œä¸‹ä¸€æ­¥å°†å„ä¸ª master èŠ‚ç‚¹ï¼ˆä½¿ç”¨æœåŠ¡å™¨çš„ ip æˆ–ä¸»æœºåï¼‰è¿›è¡Œ hashã€‚è¿™æ ·å°±èƒ½ç¡®å®šæ¯ä¸ªèŠ‚ç‚¹åœ¨å…¶å“ˆå¸Œç¯ä¸Šçš„ä½ç½®ã€‚<br />æ¥äº†ä¸€ä¸ª keyï¼Œé¦–å…ˆè®¡ç®— hash å€¼ï¼Œå¹¶ç¡®å®šæ­¤æ•°æ®åœ¨ç¯ä¸Šçš„ä½ç½®ï¼Œä»æ­¤ä½ç½®æ²¿ç¯é¡ºæ—¶é’ˆâ€œè¡Œèµ°â€ï¼Œé‡åˆ°çš„ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ï¼ˆé¡ºæ—¶é’ˆç¬¬ä¸€ä¸ªï¼‰å°±æ˜¯ key æ‰€åœ¨ä½ç½®ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659928825281-215bd784-2a8b-4291-b231-f6f867eb9f83.jpeg" alt="" /><br />åœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œå—å½±å“çš„æ•°æ®ä»…ä»…æ˜¯æ­¤èŠ‚ç‚¹åˆ°ç¯ç©ºé—´å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæ²¿ç€é€†æ—¶é’ˆæ–¹å‘è¡Œèµ°é‡åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ä¹‹é—´çš„æ•°æ®ï¼Œå…¶å®ƒä¸å—å½±å“ã€‚å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹ä¹ŸåŒç†ã€‚<br /><strong>ä¸å¹³è¡¡é—®é¢˜ï¼š</strong><br />å¦‚æœä¸Šå›¾ä¸­master-2æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆkey-1ã€key-4ã€key-5éƒ½å°†æ‰“å…¥master-3ï¼Œé€ æˆç¼“å­˜çƒ­ç‚¹é—®é¢˜ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659929026484-dac9cfb5-9d4d-4fe6-928b-1d34284318e4.jpeg" alt="" /></p><h3 id="è™šæ‹ŸèŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#è™šæ‹ŸèŠ‚ç‚¹"></a> è™šæ‹ŸèŠ‚ç‚¹</h3><p>ä¸ºäº†è§£å†³è¿™ç§çƒ­ç‚¹é—®é¢˜ï¼Œä¸€è‡´æ€§ hash ç®—æ³•å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹æœºåˆ¶ï¼Œå³å¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹è®¡ç®—å¤šä¸ª hashï¼Œæ¯ä¸ªè®¡ç®—ç»“æœä½ç½®éƒ½æ”¾ç½®ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ã€‚è¿™æ ·å°±å®ç°äº†æ•°æ®çš„å‡åŒ€åˆ†å¸ƒï¼Œè´Ÿè½½å‡è¡¡ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659930218584-b3278b5f-5d05-4df5-a708-fac9fbd56020.jpeg" alt="" /><br />å¦‚æœï¼Œmaster-3æœºå™¨èŠ‚ç‚¹æŒ‚äº†ï¼Œåˆ™ï¼š</p><ul><li>key-3æ˜ å°„åˆ°v-2-2ï¼Œå³master-2</li><li>key-4æ˜ å°„åˆ°v-1-1ï¼Œå³master-1</li></ul><p>æŸä¸ªèŠ‚ç‚¹å®•æœºä¹‹åï¼Œå­˜å‚¨åŠæµé‡å‹åŠ›å¹¶æ²¡æœ‰å…¨éƒ¨è½¬ç§»åˆ°æŸå°æœºå™¨ä¸Šï¼Œè€Œæ˜¯åˆ†æ•£åˆ°äº†å¤šå°èŠ‚ç‚¹ä¸Šã€‚è§£å†³äº†èŠ‚ç‚¹å®•æœºå¯èƒ½å­˜åœ¨çš„é›ªå´©é—®é¢˜ã€‚<br />å½“ç‰©ç†èŠ‚ç‚¹å¤šçš„æ—¶å€™ï¼Œè™šæ‹ŸèŠ‚ç‚¹å¤šï¼Œè¿™ä¸ªçš„é›ªå´©å¯èƒ½å°±è¶Šå°ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659930425265-99a801ac-ea1f-49e7-a3f7-59fc0a0caf19.jpeg" alt="" /></p><h2 id="redis-hash-slotç®—æ³•"><a class="markdownIt-Anchor" href="#redis-hash-slotç®—æ³•"></a> Redis hash slotç®—æ³•</h2><p>Redis-clusteræ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§hashï¼Œè€Œæ˜¯å¼•å…¥äº†å“ˆå¸Œæ§½çš„æ¦‚å¿µã€‚</p><ul><li>Redis-clusterä¸­æœ‰<strong>16384</strong>(å³2çš„14æ¬¡æ–¹ï¼‰ä¸ªå“ˆå¸Œæ§½ï¼Œæ¯ä¸ªkeyé€šè¿‡<code>CRC16</code>æ ¡éªŒåå¯¹16384å–æ¨¡æ¥å†³å®šæ”¾ç½®å“ªä¸ªæ§½ã€‚Clusterä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†hashæ§½ï¼ˆhash slotï¼‰ã€‚</li><li>Redis cluster ä¸­æ¯ä¸ª master éƒ½ä¼šæŒæœ‰éƒ¨åˆ† slotï¼Œæ¯”å¦‚æœ‰ 3 ä¸ª masterï¼Œé‚£ä¹ˆå¯èƒ½æ¯ä¸ª master æŒæœ‰ 5000 å¤šä¸ª hash slotã€‚</li><li>hash slot è®© node çš„å¢åŠ å’Œç§»é™¤å¾ˆç®€å•ï¼Œå¢åŠ ä¸€ä¸ª masterï¼Œå°±å°†å…¶ä»– master çš„ hash slot ç§»åŠ¨éƒ¨åˆ†è¿‡å»ï¼Œå‡å°‘ä¸€ä¸ª masterï¼Œå°±å°†å®ƒçš„ hash slot ç§»åŠ¨åˆ°å…¶ä»– master ä¸Šå»ã€‚ç§»åŠ¨ hash slot çš„æˆæœ¬æ˜¯éå¸¸ä½çš„ã€‚</li><li>å®¢æˆ·ç«¯çš„ apiï¼Œå¯ä»¥å¯¹æŒ‡å®šçš„æ•°æ®ï¼Œè®©ä»–ä»¬èµ°åŒä¸€ä¸ª hash slotï¼Œé€šè¿‡ <code>hash tag</code> æ¥å®ç°ã€‚</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659942231799-43eb1f7a-f221-410c-b152-c330d328a23a.jpeg" alt="" /><br />å¦‚æœï¼Œmaster-2æŒ‚äº†ï¼Œç›´æ¥å°†master-2ä¸­çš„slotç§»åŠ¨åˆ°master-1ã€master-3å³å¯ã€‚</p><h3 id="ä¸ºä½•16384"><a class="markdownIt-Anchor" href="#ä¸ºä½•16384"></a> ä¸ºä½•16384?</h3><p><a href="https://github.com/redis/redis/issues/2576">https://github.com/redis/redis/issues/2576</a></p><blockquote><p>The reason is:</p><ol><li>Normal heartbeat packets carry the full configuration of a node, that can be replaced in an idempotent way with the old in order to update an old config. This means they contain the slots configuration for a node, in raw form, that uses 2k of space with16k slots, but would use a prohibitive 8k of space using 65k slots.</li><li>At the same time it is unlikely that Redis Cluster would scale to more than 1000 mater nodes because of other design tradeoffs.</li></ol></blockquote><p>So 16k was in the right range to ensure enough slots per master with a max of 1000 maters, but a small enough number to propagate the slot configuration as a raw bitmap easily. Note that in small clusters the bitmap would be hard to compress because when N is small the bitmap would have slots/N bits set that is a large percentage of bits set.</p><p>ä¸»è¦åŸºäºä¸¤ç‚¹è€ƒè™‘ï¼š</p><ol><li><strong>æ¶ˆæ¯å¤§å°</strong>è€ƒè™‘ï¼šå°½ç®¡crc16èƒ½å¾—åˆ°65535ä¸ªå€¼ï¼Œä½†redisé€‰æ‹©16384ä¸ªslotï¼Œæ˜¯å› ä¸º16384çš„æ¶ˆæ¯åªå ç”¨äº†2kï¼Œè€Œ65535åˆ™éœ€è¦8kã€‚</li><li><strong>é›†ç¾¤è§„æ¨¡</strong>è®¾è®¡è€ƒè™‘ï¼šé›†ç¾¤è®¾è®¡æœ€å¤šæ”¯æŒ1000ä¸ªåˆ†ç‰‡ï¼Œ16384æ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½çš„é€‰æ‹©ï¼Œéœ€è¦ä¿è¯åœ¨æœ€å¤§é›†ç¾¤è§„æ¨¡ä¸‹ï¼Œslotå‡åŒ€åˆ†å¸ƒåœºæ™¯ä¸‹ï¼Œæ¯ä¸ªåˆ†ç‰‡å¹³å‡åˆ†åˆ°çš„slotä¸è‡³äºå¤ªå°ã€‚</li></ol><p>éœ€è¦æ³¨æ„2ä¸ªé—®é¢˜ï¼š</p><ol><li>ä¸ºä»€ä¹ˆè¦ä¼ å…¨é‡çš„slotçŠ¶æ€ï¼Ÿ<br />å› ä¸ºåˆ†å¸ƒå¼åœºæ™¯ï¼ŒåŸºäºçŠ¶æ€çš„è®¾è®¡æ›´åˆç†ï¼ŒçŠ¶æ€çš„ä¼ æ’­å…·æœ‰å¹‚ç­‰æ€§</li><li>ä¸ºä»€ä¹ˆä¸è€ƒè™‘å‹ç¼©ï¼Ÿ<br />é›†ç¾¤è§„æ¨¡è¾ƒå°çš„åœºæ™¯ä¸‹ï¼Œæ¯ä¸ªåˆ†ç‰‡è´Ÿè´£å¤§é‡çš„slotï¼Œå¾ˆéš¾å‹ç¼©ã€‚</li></ol><h1 id="4clusteré«˜å¯ç”¨ä¸ä¸»ä»åˆ‡æ¢"><a class="markdownIt-Anchor" href="#4clusteré«˜å¯ç”¨ä¸ä¸»ä»åˆ‡æ¢"></a> 4.Clusteré«˜å¯ç”¨ä¸ä¸»ä»åˆ‡æ¢</h1><blockquote><p>æ—¢ç„¶æ˜¯é›†ç¾¤ï¼Œé‚£masterå°±ä¼šæœ‰å®•æœºé£é™©ï¼Œå¦‚ä½•æ£€æµ‹ï¼Ÿå¦‚ä½•åˆ‡æ¢ä¸»ä»ï¼Ÿ<br />éå¸¸ç±»ä¼¼å“¨å…µé›†ç¾¤æœºåˆ¶ï¼</p></blockquote><h2 id="masterå®•æœºåˆ¤æ–­"><a class="markdownIt-Anchor" href="#masterå®•æœºåˆ¤æ–­"></a> masterå®•æœºåˆ¤æ–­</h2><ul><li>å¦‚æœä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹å®•æœºï¼Œé‚£ä¹ˆå°±æ˜¯ pfail ï¼Œä¸»è§‚å®•æœºã€‚å¦‚æœå¤šä¸ªèŠ‚ç‚¹éƒ½è®¤ä¸ºå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹å®•æœºäº†ï¼Œé‚£ä¹ˆå°±æ˜¯ fail ï¼Œå®¢è§‚å®•æœºï¼Œè·Ÿå“¨å…µçš„åŸç†å‡ ä¹ä¸€æ ·ï¼Œsdownï¼Œodownã€‚</li><li>åœ¨ <code>cluster-node-timeout</code> å†…ï¼ŒæŸä¸ªèŠ‚ç‚¹ä¸€ç›´æ²¡æœ‰è¿”å› pong ï¼Œé‚£ä¹ˆå°±è¢«è®¤ä¸º pfail ã€‚</li><li>å¦‚æœä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºæŸä¸ªèŠ‚ç‚¹ pfail äº†ï¼Œé‚£ä¹ˆä¼šåœ¨ gossip ping æ¶ˆæ¯ä¸­ï¼Œ ping ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå¦‚æœè¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹éƒ½è®¤ä¸º pfail äº†ï¼Œé‚£ä¹ˆå°±ä¼šå˜æˆ fail</li></ul><h2 id="slaveè¿‡æ»¤"><a class="markdownIt-Anchor" href="#slaveè¿‡æ»¤"></a> slaveè¿‡æ»¤</h2><ul><li>å¯¹å®•æœºçš„ master nodeï¼Œä»å…¶æ‰€æœ‰çš„ slave node ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªåˆ‡æ¢æˆ master nodeã€‚</li><li>æ£€æŸ¥æ¯ä¸ª slave node ä¸ master node æ–­å¼€è¿æ¥çš„æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº† cluster-node-timeout * cluster-slave-validity-factor ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰èµ„æ ¼åˆ‡æ¢æˆ master</li></ul><h2 id="slaveé€‰ä¸¾"><a class="markdownIt-Anchor" href="#slaveé€‰ä¸¾"></a> slaveé€‰ä¸¾</h2><ul><li>æ¯ä¸ªä»èŠ‚ç‚¹ï¼Œéƒ½æ ¹æ®è‡ªå·±å¯¹ master å¤åˆ¶æ•°æ®çš„ offsetï¼Œæ¥è®¾ç½®ä¸€ä¸ªé€‰ä¸¾æ—¶é—´ï¼Œoffset è¶Šå¤§ï¼ˆå¤åˆ¶æ•°æ®è¶Šå¤šï¼‰çš„ä»èŠ‚ç‚¹ï¼Œé€‰ä¸¾æ—¶é—´è¶Šé å‰ï¼Œä¼˜å…ˆè¿›è¡Œé€‰ä¸¾ã€‚</li><li>æ‰€æœ‰çš„ master node å¼€å§‹ slave é€‰ä¸¾æŠ•ç¥¨ï¼Œç»™è¦è¿›è¡Œé€‰ä¸¾çš„ slave è¿›è¡ŒæŠ•ç¥¨ï¼Œå¦‚æœå¤§éƒ¨åˆ† master node ï¼ˆ&gt;= N/2 + 1ï¼‰ éƒ½æŠ•ç¥¨ç»™äº†æŸä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆé€‰ä¸¾é€šè¿‡ï¼Œé‚£ä¸ªä»èŠ‚ç‚¹å¯ä»¥åˆ‡æ¢æˆ masterã€‚</li><li>ä»èŠ‚ç‚¹æ‰§è¡Œä¸»å¤‡åˆ‡æ¢ï¼Œä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†ç‰‡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redisé«˜å¯ç”¨-å“¨å…µé›†ç¾¤</title>
    <link href="/2022/08/08/Redis%E9%AB%98%E5%8F%AF%E7%94%A8-%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4/"/>
    <url>/2022/08/08/Redis%E9%AB%98%E5%8F%AF%E7%94%A8-%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h1 id="0-å‰è¨€"><a class="markdownIt-Anchor" href="#0-å‰è¨€"></a> 0. å‰è¨€</h1><p>é™¤äº†ä¸»ä»å¤åˆ¶ï¼ŒRediså¦ä¸€ç§é«˜å¯ç”¨æ–¹æ¡ˆæ˜¯å“¨å…µï¼ˆsentinelï¼‰é›†ç¾¤ã€‚</p><h2 id="å“¨å…µ"><a class="markdownIt-Anchor" href="#å“¨å…µ"></a> å“¨å…µ</h2><p>sentinelï¼Œä¸­æ–‡åæ˜¯å“¨å…µã€‚å“¨å…µæ˜¯ Redis é›†ç¾¤æ¶æ„ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸»è¦æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><strong>é›†ç¾¤ç›‘æ§</strong>ï¼šè´Ÿè´£ç›‘æ§ Redis master å’Œ slave è¿›ç¨‹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼›</li><li><strong>æ¶ˆæ¯é€šçŸ¥</strong>ï¼šå¦‚æœæŸä¸ª Redis å®ä¾‹æœ‰æ•…éšœï¼Œé‚£ä¹ˆå“¨å…µè´Ÿè´£å‘é€æ¶ˆæ¯ä½œä¸ºæŠ¥è­¦é€šçŸ¥ç»™ç®¡ç†å‘˜ï¼›</li><li><strong>æ•…éšœè½¬ç§»</strong>ï¼šå¦‚æœ master node æŒ‚æ‰äº†ï¼Œä¼šè‡ªåŠ¨è½¬ç§»åˆ° slave node ä¸Šï¼›</li><li><strong>é…ç½®ä¸­å¿ƒ</strong>ï¼šå¦‚æœæ•…éšœè½¬ç§»å‘ç”Ÿäº†ï¼Œé€šçŸ¥ client å®¢æˆ·ç«¯æ–°çš„ master åœ°å€</li></ul><p>å…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯masterèŠ‚ç‚¹çš„è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚<br />æ­¤å¤–ï¼Œå“¨å…µç”¨æ¥ä¿è¯Redisé«˜å¯ç”¨ï¼Œæœ¬èº«ä¹Ÿæ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼Œä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒååŒå·¥ä½œã€‚<br />å½“ç„¶ï¼Œä¼šæ¶‰åŠåˆ°<strong>é€‰ä¸¾é—®é¢˜</strong>ï¼š<br />æ•…éšœè½¬ç§»æ—¶ï¼Œåˆ¤æ–­ä¸€ä¸ª master node æ˜¯å¦å®•æœºäº†ï¼Œéœ€è¦å¤§éƒ¨åˆ†çš„å“¨å…µéƒ½åŒæ„æ‰è¡Œã€‚<br /><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p><ul><li>å“¨å…µè‡³å°‘éœ€è¦ 3 ä¸ªå®ä¾‹ï¼Œæ¥ä¿è¯è‡ªå·±çš„å¥å£®æ€§</li><li>å“¨å…µ + Redis ä¸»ä»çš„éƒ¨ç½²æ¶æ„ï¼Œæ˜¯ä¸ä¿è¯æ•°æ®é›¶ä¸¢å¤±çš„ï¼Œåªèƒ½ä¿è¯ Redis é›†ç¾¤çš„é«˜å¯ç”¨æ€§</li><li>å¯¹äºå“¨å…µ + Redis ä¸»ä»è¿™ç§å¤æ‚çš„éƒ¨ç½²æ¶æ„ï¼Œå°½é‡åœ¨æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼Œéƒ½è¿›è¡Œå……è¶³çš„æµ‹è¯•å’Œæ¼”ç»ƒ</li></ul><h2 id="rediså“¨å…µé›†ç¾¤ä¸»ä»æ¶æ„"><a class="markdownIt-Anchor" href="#rediså“¨å…µé›†ç¾¤ä¸»ä»æ¶æ„"></a> Rediså“¨å…µé›†ç¾¤+ä¸»ä»æ¶æ„</h2><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659886866384-e5e52583-3a51-4cf8-a6f9-014fb8eb68e1.jpeg" alt="" /></p><h1 id="1å“¨å…µé›†ç¾¤ç»„å»º"><a class="markdownIt-Anchor" href="#1å“¨å…µé›†ç¾¤ç»„å»º"></a> 1.å“¨å…µé›†ç¾¤ç»„å»º</h1><blockquote><p>å“¨å…µé›†ç¾¤å¦‚ä½•ç»„å»ºï¼Ÿ<br />åŸºäºRedisçš„Pub/Subæœºåˆ¶</p></blockquote><p>ä¾‹å¦‚ï¼š<br />åœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼Œä¸»åº“ä¸Šæœ‰ä¸€ä¸ªåä¸º<code>__sentinel__:hello</code>çš„é¢‘é“ï¼Œä¸åŒå“¨å…µå°±æ˜¯é€šè¿‡å®ƒæ¥ç›¸äº’å‘ç°ï¼Œå®ç°äº’ç›¸é€šä¿¡çš„ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œå“¨å…µ 1 æŠŠè‡ªå·±çš„ IPï¼ˆ172.16.19.3ï¼‰å’Œç«¯å£ï¼ˆ26579ï¼‰å‘å¸ƒåˆ°<code>__sentinel__:hello</code>é¢‘é“ä¸Šï¼Œå“¨å…µ 2 å’Œ 3 è®¢é˜…äº†è¯¥é¢‘é“ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå“¨å…µ 2 å’Œ 3 å°±å¯ä»¥ä»è¿™ä¸ªé¢‘é“ç›´æ¥è·å–å“¨å…µ 1 çš„ IP åœ°å€å’Œç«¯å£å·ã€‚ç„¶åï¼Œå“¨å…µ 2ã€3 å¯ä»¥å’Œå“¨å…µ 1 å»ºç«‹ç½‘ç»œè¿æ¥ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659887028961-ddd53af1-647e-460f-bbf1-fe78b3a3e566.jpeg#clientId=u527f9151-2b34-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;id=uafd6da26&amp;margin=%5Bobject%20Object%5D&amp;originHeight=1535&amp;originWidth=2822&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=udaa4b0e1-fdaa-4a45-87ec-ae44fc95abd&amp;title=" alt="" /><br />é€šè¿‡è¿™ä¸ªæ–¹å¼ï¼Œå“¨å…µ 2 å’Œ 3 ä¹Ÿå¯ä»¥å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå“¨å…µé›†ç¾¤å°±å½¢æˆäº†ã€‚å®ƒä»¬ç›¸äº’é—´å¯ä»¥é€šè¿‡ç½‘ç»œè¿æ¥è¿›è¡Œé€šä¿¡ï¼Œæ¯”å¦‚è¯´å¯¹ä¸»åº“æœ‰æ²¡æœ‰ä¸‹çº¿è¿™ä»¶äº‹å„¿è¿›è¡Œåˆ¤æ–­å’Œåå•†ã€‚</p><h1 id="2å“¨å…µçš„ç›‘æ§åŠŸèƒ½"><a class="markdownIt-Anchor" href="#2å“¨å…µçš„ç›‘æ§åŠŸèƒ½"></a> 2.å“¨å…µçš„ç›‘æ§åŠŸèƒ½</h1><blockquote><p>å“¨å…µç›‘æ§ä»€ä¹ˆï¼Ÿå¦‚ä½•ç›‘æ§ï¼Ÿ<br />ç”±å“¨å…µå‘ä¸»åº“å‘é€ INFO å‘½ä»¤æ¥å®Œæˆçš„</p></blockquote><p>å“¨å…µ 2 ç»™ä¸»åº“å‘é€ <code>INFO</code> å‘½ä»¤ï¼Œä¸»åº“æ¥å—åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæŠŠä»åº“åˆ—è¡¨è¿”å›ç»™å“¨å…µã€‚æ¥ç€ï¼Œå“¨å…µå°±å¯ä»¥æ ¹æ®ä»åº“åˆ—è¡¨ä¸­çš„è¿æ¥ä¿¡æ¯ï¼Œå’Œæ¯ä¸ªä»åº“å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨è¿™ä¸ªè¿æ¥ä¸ŠæŒç»­åœ°å¯¹ä»åº“è¿›è¡Œç›‘æ§ã€‚å“¨å…µ 1 å’Œ 3 å¯ä»¥é€šè¿‡ç›¸åŒçš„æ–¹æ³•å’Œä»åº“å»ºç«‹è¿æ¥ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659887158109-d96ede17-0672-4c18-abe5-4907d717180d.jpeg#clientId=u527f9151-2b34-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;id=u4c0d1a6d&amp;margin=%5Bobject%20Object%5D&amp;originHeight=1404&amp;originWidth=2499&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=uf62a9fe6-5fff-4ded-b85b-4ac35899be4&amp;title=" alt="" /></p><h1 id="3masterä¸‹çº¿åˆ¤å®š"><a class="markdownIt-Anchor" href="#3masterä¸‹çº¿åˆ¤å®š"></a> 3.masterä¸‹çº¿åˆ¤å®š</h1><p>é¦–å…ˆï¼Œæœ‰ä¸¤ä¸ªâ€œä¸‹çº¿â€æ¦‚å¿µï¼š</p><ul><li>ä¸»è§‚ä¸‹çº¿ï¼ˆsdownï¼‰ï¼šä»»ä½•ä¸€ä¸ªå“¨å…µéƒ½æ˜¯å¯ä»¥ç›‘æ§æ¢æµ‹ï¼Œå¹¶ä½œå‡ºmasterä¸‹çº¿çš„åˆ¤æ–­</li><li>å®¢è§‚ä¸‹çº¿ï¼ˆodownï¼‰ï¼šç”±å“¨å…µé›†ç¾¤æŠ•ç¥¨å…±åŒå†³å®šmasteræ˜¯å¦ä¸‹çº¿</li></ul><p>å…·ä½“åœ°ï¼š<br />å¦‚æœæŸä¸ªå“¨å…µï¼ˆå¦‚ä¸‹å›¾ä¸­çš„å“¨å…µ2ï¼‰<code>ping</code>ä¸€ä¸ª masterï¼Œè¶…è¿‡äº† <code>is-master-down-after-milliseconds</code> æŒ‡å®šçš„æ¯«ç§’æ•°ä¹‹åï¼Œå°±ä¸»è§‚è®¤ä¸º master å®•æœºäº†ï¼Œå³â€œä¸»è§‚ä¸‹çº¿â€ï¼Œå°±ä¼šç»™å…¶ä»–å“¨å…µå‘é€ <code>is-master-down-by-addr</code> å‘½ä»¤ï¼›<br />å¦‚æœè¿™ä¸ªå“¨å…µåœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œæ”¶åˆ°äº† <code>quorum</code>æ•°é‡çš„å…¶å®ƒå“¨å…µä¹Ÿè®¤ä¸ºé‚£ä¸ª master æ˜¯ sdown çš„ï¼ˆæŠ•ç¥¨ï¼‰ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºæ˜¯ odown äº†ï¼Œå³â€œå®¢è§‚ä¸‹çº¿â€<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659887409319-51f869e0-2d3e-4c23-adea-96b8e69343a0.jpeg#clientId=u527f9151-2b34-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;id=u884d1199&amp;margin=%5Bobject%20Object%5D&amp;originHeight=1260&amp;originWidth=2322&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u670d14b7-8575-4d7b-9bd0-76df8653404&amp;title=" alt="" /><br />å¦‚æœèµæˆç¥¨æ•°ï¼ˆè¿™é‡Œæ˜¯2ï¼‰æ˜¯å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum é…ç½®é¡¹ï¼ˆæ¯”å¦‚è¿™é‡Œå¦‚æœæ˜¯quorum=2ï¼‰, åˆ™å¯ä»¥åˆ¤å®šä¸»åº“å®¢è§‚ä¸‹çº¿äº†ã€‚</p><h1 id="4å“¨å…µé›†ç¾¤é€‰ä¸¾"><a class="markdownIt-Anchor" href="#4å“¨å…µé›†ç¾¤é€‰ä¸¾"></a> 4.å“¨å…µé›†ç¾¤é€‰ä¸¾</h1><blockquote><p>åˆ¤å®šmasterå®¢è§‚ä¸‹çº¿ä¹‹åï¼Œç”±å“ªä¸ªå“¨å…µèŠ‚ç‚¹æ‰§è¡Œä¸»ä»åˆ‡æ¢ï¼Ÿ<br />é€šè¿‡é€‰ä¸¾ã€‚</p></blockquote><h2 id="ä¸ºä»€ä¹ˆå¿…ç„¶ä¼šå‡ºç°é€‰ä¸¾å…±è¯†æœºåˆ¶"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆå¿…ç„¶ä¼šå‡ºç°é€‰ä¸¾å…±è¯†æœºåˆ¶"></a> ä¸ºä»€ä¹ˆå¿…ç„¶ä¼šå‡ºç°é€‰ä¸¾/å…±è¯†æœºåˆ¶ï¼Ÿ</h2><p>ä¸ºäº†é¿å…å“¨å…µçš„å•ç‚¹æƒ…å†µå‘ç”Ÿï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå“¨å…µçš„åˆ†å¸ƒå¼é›†ç¾¤ã€‚ä½œä¸ºåˆ†å¸ƒå¼é›†ç¾¤ï¼Œå¿…ç„¶æ¶‰åŠå…±è¯†é—®é¢˜ï¼ˆå³é€‰ä¸¾é—®é¢˜ï¼‰ï¼›åŒæ—¶æ•…éšœçš„è½¬ç§»å’Œé€šçŸ¥éƒ½åªéœ€è¦ä¸€ä¸ªä¸»çš„å“¨å…µèŠ‚ç‚¹å°±å¯ä»¥äº†ã€‚</p><h2 id="å“¨å…µçš„é€‰ä¸¾æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„"><a class="markdownIt-Anchor" href="#å“¨å…µçš„é€‰ä¸¾æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„"></a> å“¨å…µçš„é€‰ä¸¾æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h2><p>å“¨å…µçš„é€‰ä¸¾æœºåˆ¶å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªRafté€‰ä¸¾ç®—æ³•ï¼š <strong>é€‰ä¸¾çš„ç¥¨æ•°å¤§äºç­‰äºnum(sentinels)/2+1æ—¶ï¼Œå°†æˆä¸ºé¢†å¯¼è€…ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œç»§ç»­é€‰ä¸¾</strong></p><h2 id="ä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º-leader-çš„å“¨å…µè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶"><a class="markdownIt-Anchor" href="#ä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º-leader-çš„å“¨å…µè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶"></a> ä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º Leader çš„å“¨å…µï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</h2><ul><li>ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›</li><li>ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼</li></ul><h1 id="5æ–°masterçš„é€‰ä¸¾"><a class="markdownIt-Anchor" href="#5æ–°masterçš„é€‰ä¸¾"></a> 5.æ–°masterçš„é€‰ä¸¾</h1><blockquote><p>é‚£ä¹ˆï¼Œå¯ä»¥å¼€å§‹ä¸»ä»åˆ‡æ¢äº†ã€‚é€‰ä¸€ä¸ªslaveèŠ‚ç‚¹ä¸Šä½master</p></blockquote><h2 id="quorum-å’Œ-majority"><a class="markdownIt-Anchor" href="#quorum-å’Œ-majority"></a> quorum å’Œ majority</h2><p>æ¯æ¬¡ä¸€ä¸ªå“¨å…µè¦åšä¸»å¤‡åˆ‡æ¢ï¼Œé¦–å…ˆéœ€è¦ quorum æ•°é‡çš„å“¨å…µè®¤ä¸º odownï¼Œç„¶åé€‰ä¸¾å‡ºä¸€ä¸ªå“¨å…µæ¥åšåˆ‡æ¢ï¼Œè¿™ä¸ªå“¨å…µè¿˜éœ€è¦å¾—åˆ° majority å“¨å…µçš„æˆæƒï¼Œæ‰èƒ½æ­£å¼æ‰§è¡Œåˆ‡æ¢ã€‚<br />å¦‚æœ quorum &lt; majorityï¼Œæ¯”å¦‚ 5 ä¸ªå“¨å…µï¼Œmajority å°±æ˜¯ 3ï¼Œquorum è®¾ç½®ä¸º 2ï¼Œé‚£ä¹ˆå°± 3 ä¸ªå“¨å…µæˆæƒå°±å¯ä»¥æ‰§è¡Œåˆ‡æ¢ã€‚<br />ä½†æ˜¯å¦‚æœ quorum &gt;= majorityï¼Œé‚£ä¹ˆå¿…é¡» quorum æ•°é‡çš„å“¨å…µéƒ½æˆæƒï¼Œæ¯”å¦‚ 5 ä¸ªå“¨å…µï¼Œquorum æ˜¯ 5ï¼Œé‚£ä¹ˆå¿…é¡» 5 ä¸ªå“¨å…µéƒ½åŒæ„æˆæƒï¼Œæ‰èƒ½æ‰§è¡Œåˆ‡æ¢ã€‚</p><p>å¦‚æœä¸€ä¸ª master è¢«è®¤ä¸º odown äº†ï¼Œè€Œä¸” <code>majority</code> æ•°é‡çš„å“¨å…µéƒ½å…è®¸ä¸»å¤‡åˆ‡æ¢ï¼Œé‚£ä¹ˆæŸä¸ªå“¨å…µå°±ä¼šæ‰§è¡Œä¸»å¤‡åˆ‡æ¢æ“ä½œï¼Œæ­¤æ—¶é¦–å…ˆè¦é€‰ä¸¾ä¸€ä¸ª slave æ¥ï¼Œä¼šè€ƒè™‘ slave çš„ä¸€äº›ä¿¡æ¯ï¼š</p><ul><li>è·Ÿ master æ–­å¼€è¿æ¥çš„æ—¶é•¿</li><li>slave ä¼˜å…ˆçº§</li><li>å¤åˆ¶ offset</li><li>run id</li></ul><h2 id="è¿‡æ»¤æ‰ä¸åˆé€‚çš„slave"><a class="markdownIt-Anchor" href="#è¿‡æ»¤æ‰ä¸åˆé€‚çš„slave"></a> è¿‡æ»¤æ‰ä¸åˆé€‚çš„slave</h2><p>å¦‚æœä¸€ä¸ª slave è·Ÿ master æ–­å¼€è¿æ¥çš„æ—¶é—´å·²ç»è¶…è¿‡äº† <code>down-after-milliseconds</code> çš„ 10 å€ï¼Œå¤–åŠ  master å®•æœºçš„æ—¶é•¿ï¼Œé‚£ä¹ˆ slave å°±è¢«è®¤ä¸ºä¸é€‚åˆé€‰ä¸¾ä¸º master</p><h2 id="å¯¹å‰©ä¸‹çš„slaveæ’åº"><a class="markdownIt-Anchor" href="#å¯¹å‰©ä¸‹çš„slaveæ’åº"></a> å¯¹å‰©ä¸‹çš„slaveæ’åº</h2><ul><li>æŒ‰ç…§ slave ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼Œslave priority è¶Šä½ï¼Œä¼˜å…ˆçº§å°±è¶Šé«˜ã€‚</li><li>å¦‚æœ slave priority ç›¸åŒï¼Œé‚£ä¹ˆçœ‹ replica offsetï¼Œå“ªä¸ª slave å¤åˆ¶äº†è¶Šå¤šçš„æ•°æ®ï¼Œoffset è¶Šé åï¼Œä¼˜å…ˆçº§å°±è¶Šé«˜ã€‚</li><li>å¦‚æœä¸Šé¢ä¸¤ä¸ªæ¡ä»¶éƒ½ç›¸åŒï¼Œé‚£ä¹ˆé€‰æ‹©ä¸€ä¸ª run id æ¯”è¾ƒå°çš„é‚£ä¸ª slaveã€‚</li></ul><h1 id="6æ•…éšœè½¬ç§»"><a class="markdownIt-Anchor" href="#6æ•…éšœè½¬ç§»"></a> 6.æ•…éšœè½¬ç§»</h1><blockquote><p>æ–°çš„masteré€‰å‡ºæ¥ä¹‹åï¼Œå°±å¯ä»¥è¿›è¡Œæ•…éšœè½¬ç§»äº†</p></blockquote><p>å‡è®¾ï¼šåˆ¤æ–­ä¸»åº“å®¢è§‚ä¸‹çº¿äº†ï¼ŒåŒæ—¶é€‰å‡ºsentinel 3æ˜¯å“¨å…µleaderã€‚<br />å°†slave-1è„±ç¦»åŸä»èŠ‚ç‚¹ï¼ˆPS: 5.0 ä¸­åº”è¯¥æ˜¯replicaof no one)ï¼Œå‡çº§ä¸»èŠ‚ç‚¹ï¼Œ å°†ä»èŠ‚ç‚¹slave-2æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹å·²æ›´æ¢ å°†åŸä¸»èŠ‚ç‚¹ï¼ˆoldMasterï¼‰å˜æˆä»èŠ‚ç‚¹ï¼ŒæŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹</p><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659889986517-4e98c49f-7490-466c-b321-c2d3cef23bea.jpeg" alt="" /><br /><a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-sentinel.html"><br /></a></p><ul><li>å°†slave-1è„±ç¦»åŸä»èŠ‚ç‚¹ï¼ˆPS: 5.0 ä¸­åº”è¯¥æ˜¯<code>replicaof no one</code>)ï¼Œå‡çº§ä¸ºä¸»èŠ‚ç‚¹</li><li>å°†ä»èŠ‚ç‚¹slave-2æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹</li><li>é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹å·²æ›´æ¢</li><li>å°†åŸä¸»èŠ‚ç‚¹ï¼ˆoldMasterï¼‰å˜æˆä»èŠ‚ç‚¹ï¼ŒæŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹</li></ul><p>è½¬ç§»è¿‡åï¼š<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659889857469-1dff90fd-11b2-4596-bb58-71c1da4d229a.jpeg" alt="" /></p><h1 id="æ•°æ®ä¸¢å¤±é—®é¢˜"><a class="markdownIt-Anchor" href="#æ•°æ®ä¸¢å¤±é—®é¢˜"></a> æ•°æ®ä¸¢å¤±é—®é¢˜ï¼Ÿ</h1><h2 id="å¼‚æ­¥å¤åˆ¶å¯¼è‡´çš„ä¸¢å¤±"><a class="markdownIt-Anchor" href="#å¼‚æ­¥å¤åˆ¶å¯¼è‡´çš„ä¸¢å¤±"></a> å¼‚æ­¥å¤åˆ¶å¯¼è‡´çš„ä¸¢å¤±</h2><p>å› ä¸º master-&gt;slave çš„å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å¯èƒ½æœ‰éƒ¨åˆ†æ•°æ®è¿˜æ²¡å¤åˆ¶åˆ° slaveï¼Œmaster å°±å®•æœºäº†ï¼Œæ­¤æ—¶è¿™éƒ¨åˆ†æ•°æ®å°±ä¸¢å¤±äº†</p><h2 id="è„‘è£‚å¯¼è‡´çš„æ•°æ®ä¸¢å¤±"><a class="markdownIt-Anchor" href="#è„‘è£‚å¯¼è‡´çš„æ•°æ®ä¸¢å¤±"></a> è„‘è£‚å¯¼è‡´çš„æ•°æ®ä¸¢å¤±</h2><p>è„‘è£‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒæŸä¸ª master æ‰€åœ¨æœºå™¨çªç„¶è„±ç¦»äº†æ­£å¸¸çš„ç½‘ç»œï¼Œè·Ÿå…¶ä»– slave æœºå™¨ä¸èƒ½è¿æ¥ï¼Œä½†æ˜¯å®é™…ä¸Š master è¿˜è¿è¡Œç€ã€‚æ­¤æ—¶å“¨å…µå¯èƒ½å°±ä¼šè®¤ä¸º master å®•æœºäº†ï¼Œç„¶åå¼€å¯é€‰ä¸¾ï¼Œå°†å…¶ä»– slave åˆ‡æ¢æˆäº† masterã€‚è¿™ä¸ªæ—¶å€™ï¼Œ**é›†ç¾¤é‡Œå°±ä¼šæœ‰ä¸¤ä¸ª master **ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„è„‘è£‚ã€‚<br />æ­¤æ—¶è™½ç„¶æŸä¸ª slave è¢«åˆ‡æ¢æˆäº† masterï¼Œä½†æ˜¯å¯èƒ½ client è¿˜æ²¡æ¥å¾—åŠåˆ‡æ¢åˆ°æ–°çš„ masterï¼Œè¿˜ç»§ç»­å‘æ—§ master å†™æ•°æ®ã€‚å› æ­¤æ—§ master å†æ¬¡æ¢å¤çš„æ—¶å€™ï¼Œä¼šè¢«ä½œä¸ºä¸€ä¸ª slave æŒ‚åˆ°æ–°çš„ master ä¸Šå»ï¼Œè‡ªå·±çš„æ•°æ®ä¼šæ¸…ç©ºï¼Œé‡æ–°ä»æ–°çš„ master å¤åˆ¶æ•°æ®ã€‚è€Œæ–°çš„ master å¹¶æ²¡æœ‰åæ¥ client å†™å…¥çš„æ•°æ®ï¼Œå› æ­¤ï¼Œè¿™éƒ¨åˆ†æ•°æ®ä¹Ÿå°±ä¸¢å¤±äº†ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#è§£å†³æ–¹æ¡ˆ"></a> è§£å†³æ–¹æ¡ˆ</h2><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">min-slaves-to-write 1&#x2F;&#x2F; è¦æ±‚è‡³å°‘æœ‰ 1 ä¸ª slavemin-slaves-max-lag 10&#x2F;&#x2F; æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿä¸èƒ½è¶…è¿‡ 10 ç§’<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div><p>æœ‰äº† <code>min-slaves-max-lag</code> è¿™ä¸ªé…ç½®ï¼Œå°±å¯ä»¥ç¡®ä¿ï¼Œä¸€æ—¦ slave å¤åˆ¶æ•°æ®å’Œ ack å»¶æ—¶å¤ªé•¿ï¼Œå°±è®¤ä¸ºå¯èƒ½ master å®•æœºåæŸå¤±çš„æ•°æ®å¤ªå¤šäº†ï¼Œé‚£ä¹ˆå°±æ‹’ç»å†™è¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥æŠŠ master å®•æœºæ—¶ç”±äºéƒ¨åˆ†æ•°æ®æœªåŒæ­¥åˆ° slave å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é™ä½çš„å¯æ§èŒƒå›´å†…ã€‚<br />å¦‚æœä¸€ä¸ª master å‡ºç°äº†è„‘è£‚ï¼Œè·Ÿå…¶ä»– slave ä¸¢äº†è¿æ¥ï¼Œé‚£ä¹ˆä¸Šé¢ä¸¤ä¸ªé…ç½®å¯ä»¥ç¡®ä¿ï¼Œå¦‚æœä¸èƒ½ç»§ç»­ç»™æŒ‡å®šæ•°é‡çš„ slave å‘é€æ•°æ®ï¼Œè€Œä¸” slave è¶…è¿‡ 10 ç§’æ²¡æœ‰ç»™è‡ªå·± ack æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥æ‹’ç»å®¢æˆ·ç«¯çš„å†™è¯·æ±‚ã€‚å› æ­¤åœ¨è„‘è£‚åœºæ™¯ä¸‹ï¼Œæœ€å¤šå°±ä¸¢å¤± 10 ç§’çš„æ•°æ®ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡ç« "></a> å‚è€ƒæ–‡ç« </h1><ul><li><a href="https://doocs.github.io/advanced-java/#/docs/high-concurrency/redis-sentinel">https://doocs.github.io/advanced-java/#/docs/high-concurrency/redis-sentinel</a></li><li><a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-sentinel.html">https://pdai.tech/md/db/nosql-redis/db-redis-x-sentinel.html</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å“¨å…µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redisé«˜å¯ç”¨-ä¸»ä»å¤åˆ¶</title>
    <link href="/2022/08/07/Redis%E9%AB%98%E5%8F%AF%E7%94%A8-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"/>
    <url>/2022/08/07/Redis%E9%AB%98%E5%8F%AF%E7%94%A8-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h1 id="0å‰è¨€"><a class="markdownIt-Anchor" href="#0å‰è¨€"></a> 0.å‰è¨€</h1><h2 id="å¦‚ä½•ä¿è¯redisé«˜å¯ç”¨"><a class="markdownIt-Anchor" href="#å¦‚ä½•ä¿è¯redisé«˜å¯ç”¨"></a> å¦‚ä½•ä¿è¯Redisé«˜å¯ç”¨ï¼Ÿ</h2><p>é«˜å¯ç”¨HAï¼ˆHigh Availabilityï¼‰æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸­å¿…é¡»è€ƒè™‘çš„å› ç´ ä¹‹ä¸€ï¼Œå®ƒé€šå¸¸æ˜¯æŒ‡ï¼Œé€šè¿‡è®¾è®¡<strong>å‡å°‘ç³»ç»Ÿä¸èƒ½æä¾›æœåŠ¡çš„æ—¶é—´</strong>ï¼ˆæ¯”å¦‚serverå®•æœºã€ç½‘ç»œæ–­è”ç­‰ï¼‰ã€‚<br />Redisä¸»è¦æä¾›ä¸€ä¸»å¤šä»ä¸‹çš„ä¸»ä»å¤åˆ¶å’Œå“¨å…µé›†ç¾¤æœºåˆ¶ä¿è¯é«˜å¯ç”¨ã€‚</p><h2 id="redisä¸»ä»æ¶æ„"><a class="markdownIt-Anchor" href="#redisä¸»ä»æ¶æ„"></a> Redisä¸»ä»æ¶æ„</h2><p>å•æœºçš„ Redisï¼Œèƒ½å¤Ÿæ‰¿è½½çš„ QPS å¤§æ¦‚å°±åœ¨ä¸Šä¸‡åˆ°å‡ ä¸‡ä¸ç­‰ã€‚å¯¹äºç¼“å­˜æ¥è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥æ”¯æ’‘è¯»é«˜å¹¶å‘çš„ã€‚<br />å› æ­¤æ¶æ„åšæˆä¸»ä»(master-slave)æ¶æ„ï¼Œ<strong>ä¸€ä¸»å¤šä»ï¼Œä¸»è´Ÿè´£å†™ï¼Œå¹¶ä¸”å°†æ•°æ®å¤åˆ¶åˆ°å…¶å®ƒçš„ slave èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»</strong>ã€‚æ‰€æœ‰çš„è¯»è¯·æ±‚å…¨éƒ¨èµ°ä»èŠ‚ç‚¹ã€‚è¿™æ ·ä¹Ÿå¯ä»¥å¾ˆè½»æ¾å®ç°æ°´å¹³æ‰©å®¹ï¼Œæ”¯æ’‘è¯»é«˜å¹¶å‘ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659797238827-959ffbe3-7fcb-4b35-bf68-d392c43383aa.jpeg" alt="" /></p><h2 id="è¯»å†™åˆ†ç¦»"><a class="markdownIt-Anchor" href="#è¯»å†™åˆ†ç¦»"></a> è¯»å†™åˆ†ç¦»</h2><p>è¯»æ“ä½œï¼šä¸»åº“ã€ä»åº“éƒ½å¯ä»¥æ¥æ”¶ï¼›<br />å†™æ“ä½œï¼šé¦–å…ˆåˆ°ä¸»åº“æ‰§è¡Œï¼Œç„¶åï¼Œä¸»åº“å°†å†™æ“ä½œåŒæ­¥ç»™ä»åº“</p><h2 id="ä¸»ä»å¤åˆ¶"><a class="markdownIt-Anchor" href="#ä¸»ä»å¤åˆ¶"></a> ä¸»ä»å¤åˆ¶</h2><blockquote><p>ä¸»ä»å¤åˆ¶ï¼Œæ˜¯å°†ä¸€å°RedisæœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„RedisæœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸ºä¸»èŠ‚ç‚¹(master)ï¼Œåè€…ç§°ä¸ºä»èŠ‚ç‚¹(slave)ã€‚<br />æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ç”±ä¸»èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹ã€‚</p></blockquote><h3 id="ä½œç”¨"><a class="markdownIt-Anchor" href="#ä½œç”¨"></a> ä½œç”¨</h3><ul><li><strong>æ•°æ®å†—ä½™</strong>ï¼šä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼</li><li><strong>æ•…éšœæ¢å¤</strong>ï¼šå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ï¼›å®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå³å†™Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¯»Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä»èŠ‚ç‚¹ï¼‰ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼›å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡</li><li><strong>é«˜å¯ç”¨åŸºçŸ³</strong>ï¼šé™¤äº†ä¸Šè¿°ä½œç”¨ä»¥å¤–ï¼Œä¸»ä»å¤åˆ¶è¿˜æ˜¯å“¨å…µå’Œé›†ç¾¤èƒ½å¤Ÿå®æ–½çš„åŸºç¡€ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€</li></ul><h1 id="1ä¸»ä»å¤åˆ¶å®ç°åŸç†"><a class="markdownIt-Anchor" href="#1ä¸»ä»å¤åˆ¶å®ç°åŸç†"></a> 1.ä¸»ä»å¤åˆ¶å®ç°åŸç†</h1><blockquote><p>Redisåœ¨V2.8ä¹‹å‰ä»…æ”¯æŒå…¨é‡å¤åˆ¶</p></blockquote><ul><li>å…¨é‡ï¼ˆåŒæ­¥ï¼‰å¤åˆ¶ï¼šæ¯”å¦‚åœ¨ç¬¬ä¸€æ¬¡åŒæ­¥æ—¶</li><li>å¢é‡ï¼ˆåŒæ­¥ï¼‰å¤åˆ¶ï¼šåªä¼šæŠŠä¸»ä»åº“ç½‘ç»œæ–­è¿æœŸé—´ä¸»åº“æ”¶åˆ°çš„å‘½ä»¤ï¼ŒåŒæ­¥ç»™ä»åº“</li></ul><h2 id="å…¨é‡å¤åˆ¶"><a class="markdownIt-Anchor" href="#å…¨é‡å¤åˆ¶"></a> å…¨é‡å¤åˆ¶</h2><h3 id="å¤§è‡´è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#å¤§è‡´è¿‡ç¨‹"></a> å¤§è‡´è¿‡ç¨‹</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659797918729-0d449448-56f4-4fdd-aad3-5de9023ba48f.jpeg" alt="" /></p><h3 id="å…·ä½“è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#å…·ä½“è¿‡ç¨‹"></a> å…·ä½“è¿‡ç¨‹</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659799559978-6b827237-2581-487b-bbf6-f3f3eaf49a2b.jpeg" alt="" /></p><p><strong>ç¬¬ä¸€é˜¶æ®µ</strong>ï¼š<br />ä¸»ä»åº“é—´å»ºç«‹è¿æ¥ã€åå•†åŒæ­¥ï¼Œä¸»è¦æ˜¯ä¸ºå…¨é‡å¤åˆ¶åšå‡†å¤‡ã€‚åœ¨è¿™ä¸€æ­¥ï¼Œä»åº“å’Œä¸»åº“å»ºç«‹èµ·è¿æ¥ï¼Œå¹¶å‘Šè¯‰ä¸»åº“å³å°†è¿›è¡ŒåŒæ­¥ï¼Œä¸»åº“ç¡®è®¤å›å¤åï¼Œä¸»ä»åº“é—´å°±å¯ä»¥å¼€å§‹åŒæ­¥äº†ã€‚<br />å…·ä½“æ¥è¯´ï¼Œä»åº“ç»™ä¸»åº“å‘é€ PSYNC å‘½ä»¤ï¼Œè¡¨ç¤ºè¦è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œä¸»åº“æ ¹æ®è¿™ä¸ªå‘½ä»¤çš„å‚æ•°æ¥å¯åŠ¨å¤åˆ¶ã€‚PSYNC å‘½ä»¤åŒ…å«äº†ä¸»åº“çš„ runID å’Œå¤åˆ¶è¿›åº¦ offset ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li>runIDï¼Œæ˜¯æ¯ä¸ª Redis å®ä¾‹å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆçš„ä¸€ä¸ªéšæœº IDï¼Œç”¨æ¥å”¯ä¸€æ ‡è®°è¿™ä¸ªå®ä¾‹ã€‚å½“ä»åº“å’Œä¸»åº“ç¬¬ä¸€æ¬¡å¤åˆ¶æ—¶ï¼Œå› ä¸ºä¸çŸ¥é“ä¸»åº“çš„ runIDï¼Œæ‰€ä»¥å°† runID è®¾ä¸ºâ€œï¼Ÿâ€ï¼›</li><li>offsetï¼Œæ­¤æ—¶è®¾ä¸º -1ï¼Œè¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶ã€‚</li></ul><p>ä¸»åº“æ”¶åˆ° PSYNC å‘½ä»¤åï¼Œä¼šç”¨ FULLRESYNC å“åº”å‘½ä»¤å¸¦ä¸Šä¸¤ä¸ªå‚æ•°ï¼šä¸»åº“ runID å’Œä¸»åº“ç›®å‰çš„å¤åˆ¶è¿›åº¦ offsetï¼Œè¿”å›ç»™ä»åº“ã€‚ä»åº“æ”¶åˆ°å“åº”åï¼Œä¼šè®°å½•ä¸‹è¿™ä¸¤ä¸ªå‚æ•°ã€‚è¿™é‡Œæœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼ŒFULLRESYNC å“åº”è¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶é‡‡ç”¨çš„å…¨é‡å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»åº“ä¼šæŠŠå½“å‰æ‰€æœ‰çš„æ•°æ®éƒ½å¤åˆ¶ç»™ä»åº“ã€‚<br /><strong>ç¬¬äºŒé˜¶æ®µ</strong>ï¼š<br />ä¸»åº“å°†æ‰€æœ‰æ•°æ®åŒæ­¥ç»™ä»åº“ã€‚ä»åº“æ”¶åˆ°æ•°æ®åï¼Œåœ¨æœ¬åœ°å®Œæˆæ•°æ®åŠ è½½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¾èµ–äºå†…å­˜å¿«ç…§ç”Ÿæˆçš„ RDB æ–‡ä»¶ã€‚<br />å…·ä½“æ¥è¯´ï¼Œä¸»åº“æ‰§è¡Œ bgsave å‘½ä»¤ï¼Œç”Ÿæˆ RDB æ–‡ä»¶ï¼Œæ¥ç€å°†æ–‡ä»¶å‘ç»™ä»åº“ã€‚ä»åº“æ¥æ”¶åˆ° RDB æ–‡ä»¶åï¼Œä¼šå…ˆæ¸…ç©ºå½“å‰æ•°æ®åº“ï¼Œç„¶ååŠ è½½ RDB æ–‡ä»¶ã€‚è¿™æ˜¯å› ä¸ºä»åº“åœ¨é€šè¿‡ replicaof å‘½ä»¤å¼€å§‹å’Œä¸»åº“åŒæ­¥å‰ï¼Œå¯èƒ½ä¿å­˜äº†å…¶ä»–æ•°æ®ã€‚ä¸ºäº†é¿å…ä¹‹å‰æ•°æ®çš„å½±å“ï¼Œä»åº“éœ€è¦å…ˆæŠŠå½“å‰æ•°æ®åº“æ¸…ç©ºã€‚åœ¨ä¸»åº“å°†æ•°æ®åŒæ­¥ç»™ä»åº“çš„è¿‡ç¨‹ä¸­ï¼Œä¸»åº“ä¸ä¼šè¢«é˜»å¡ï¼Œä»ç„¶å¯ä»¥æ­£å¸¸æ¥æ”¶è¯·æ±‚ã€‚å¦åˆ™ï¼ŒRedis çš„æœåŠ¡å°±è¢«ä¸­æ–­äº†ã€‚ä½†æ˜¯ï¼Œè¿™äº›è¯·æ±‚ä¸­çš„å†™æ“ä½œå¹¶æ²¡æœ‰è®°å½•åˆ°åˆšåˆšç”Ÿæˆçš„ RDB æ–‡ä»¶ä¸­ã€‚ä¸ºäº†ä¿è¯ä¸»ä»åº“çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä¸»åº“ä¼šåœ¨å†…å­˜ä¸­ç”¨ä¸“é—¨çš„ replication bufferï¼Œè®°å½• RDB æ–‡ä»¶ç”Ÿæˆåæ”¶åˆ°çš„æ‰€æœ‰å†™æ“ä½œã€‚<br /><strong>ç¬¬ä¸‰é˜¶æ®µ</strong>ï¼š<br />ä¸»åº“ä¼šæŠŠç¬¬äºŒé˜¶æ®µæ‰§è¡Œè¿‡ç¨‹ä¸­æ–°æ”¶åˆ°çš„å†™å‘½ä»¤ï¼Œå†å‘é€ç»™ä»åº“ã€‚<br />å…·ä½“çš„æ“ä½œæ˜¯ï¼Œå½“ä¸»åº“å®Œæˆ RDB æ–‡ä»¶å‘é€åï¼Œå°±ä¼šæŠŠæ­¤æ—¶ replication buffer ä¸­çš„ä¿®æ”¹æ“ä½œå‘ç»™ä»åº“ï¼Œä»åº“å†é‡æ–°æ‰§è¡Œè¿™äº›æ“ä½œã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸»ä»åº“å°±å®ç°åŒæ­¥äº†ã€‚</p><h2 id="å¢é‡å¤åˆ¶"><a class="markdownIt-Anchor" href="#å¢é‡å¤åˆ¶"></a> å¢é‡å¤åˆ¶</h2><blockquote><p>Redisåœ¨2.8å¼•å…¥äº†å¢é‡å¤åˆ¶</p></blockquote><h3 id="ä¸ºä½•å¼•å…¥å¢é‡å¤åˆ¶"><a class="markdownIt-Anchor" href="#ä¸ºä½•å¼•å…¥å¢é‡å¤åˆ¶"></a> ä¸ºä½•å¼•å…¥å¢é‡å¤åˆ¶ï¼Ÿ</h3><p>æ–­ç‚¹ç»­ä¼ ã€‚<br />å¦‚æœä¸»ä»åº“åœ¨å‘½ä»¤ä¼ æ’­æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­ï¼Œé‚£ä¹ˆï¼Œä»åº“å°±ä¼šå’Œä¸»åº“é‡æ–°è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œå¼€é”€éå¸¸å¤§ã€‚ä» Redis 2.8 å¼€å§‹ï¼Œç½‘ç»œæ–­äº†ä¹‹åï¼Œä¸»ä»åº“ä¼šé‡‡ç”¨å¢é‡å¤åˆ¶çš„æ–¹å¼ç»§ç»­åŒæ­¥ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659800739355-112ea4b4-967c-4abf-b0c0-acd1368b90b2.jpeg" alt="" /></p><h3 id="ä¸¤ä¸ªç¼“å†²åŒº"><a class="markdownIt-Anchor" href="#ä¸¤ä¸ªç¼“å†²åŒº"></a> ä¸¤ä¸ªç¼“å†²åŒº</h3><p><strong>repl_backlog_buffer</strong>ï¼š<br />å®ƒæ˜¯ä¸ºäº†ä»åº“æ–­å¼€ä¹‹åï¼Œå¦‚ä½•æ‰¾åˆ°ä¸»ä»å·®å¼‚æ•°æ®è€Œè®¾è®¡çš„ç¯å½¢ç¼“å†²åŒºï¼Œä»è€Œé¿å…å…¨é‡å¤åˆ¶å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚å¦‚æœä»åº“æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_backlog_bufferç¯å½¢ç¼“å†²åŒºè¢«ä¸»åº“çš„å†™å‘½ä»¤è¦†ç›–äº†ï¼Œé‚£ä¹ˆä»åº“è¿ä¸Šä¸»åº“ååªèƒ½ä¹–ä¹–åœ°è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œæ‰€ä»¥repl_backlog_bufferé…ç½®å°½é‡å¤§ä¸€äº›ï¼Œå¯ä»¥é™ä½ä¸»ä»æ–­å¼€åå…¨é‡å¤åˆ¶çš„æ¦‚ç‡ã€‚<br />è€Œåœ¨repl_backlog_bufferä¸­æ‰¾ä¸»ä»å·®å¼‚çš„æ•°æ®åï¼Œå¦‚ä½•å‘ç»™ä»åº“å‘¢ï¼Ÿè¿™å°±ç”¨åˆ°äº†replication bufferã€‚<br /><strong>replication bufferï¼š</strong><br />Rediså’Œå®¢æˆ·ç«¯é€šä¿¡ä¹Ÿå¥½ï¼Œå’Œä»åº“é€šä¿¡ä¹Ÿå¥½ï¼ŒRediséƒ½éœ€è¦ç»™åˆ†é…ä¸€ä¸ª å†…å­˜bufferè¿›è¡Œæ•°æ®äº¤äº’ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªclientï¼Œä»åº“ä¹Ÿæ˜¯ä¸€ä¸ªclientï¼Œæˆ‘ä»¬æ¯ä¸ªclientè¿ä¸ŠRedisåï¼ŒRediséƒ½ä¼šåˆ†é…ä¸€ä¸ªclient bufferï¼Œæ‰€æœ‰æ•°æ®äº¤äº’éƒ½æ˜¯é€šè¿‡è¿™ä¸ªbufferè¿›è¡Œçš„ï¼šRediså…ˆæŠŠæ•°æ®å†™åˆ°è¿™ä¸ªbufferä¸­ï¼Œç„¶åå†æŠŠbufferä¸­çš„æ•°æ®å‘åˆ°client socketä¸­å†é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•°æ®äº¤äº’ã€‚<br />æ‰€ä»¥ä¸»ä»åœ¨å¢é‡åŒæ­¥æ—¶ï¼Œä»åº“ä½œä¸ºä¸€ä¸ªclientï¼Œä¹Ÿä¼šåˆ†é…ä¸€ä¸ªbufferï¼Œåªä¸è¿‡è¿™ä¸ªbufferä¸“é—¨ç”¨æ¥ä¼ æ’­ç”¨æˆ·çš„å†™å‘½ä»¤åˆ°ä»åº“ï¼Œä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´ï¼Œæˆ‘ä»¬é€šå¸¸æŠŠå®ƒå«åšreplication buffer</p><h1 id="2å‡ ç‚¹æ€»ç»“"><a class="markdownIt-Anchor" href="#2å‡ ç‚¹æ€»ç»“"></a> 2.å‡ ç‚¹æ€»ç»“</h1><h2 id="æ ¸å¿ƒæœºåˆ¶"><a class="markdownIt-Anchor" href="#æ ¸å¿ƒæœºåˆ¶"></a> æ ¸å¿ƒæœºåˆ¶</h2><ul><li>Redis é‡‡ç”¨å¼‚æ­¥æ–¹å¼å¤åˆ¶æ•°æ®åˆ° slave èŠ‚ç‚¹ï¼Œä¸è¿‡ Redis2.8 å¼€å§‹ï¼Œslave node ä¼šå‘¨æœŸæ€§åœ°ç¡®è®¤è‡ªå·±æ¯æ¬¡å¤åˆ¶çš„æ•°æ®é‡ï¼›</li><li>ä¸€ä¸ª master node æ˜¯å¯ä»¥é…ç½®å¤šä¸ª slave node çš„ï¼›</li><li>slave node ä¹Ÿå¯ä»¥è¿æ¥å…¶ä»–çš„ slave nodeï¼›</li><li>slave node åšå¤åˆ¶çš„æ—¶å€™ï¼Œä¸ä¼š block master node çš„æ­£å¸¸å·¥ä½œï¼›</li><li>slave node åœ¨åšå¤åˆ¶çš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼š block å¯¹è‡ªå·±çš„æŸ¥è¯¢æ“ä½œï¼Œå®ƒä¼šç”¨æ—§çš„æ•°æ®é›†æ¥æä¾›æœåŠ¡ï¼›ä½†æ˜¯å¤åˆ¶å®Œæˆçš„æ—¶å€™ï¼Œéœ€è¦åˆ é™¤æ—§æ•°æ®é›†ï¼ŒåŠ è½½æ–°æ•°æ®é›†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæš‚åœå¯¹å¤–æœåŠ¡äº†ï¼›</li><li>slave node ä¸»è¦ç”¨æ¥è¿›è¡Œæ¨ªå‘æ‰©å®¹ï¼Œåšè¯»å†™åˆ†ç¦»ï¼Œæ‰©å®¹çš„ slave node å¯ä»¥æé«˜è¯»çš„ååé‡ã€‚</li></ul><h2 id="æ— ç£ç›˜å¤åˆ¶"><a class="markdownIt-Anchor" href="#æ— ç£ç›˜å¤åˆ¶"></a> æ— ç£ç›˜å¤åˆ¶</h2><p>Redis é»˜è®¤æ˜¯ç£ç›˜å¤åˆ¶ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨æ¯”è¾ƒä½é€Ÿçš„ç£ç›˜ï¼Œè¿™ç§æ“ä½œä¼šç»™ä¸»æœåŠ¡å™¨å¸¦æ¥è¾ƒå¤§çš„å‹åŠ›ã€‚Redisä»2.8.18ç‰ˆæœ¬å¼€å§‹å°è¯•æ”¯æŒæ— ç£ç›˜çš„å¤åˆ¶ã€‚ä½¿ç”¨è¿™ç§è®¾ç½®æ—¶ï¼Œå­è¿›ç¨‹ç›´æ¥å°†RDBé€šè¿‡ç½‘ç»œå‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä¸ä½¿ç”¨ç£ç›˜ä½œä¸ºä¸­é—´å­˜å‚¨ã€‚<br />masteråˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ç›´æ¥dump RDBåˆ°slaveçš„socketï¼Œä¸ç»è¿‡ä¸»è¿›ç¨‹ï¼Œä¸ç»è¿‡ç¡¬ç›˜ã€‚é€‚ç”¨äºdiskè¾ƒæ…¢ï¼Œå¹¶ä¸”ç½‘ç»œè¾ƒå¿«çš„æ—¶å€™ã€‚</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">repl-diskless-sync yes# ç­‰å¾… 5s åå†å¼€å§‹å¤åˆ¶ï¼Œå› ä¸ºè¦ç­‰æ›´å¤š slave é‡æ–°è¿æ¥è¿‡æ¥repl-diskless-sync-delay 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="ä¸ºä½•å…¨é‡å¤åˆ¶ç”¨çš„rdb"><a class="markdownIt-Anchor" href="#ä¸ºä½•å…¨é‡å¤åˆ¶ç”¨çš„rdb"></a> ä¸ºä½•å…¨é‡å¤åˆ¶ç”¨çš„RDBï¼Ÿ</h2><ul><li>RDBæ–‡ä»¶å†…å®¹æ˜¯ç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆä¸åŒæ•°æ®ç±»å‹æ•°æ®åšäº†é’ˆå¯¹æ€§ä¼˜åŒ–ï¼‰ï¼Œ<strong>æ–‡ä»¶å¾ˆå°</strong>ï¼›è€ŒAOFæ–‡ä»¶è®°å½•çš„æ˜¯æ¯ä¸€æ¬¡å†™æ“ä½œçš„å‘½ä»¤ï¼Œå†™æ“ä½œè¶Šå¤šæ–‡ä»¶ä¼šå˜å¾—å¾ˆå¤§ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬å¾ˆå¤šå¯¹åŒä¸€ä¸ªkeyçš„å¤šæ¬¡å†—ä½™æ“ä½œã€‚</li><li>åœ¨ä¸»ä»å…¨é‡æ•°æ®åŒæ­¥æ—¶ï¼Œä¼ è¾“RDBæ–‡ä»¶å¯ä»¥å°½é‡é™ä½å¯¹ä¸»åº“æœºå™¨ç½‘ç»œå¸¦å®½çš„æ¶ˆè€—ï¼Œä»åº“åœ¨åŠ è½½RDBæ–‡ä»¶æ—¶ï¼Œä¸€æ˜¯æ–‡ä»¶å°ï¼Œè¯»å–æ•´ä¸ªæ–‡ä»¶çš„é€Ÿåº¦ä¼šå¾ˆå¿«ï¼ŒäºŒæ˜¯å› ä¸ºRDBæ–‡ä»¶å­˜å‚¨çš„éƒ½æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œä»åº“ç›´æ¥æŒ‰ç…§RDBåè®®è§£æè¿˜åŸæ•°æ®å³å¯ï¼Œé€Ÿåº¦ä¼šéå¸¸å¿«ï¼›è€ŒAOFéœ€è¦ä¾æ¬¡é‡æ”¾æ¯ä¸ªå†™å‘½ä»¤ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šç»å†å†—é•¿çš„å¤„ç†é€»è¾‘ï¼Œæ¢å¤é€Ÿåº¦ç›¸æ¯”RDBä¼šæ…¢å¾—å¤šï¼Œæ‰€ä»¥ä½¿ç”¨RDBè¿›è¡Œä¸»ä»å…¨é‡å¤åˆ¶çš„æˆæœ¬æœ€ä½ã€‚</li><li>è¦ä½¿ç”¨AOFåšå…¨é‡å¤åˆ¶ï¼Œæ„å‘³ç€å¿…é¡»æ‰“å¼€AOFåŠŸèƒ½ï¼Œæ‰“å¼€AOFå°±è¦é€‰æ‹©æ–‡ä»¶åˆ·ç›˜çš„ç­–ç•¥ï¼Œé€‰æ‹©ä¸å½“ä¼šä¸¥é‡å½±å“Redisæ€§èƒ½ï¼›è€ŒRDBåªæœ‰åœ¨éœ€è¦å®šæ—¶å¤‡ä»½å’Œä¸»ä»å…¨é‡å¤åˆ¶æ•°æ®æ—¶æ‰ä¼šè§¦å‘ç”Ÿæˆä¸€æ¬¡å¿«ç…§ã€‚</li></ul><h2 id="keyè¿‡æœŸå¤„ç†"><a class="markdownIt-Anchor" href="#keyè¿‡æœŸå¤„ç†"></a> keyè¿‡æœŸå¤„ç†ï¼Ÿ</h2><p>slave ä¸ä¼šè¿‡æœŸ keyï¼Œåªä¼šç­‰å¾… master è¿‡æœŸ keyã€‚<br />å¦‚æœ master è¿‡æœŸäº†ä¸€ä¸ª keyï¼Œæˆ–è€…é€šè¿‡ LRU æ·˜æ±°äº†ä¸€ä¸ª keyï¼Œé‚£ä¹ˆä¼šæ¨¡æ‹Ÿä¸€æ¡ del å‘½ä»¤å‘é€ç»™ slaveã€‚</p><h2 id="è¯»å†™åˆ†ç¦»å¸¦æ¥çš„é—®é¢˜"><a class="markdownIt-Anchor" href="#è¯»å†™åˆ†ç¦»å¸¦æ¥çš„é—®é¢˜"></a> è¯»å†™åˆ†ç¦»å¸¦æ¥çš„é—®é¢˜</h2><h3 id="æ•°æ®ä¸ä¸€è‡´é—®é¢˜"><a class="markdownIt-Anchor" href="#æ•°æ®ä¸ä¸€è‡´é—®é¢˜"></a> æ•°æ®ä¸ä¸€è‡´é—®é¢˜</h3><p>ç”±äºä¸»ä»å¤åˆ¶çš„å‘½ä»¤ä¼ æ’­æ˜¯å¼‚æ­¥çš„ï¼Œå»¶è¿Ÿä¸æ•°æ®çš„ä¸ä¸€è‡´ä¸å¯é¿å…ã€‚å¦‚æœåº”ç”¨å¯¹æ•°æ®ä¸ä¸€è‡´çš„æ¥å—ç¨‹åº¦ç¨‹åº¦è¾ƒä½ï¼Œå¯èƒ½çš„ä¼˜åŒ–æªæ–½åŒ…æ‹¬ï¼š</p><ul><li>ä¼˜åŒ–ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œç¯å¢ƒï¼ˆå¦‚åœ¨åŒæœºæˆ¿éƒ¨ç½²ï¼‰ï¼›</li><li>ç›‘æ§ä¸»ä»èŠ‚ç‚¹å»¶è¿Ÿï¼ˆé€šè¿‡offsetï¼‰åˆ¤æ–­ï¼Œå¦‚æœä»èŠ‚ç‚¹å»¶è¿Ÿè¿‡å¤§ï¼Œé€šçŸ¥åº”ç”¨ä¸å†é€šè¿‡è¯¥ä»èŠ‚ç‚¹è¯»å–æ•°æ®ï¼›</li><li>ä½¿ç”¨é›†ç¾¤åŒæ—¶æ‰©å±•å†™è´Ÿè½½å’Œè¯»è´Ÿè½½ç­‰</li></ul><h3 id="æ•°æ®è¿‡æœŸé—®é¢˜"><a class="markdownIt-Anchor" href="#æ•°æ®è¿‡æœŸé—®é¢˜"></a> æ•°æ®è¿‡æœŸé—®é¢˜</h3><p>slaveä¸ä¼šä¸»åŠ¨åˆ é™¤å’Œæ·˜æ±°è¿‡æœŸçš„keyï¼Œå®ƒåªä¼šç­‰å¾…masterå»å¤„ç†ã€‚ä½†æ˜¯ï¼Œå¦‚æœmasteråœ¨å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤+å†…å­˜æ·˜æ±°æœºåˆ¶ä¸‹ï¼Œä»ç„¶æ²¡æœ‰å¤„ç†åˆ°æŸäº›è¿‡æœŸçš„keyï¼Œé‚£ä¹ˆè¿™äº›è¿‡æœŸçš„keyåœ¨slaveä¸­ä¼šä¸€ç›´å­˜åœ¨ï¼Œæ­¤æ—¶clienè¯»åˆ°çš„keyå°±æ˜¯è¿‡æœŸçš„ã€‚</p><blockquote><p>Redis 3.2è§£å†³äº†æ•°æ®è¿‡æœŸé—®é¢˜ã€‚</p></blockquote><h3 id="æ•…éšœåˆ‡æ¢é—®é¢˜"><a class="markdownIt-Anchor" href="#æ•…éšœåˆ‡æ¢é—®é¢˜"></a> æ•…éšœåˆ‡æ¢é—®é¢˜</h3><p>åœ¨æ²¡æœ‰ä½¿ç”¨å“¨å…µçš„è¯»å†™åˆ†ç¦»åœºæ™¯ä¸‹ï¼Œåº”ç”¨é’ˆå¯¹è¯»å’Œå†™åˆ†åˆ«è¿æ¥ä¸åŒçš„RedisèŠ‚ç‚¹ï¼›å½“ä¸»èŠ‚ç‚¹æˆ–ä»èŠ‚ç‚¹å‡ºç°é—®é¢˜è€Œå‘ç”Ÿæ›´æ”¹æ—¶ï¼Œéœ€è¦åŠæ—¶ä¿®æ”¹åº”ç”¨ç¨‹åºè¯»å†™Redisæ•°æ®çš„è¿æ¥ï¼›è¿æ¥çš„åˆ‡æ¢å¯ä»¥æ‰‹åŠ¨è¿›è¡Œï¼Œæˆ–è€…è‡ªå·±å†™ç›‘æ§ç¨‹åºè¿›è¡Œåˆ‡æ¢ï¼Œä½†å‰è€…å“åº”æ…¢ã€å®¹æ˜“å‡ºé”™ï¼Œåè€…å®ç°å¤æ‚ï¼Œæˆæœ¬éƒ½ä¸ç®—ä½</p><h1 id="å‚è€ƒæ–‡ç« "><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡ç« "></a> å‚è€ƒæ–‡ç« </h1><ul><li><a href="https://redis.io/docs/manual/replication/">https://redis.io/docs/manual/replication/</a></li><li>ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹</li><li><a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-copy.html">https://pdai.tech/md/db/nosql-redis/db-redis-x-copy.html</a></li><li><a href="https://doocs.github.io/advanced-java/#/docs/high-concurrency/redis-master-slave">https://doocs.github.io/advanced-java/#/docs/high-concurrency/redis-master-slave</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä¸»ä»å¤åˆ¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redisè¿‡æœŸç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶</title>
    <link href="/2022/08/06/Redis%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5%E5%92%8C%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E6%9C%BA%E5%88%B6/"/>
    <url>/2022/08/06/Redis%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5%E5%92%8C%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h1 id="0å‰è¨€"><a class="markdownIt-Anchor" href="#0å‰è¨€"></a> 0.å‰è¨€</h1><p>æ—¢ç„¶Redisæ˜¯å†…å­˜ç¼“å­˜ï¼Œé‚£ç”±äºå†…å­˜å®¹é‡æœ‰é™ï¼Œä¸å¯èƒ½åƒæ–‡ä»¶DBé‚£æ ·æŠŠæ•°æ®ä»è¿›å»å°±å®Œäº‹äº†ã€‚<br />å¹¶ä¸”Redisé‡Œå­˜æ”¾çš„å¤šæ˜¯çƒ­ç‚¹æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦é€‚æ—¶å¯¹è¿‡æœŸçš„keyè¿›è¡Œæ¸…ç†ï¼Œæ¥é‡Šæ”¾ç©ºé—´ï¼›ä½†æ˜¯ï¼Œåœ¨æ¸…ç†è¿‡åï¼Œä»ç„¶æœ‰å¯èƒ½è¿˜æ˜¯å­˜åœ¨å¤§é‡çš„â€œåºŸå¼ƒâ€keyï¼Œè¿™æ—¶å€™å°±éœ€è¦å†…å­˜æ·˜æ±°æœºåˆ¶æ¥å¼ºåˆ¶æ¸…ç†äº†ã€‚</p><h2 id="è¿‡æœŸæ—¶é—´"><a class="markdownIt-Anchor" href="#è¿‡æœŸæ—¶é—´"></a> è¿‡æœŸæ—¶é—´</h2><p>Redisæ”¯æŒä¸ºkeyè®¾ç½®ä¸€ä¸ªç”Ÿå­˜æ—¶é—´TTLï¼Œåœ¨ç»è¿‡æŒ‡å®šçš„æ—¶é—´åï¼ŒServerä¼šè‡ªåŠ¨åˆ é™¤TTL=0çš„keyã€‚</p><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis<span class="token operator">></span> SET key valueOKredis<span class="token operator">></span> EXPIRE key <span class="token number">5</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>redis<span class="token operator">></span> GET key  // <span class="token number">5</span>ç§’ä¹‹å†…<span class="token string">"value"</span>redis<span class="token operator">></span> GET key  // <span class="token number">5</span>ç§’ä¹‹å<span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><blockquote><p>SETEXå‘½ä»¤å¯ä»¥åœ¨è®¾ç½®ä¸€ä¸ªå­—ç¬¦ä¸²é”®çš„åŒæ—¶ä¸ºé”®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯ä¸€ä¸ªç±»å‹é™å®šçš„å‘½ä»¤ï¼ˆåªèƒ½ç”¨äºå­—ç¬¦ä¸²é”®ï¼‰ã€‚<br />åŒæ—¶Redisæä¾›äº†ç»Ÿä¸€çš„è®¾ç½®è¿‡æœŸæ—¶é—´å‘½ä»¤ï¼šEXPIREï¼ŒPEXPIREä¸ºä¸€ä¸ªkeyè®¾ç½®ç§’ï¼Œæ¯«ç§’çº§åˆ«çš„TTL</p></blockquote><h2 id="å¯èƒ½çš„è¿‡æœŸç­–ç•¥"><a class="markdownIt-Anchor" href="#å¯èƒ½çš„è¿‡æœŸç­–ç•¥"></a> å¯èƒ½çš„è¿‡æœŸç­–ç•¥</h2><ul><li>å®šæ—¶åˆ é™¤ï¼šåœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼ˆtimerï¼‰ï¼Œè®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ</li><li>æƒ°æ€§åˆ é™¤ï¼šæ”¾ä»»é”®è¿‡æœŸä¸ç®¡ï¼Œä½†æ˜¯æ¯æ¬¡ä»é”®ç©ºé—´ä¸­è·å–é”®æ—¶ï¼Œéƒ½æ£€æŸ¥å–å¾—çš„é”®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸçš„è¯ï¼Œå°±åˆ é™¤è¯¥é”®ï¼›å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œå°±è¿”å›è¯¥é”®</li><li>å®šæœŸåˆ é™¤ï¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œç¨‹åºå°±å¯¹æ•°æ®åº“è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢çš„è¿‡æœŸé”®ã€‚è‡³äºè¦åˆ é™¤å¤šå°‘è¿‡æœŸé”®ï¼Œä»¥åŠè¦æ£€æŸ¥å¤šå°‘ä¸ªæ•°æ®åº“ï¼Œåˆ™ç”±ç®—æ³•å†³å®š</li></ul><p>å®šæœŸåˆ é™¤æ˜¯å®šæ—¶+æƒ°æ€§çš„æŠ˜ä¸­ã€‚</p><h1 id="1redisè¿‡æœŸç­–ç•¥"><a class="markdownIt-Anchor" href="#1redisè¿‡æœŸç­–ç•¥"></a> 1.Redisè¿‡æœŸç­–ç•¥</h1><p>Redisæä¾›äº†ä»¥ä¸‹ä¸¤ç§è¿‡æœŸç­–ç•¥ï¼š<br />å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤</p><h2 id="å®šæœŸåˆ é™¤"><a class="markdownIt-Anchor" href="#å®šæœŸåˆ é™¤"></a> å®šæœŸåˆ é™¤</h2><p>Redis é»˜è®¤æ˜¯æ¯éš” 100ms å°±éšæœºæŠ½å–ä¸€äº›è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ keyï¼Œæ£€æŸ¥å…¶æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±åˆ é™¤ã€‚</p><h3 id="ä¼˜ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#ä¼˜ç¼ºç‚¹"></a> ä¼˜ç¼ºç‚¹</h3><p>ä¼˜ç‚¹ï¼š</p><ul><li>é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹CPUæ—¶é—´çš„å½±å“</li><li>å‡å°‘å†…å­˜æµªè´¹</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æœ‰çš„keyå¯èƒ½æ‰«æä¸åˆ°</li></ul><p><strong>ä¸ºæ¯›éšæœºæŠ½å–ï¼Ÿ</strong><br />å¦‚æœå…¨éƒ¨æŠ½å–ï¼Œåˆ™éœ€è¦æ‰«ææ‰€æœ‰çš„keyï¼Œåˆ¤æ–­TTLï¼Œå¼€é”€å¤ªå¤§ï¼<br /><strong>æœ‰ä½•ä¸è¶³ï¼Ÿ</strong><br />éšæœºæŠ½å–ï¼Œå¯èƒ½å¯¼è‡´å¤§é‡çš„è¿‡æœŸkeyæ²¡æœ‰è¢«æŠ½å–åˆ°ï¼</p><h2 id="æƒ°æ€§åˆ é™¤"><a class="markdownIt-Anchor" href="#æƒ°æ€§åˆ é™¤"></a> æƒ°æ€§åˆ é™¤</h2><p>è·å– key çš„æ—¶å€™ï¼Œå¦‚æœæ­¤æ—¶ key å·²ç»è¿‡æœŸï¼Œå°±åˆ é™¤ï¼Œä¸ä¼šè¿”å›ä»»ä½•ä¸œè¥¿ã€‚</p><h3 id="ä¼˜ç¼ºç‚¹-2"><a class="markdownIt-Anchor" href="#ä¼˜ç¼ºç‚¹-2"></a> ä¼˜ç¼ºç‚¹</h3><p>ä¼˜ç‚¹ï¼š</p><ul><li>å¯¹CPUæ—¶é—´æ¥è¯´æ˜¯æœ€å‹å¥½çš„ï¼šç¨‹åºåªä¼šåœ¨å–å‡ºé”®æ—¶æ‰å¯¹é”®è¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œè¿™å¯ä»¥ä¿è¯åˆ é™¤è¿‡æœŸé”®çš„æ“ä½œåªä¼šåœ¨éåšä¸å¯çš„æƒ…å†µä¸‹è¿›è¡Œï¼Œå¹¶ä¸”åˆ é™¤çš„ç›®æ ‡ä»…é™äºå½“å‰å¤„ç†çš„é”®ï¼Œè¿™ä¸ªç­–ç•¥ä¸ä¼šåœ¨åˆ é™¤å…¶ä»–æ— å…³çš„è¿‡æœŸé”®ä¸ŠèŠ±è´¹ä»»ä½•CPUæ—¶é—´ã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>å®ƒå¯¹å†…å­˜æ˜¯æœ€ä¸å‹å¥½çš„ï¼šå¦‚æœä¸€ä¸ªé”®å·²ç»è¿‡æœŸï¼Œè€Œè¿™ä¸ªé”®åˆä»ç„¶ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªè¿‡æœŸé”®ä¸è¢«åˆ é™¤ï¼Œå®ƒæ‰€å ç”¨çš„å†…å­˜å°±ä¸ä¼šé‡Šæ”¾</li><li>å†…å­˜æ³„æ¼ï¼šå¦‚æœæ•°æ®åº“ä¸­æœ‰éå¸¸å¤šçš„è¿‡æœŸé”®ï¼Œè€Œè¿™äº›è¿‡æœŸé”®åˆæ°å¥½æ²¡æœ‰è¢«è®¿é—®åˆ°çš„è¯ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹Ÿè®¸æ°¸è¿œä¹Ÿä¸ä¼šè¢«åˆ é™¤ï¼ˆé™¤éç”¨æˆ·æ‰‹åŠ¨æ‰§è¡ŒFLUSHDBï¼‰</li></ul><h1 id="2å†…å­˜æ·˜æ±°ç®—æ³•"><a class="markdownIt-Anchor" href="#2å†…å­˜æ·˜æ±°ç®—æ³•"></a> 2.å†…å­˜æ·˜æ±°ç®—æ³•</h1><h2 id="å®šæœŸåˆ é™¤æƒ°æ€§åˆ é™¤å°±ä¸€å®šok"><a class="markdownIt-Anchor" href="#å®šæœŸåˆ é™¤æƒ°æ€§åˆ é™¤å°±ä¸€å®šok"></a> å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤å°±ä¸€å®šOKï¼Ÿ</h2><p>å¦‚æœå®šæœŸåˆ é™¤æ¼æ‰äº†å¾ˆå¤šè¿‡æœŸ keyï¼Œç„¶åä½ ä¹Ÿæ²¡åŠæ—¶å»æŸ¥ï¼Œä¹Ÿå°±æ²¡èµ°æƒ°æ€§åˆ é™¤ï¼Œæ­¤æ—¶ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚æœå¤§é‡è¿‡æœŸ key å †ç§¯åœ¨å†…å­˜é‡Œï¼Œå¯¼è‡´ Redis å†…å­˜å—è€—å°½äº†ï¼Œå’‹æ•´ï¼Ÿ<br />ç­”æ¡ˆæ˜¯ï¼šå†…å­˜æ·˜æ±°æœºåˆ¶ã€‚</p><h2 id="å‡ ç§æ·˜æ±°ç®—æ³•"><a class="markdownIt-Anchor" href="#å‡ ç§æ·˜æ±°ç®—æ³•"></a> å‡ ç§æ·˜æ±°ç®—æ³•</h2><ul><li><strong>noeviction</strong>:  å½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™</li><li><strong>allkeys-lru</strong>ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼ˆè¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ï¼‰</li><li><strong>allkeys-random</strong>ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ª key</li><li><strong>volatile-lru</strong>ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œ<strong>åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­</strong>ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼ˆè¿™ä¸ªä¸€èˆ¬ä¸å¤ªåˆé€‚ï¼‰</li><li><strong>volatile-random</strong>ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ª keyã€‚</li><li><strong>volatile-ttl</strong>ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œæœ‰æ›´æ—©è¿‡æœŸæ—¶é—´çš„ key ä¼˜å…ˆç§»é™¤</li></ul><h2 id="é…ç½®"><a class="markdownIt-Anchor" href="#é…ç½®"></a> é…ç½®</h2><p>redis.confé‡Œé…ç½®<code>maxmemory</code>ï¼Œè¡¨ç¤ºä½¿ç”¨æœ€å¤§çš„å†…å­˜ã€‚<br />64ä½æœºå™¨ä¸Šï¼Œé»˜è®¤æ˜¯0ï¼Œè¡¨ç¤ºæ²¡æœ‰å†…å­˜é™åˆ¶ï¼›32ä½æœºå™¨ä¸Šï¼Œé»˜è®¤æ˜¯3GB</p><h2 id="æ‰‹æ’•ä¸€ä¸ªlrulfu"><a class="markdownIt-Anchor" href="#æ‰‹æ’•ä¸€ä¸ªlrulfu"></a> æ‰‹æ’•ä¸€ä¸ªLRU/LFUï¼Ÿ</h2><h3 id="linkedhashmap"><a class="markdownIt-Anchor" href="#linkedhashmap"></a> LinkedHashMap</h3><p>æœ€ç®€å•çš„ï¼Œä½¿ç”¨LinkedHashMap</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">LRUCache</span> <span class="token keyword">extends</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token class-name">LRUCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">super</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> <span class="token number">0.75f</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">removeEldestEntry</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> eldest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> capacity<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h3 id="æ‰‹æ’•åŒé“¾è¡¨"><a class="markdownIt-Anchor" href="#æ‰‹æ’•åŒé“¾è¡¨"></a> æ‰‹æ’•åŒé“¾è¡¨</h3><p><a href="https://www.yuque.com/mokeeqian/awaresome-backend/kgrgu8?view=doc_embed">ç¼“å­˜æ·˜æ±°ç®—æ³•LRU/LFUå®ç°</a></p>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>LRU</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RedisæŒä¹…åŒ–</title>
    <link href="/2022/08/05/Redis%E6%8C%81%E4%B9%85%E5%8C%96/"/>
    <url>/2022/08/05/Redis%E6%8C%81%E4%B9%85%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h1 id="0å‰è¨€"><a class="markdownIt-Anchor" href="#0å‰è¨€"></a> 0.å‰è¨€</h1><blockquote><p>æŒä¹…åŒ–æ˜¯æŒ‡å°†æ•°æ®å†™å…¥æŒä¹…å­˜å‚¨ï¼Œä¾‹å¦‚å›ºæ€ç£ç›˜ (SSD)ã€‚Redisæ”¯æŒä»¥ä¸‹å‡ ç§æŒä¹…åŒ–æ–¹å¼ï¼š</p><ul><li>RDBï¼ˆRedis DataBaseï¼‰ï¼šä»¥æŒ‡å®šçš„æ—¶é—´é—´éš”æ‰§è¡Œæ•°æ®é›†çš„æ—¶é—´ç‚¹å¿«ç…§</li><li>AOFï¼ˆAppend Only Fileï¼‰ï¼šè®°å½•serveræ”¶åˆ°çš„æ¯ä¸ªå†™æ“ä½œå‘½ä»¤ï¼Œåœ¨é‡æ–°å¯åŠ¨æ—¶ï¼Œå†æ¬¡æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥é‡å»ºæ•°æ®</li><li>RDB+AOFï¼šé‡å¯åï¼ŒAOFç”¨äºé‡å»ºæ•°æ®</li></ul></blockquote><h2 id="ä¸ºä½•è¦æŒä¹…åŒ–"><a class="markdownIt-Anchor" href="#ä¸ºä½•è¦æŒä¹…åŒ–"></a> ä¸ºä½•è¦æŒä¹…åŒ–ï¼Ÿ</h2><ul><li>æ•°æ®æ”¾åœ¨å†…å­˜ï¼Œå®¹é‡æœ‰é™ã€æ–­ç”µä¸¢å¤±</li></ul><h1 id="1rdb"><a class="markdownIt-Anchor" href="#1rdb"></a> 1.RDB</h1><p>Rediså°†å†…å­˜æ•°æ®å¿«ç…§å†™å…¥rdbåç¼€çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œè¿™å«snapshotã€‚</p><h2 id="è§¦å‘æ–¹å¼"><a class="markdownIt-Anchor" href="#è§¦å‘æ–¹å¼"></a> è§¦å‘æ–¹å¼</h2><p>redis RDBæŒä¹…åŒ–æœ‰ä¸¤ç§è§¦å‘æ–¹å¼ï¼š</p><ul><li>æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨<code>SAVE</code>æˆ–<code>BGSAVE</code>å‘½ä»¤</li><li>è‡ªåŠ¨è§¦å‘ï¼šæ¯”å¦‚æ¯éš”Nç§’ï¼Œå¦‚æœæ•°æ®æœ‰Mä¸ªæ”¹åŠ¨</li></ul><h3 id="æ‰‹åŠ¨è§¦å‘"><a class="markdownIt-Anchor" href="#æ‰‹åŠ¨è§¦å‘"></a> æ‰‹åŠ¨è§¦å‘</h3><ul><li>saveï¼šé˜»å¡å½“å‰RedisæœåŠ¡å™¨ï¼Œç›´åˆ°RDBè¿‡ç¨‹å®Œæˆä¸ºæ­¢ï¼Œå¯¹äºå†…å­˜ æ¯”è¾ƒå¤§çš„å®ä¾‹ä¼šé€ æˆé•¿æ—¶é—´<strong>é˜»å¡</strong>ï¼Œçº¿ä¸Šç¯å¢ƒä¸å»ºè®®ä½¿ç”¨</li><li>bgsaveï¼šforkåˆ›å»ºå­è¿›ç¨‹ï¼ŒRDBæŒä¹…åŒ–è¿‡ç¨‹ç”±å­è¿›ç¨‹è´Ÿè´£ï¼Œå®Œæˆåè‡ªåŠ¨ç»“æŸã€‚é˜»å¡åªå‘ç”Ÿåœ¨forké˜¶æ®µï¼Œä¸€èˆ¬æ—¶é—´å¾ˆçŸ­</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659588393639-11cb9146-cb2a-4907-9b0a-473d9a880e1a.jpeg" alt="" /></p><h3 id="è‡ªåŠ¨è§¦å‘"><a class="markdownIt-Anchor" href="#è‡ªåŠ¨è§¦å‘"></a> è‡ªåŠ¨è§¦å‘</h3><p>ä»¥ä¸‹å››ç§æƒ…å†µä¼šè‡ªåŠ¨è§¦å‘ï¼š</p><ul><li>redis.confä¸­è®¾ç½®äº†<code>save m n</code>ï¼Œå³æ¯éš”mç§’æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰næ¬¡æ”¹åŠ¨</li><li>ä¸»ä»å¤åˆ¶æ—¶ï¼Œä»èŠ‚ç‚¹è¦ä»ä¸»èŠ‚ç‚¹è¿›è¡Œå…¨é‡å¤åˆ¶æ—¶ä¹Ÿä¼šè§¦å‘bgsaveæ“ä½œï¼Œç”Ÿæˆå½“æ—¶çš„å¿«ç…§å‘é€åˆ°ä»èŠ‚ç‚¹</li><li>æ‰§è¡Œdebug reloadå‘½ä»¤é‡æ–°åŠ è½½redisæ—¶ä¹Ÿä¼šè§¦å‘bgsaveæ“ä½œ</li><li>é»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œshutdownå‘½ä»¤æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯aofæŒä¹…åŒ–ï¼Œé‚£ä¹ˆä¹Ÿä¼šè§¦å‘bgsaveæ“ä½œ</li></ul><h2 id="ä¼˜ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#ä¼˜ç¼ºç‚¹"></a> ä¼˜ç¼ºç‚¹</h2><p>ä¼˜ç‚¹ï¼š</p><ul><li>RDBæ–‡ä»¶æ˜¯æŸä¸ªæ—¶é—´èŠ‚ç‚¹çš„å¿«ç…§ï¼Œé»˜è®¤ä½¿ç”¨LZFç®—æ³•è¿›è¡Œå‹ç¼©ï¼Œå‹ç¼©åçš„æ–‡ä»¶ä½“ç§¯è¿œè¿œå°äºå†…å­˜å¤§å°ï¼Œé€‚ç”¨äºå¤‡ä»½ã€å…¨é‡å¤åˆ¶ç­‰åœºæ™¯</li><li>RDBåŠ è½½RDBæ–‡ä»¶æ¢å¤æ•°æ®æ¯”AOFå¿«</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>å®æ—¶æ€§ä¸å¤Ÿï¼Œæ— æ³•åšåˆ°ç§’çº§çš„æŒä¹…åŒ–</li><li>æ¯æ¬¡è°ƒç”¨bgsaveéƒ½éœ€è¦forkå­è¿›ç¨‹ï¼Œforkå­è¿›ç¨‹å±äºé‡é‡çº§æ“ä½œï¼Œé¢‘ç¹æ‰§è¡Œæˆæœ¬è¾ƒé«˜</li><li>RDBæ–‡ä»¶æ˜¯äºŒè¿›åˆ¶çš„ï¼Œæ²¡æœ‰å¯è¯»æ€§ï¼ŒAOFæ–‡ä»¶åœ¨äº†è§£å…¶ç»“æ„çš„æƒ…å†µä¸‹å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹æˆ–è€…è¡¥å…¨</li></ul><h1 id="2aof"><a class="markdownIt-Anchor" href="#2aof"></a> 2.AOF</h1><blockquote><p>Redisæ˜¯â€œå†™åâ€æ—¥å¿—ï¼ŒRediså…ˆæ‰§è¡Œå‘½ä»¤ï¼ŒæŠŠæ•°æ®å†™å…¥å†…å­˜ï¼Œç„¶åæ‰è®°å½•æ—¥å¿—ã€‚æ—¥å¿—é‡Œè®°å½•çš„æ˜¯Redisæ”¶åˆ°çš„æ¯ä¸€æ¡å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤æ˜¯ä»¥æ–‡æœ¬å½¢å¼ä¿å­˜ã€‚<br />PS: å¤§å¤šæ•°çš„æ•°æ®åº“é‡‡ç”¨çš„æ˜¯å†™å‰æ—¥å¿—ï¼ˆWALï¼‰ï¼Œä¾‹å¦‚MySQLï¼Œé€šè¿‡å†™å‰æ—¥å¿—å’Œä¸¤é˜¶æ®µæäº¤ï¼Œå®ç°æ•°æ®å’Œé€»è¾‘çš„ä¸€è‡´æ€§ã€‚</p></blockquote><h2 id="å†™åæ—¥å¿—"><a class="markdownIt-Anchor" href="#å†™åæ—¥å¿—"></a> å†™åæ—¥å¿—</h2><p>ä¼˜ç‚¹ï¼š</p><ul><li>é¿å…é¢å¤–æ£€æŸ¥å¼€é”€ï¼šRedis åœ¨å‘ AOF é‡Œé¢è®°å½•æ—¥å¿—çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šå…ˆå»å¯¹è¿™äº›å‘½ä»¤è¿›è¡Œè¯­æ³•æ£€æŸ¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœå…ˆè®°æ—¥å¿—å†æ‰§è¡Œå‘½ä»¤çš„è¯ï¼Œæ—¥å¿—ä¸­å°±æœ‰å¯èƒ½è®°å½•äº†é”™è¯¯çš„å‘½ä»¤ï¼ŒRedis åœ¨ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®æ—¶ï¼Œå°±å¯èƒ½ä¼šå‡ºé”™</li><li>ä¸ä¼šé˜»å¡å½“å‰å†™æ“ä½œ</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æ•°æ®ä¸¢å¤±</li><li>ä¸»çº¿ç¨‹å†™ç£ç›˜å‹åŠ›å¤§</li></ul><h2 id="aofçš„å®ç°"><a class="markdownIt-Anchor" href="#aofçš„å®ç°"></a> AOFçš„å®ç°</h2><p>AOFå®ç°åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š<strong>å‘½ä»¤è¿½åŠ ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥</strong><br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659587578748-672bbcce-16f5-402d-a03c-c40490891130.jpeg" alt="" /></p><h3 id="å‘½ä»¤è¿½åŠ "><a class="markdownIt-Anchor" href="#å‘½ä»¤è¿½åŠ "></a> å‘½ä»¤è¿½åŠ </h3><p>å½“AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šä»¥<strong>åè®®æ ¼å¼</strong>å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„<strong>aof_bufç¼“å†²åŒº</strong>çš„æœ«å°¾ï¼š</p><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token comment">// AOF</span>ç¼“å†²åŒº    sds aof_buf<span class="token punctuation">;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>ä¾‹å¦‚ï¼š<br />æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis<span class="token operator">></span> SET KEY VALUEOK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div><p>é‚£ä¹ˆæœåŠ¡å™¨åœ¨æ‰§è¡Œè¿™ä¸ªSETå‘½ä»¤ä¹‹åï¼Œä¼šå°†ä»¥ä¸‹åè®®å†…å®¹è¿½åŠ åˆ°aof_bufç¼“å†²åŒºçš„æœ«å°¾ï¼š</p><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">*3<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nSET<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nKEY<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nVALUE<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><h3 id="æ–‡ä»¶å†™å…¥å’ŒåŒæ­¥"><a class="markdownIt-Anchor" href="#æ–‡ä»¶å†™å…¥å’ŒåŒæ­¥"></a> æ–‡ä»¶å†™å…¥å’ŒåŒæ­¥</h3><p>å› ä¸ºæœåŠ¡å™¨åœ¨å¤„ç†æ–‡ä»¶äº‹ä»¶æ—¶å¯èƒ½ä¼šæ‰§è¡Œå†™å‘½ä»¤ï¼Œä½¿å¾—ä¸€äº›å†…å®¹è¢«è¿½åŠ åˆ°aof_bufç¼“å†²åŒºé‡Œé¢ï¼Œæ‰€ä»¥åœ¨æœåŠ¡å™¨æ¯æ¬¡ç»“æŸä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œå®ƒéƒ½ä¼šè°ƒç”¨flushAppendOnlyFileå‡½æ•°ï¼Œ<strong>è€ƒè™‘æ˜¯å¦éœ€è¦å°†aof_bufç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥å’Œä¿å­˜åˆ°AOFæ–‡ä»¶é‡Œé¢ã€‚</strong><br />å…³äºä½•æ—¶å°† aof_buf ç¼“å†²åŒºçš„å†…å®¹å†™å…¥AOFæ–‡ä»¶ä¸­ï¼ŒRedisæä¾›äº†ä¸‰ç§å†™å›ç­–ç•¥ï¼š<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659534013380-802831cd-a08e-4c78-96ad-a5c55aace518.jpeg#clientId=u22aea455-8f94-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;id=u7e5a6d59&amp;margin=%5Bobject%20Object%5D&amp;originHeight=682&amp;originWidth=2284&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;status=done&amp;style=none&amp;taskId=ud98a5241-a80f-43ca-b630-5924cd9fdf0&amp;title=%E4%B8%8D%E5%90%8Cappendfsync%E5%80%BC%E4%BA%A7%E7%94%9F%E4%B8%8D%E5%90%8C%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E8%A1%8C%E4%B8%BA" alt="ä¸åŒappendfsyncå€¼äº§ç”Ÿä¸åŒçš„æŒä¹…åŒ–è¡Œä¸º" title="ä¸åŒappendfsyncå€¼äº§ç”Ÿä¸åŒçš„æŒä¹…åŒ–è¡Œä¸º" /></p><ul><li>Alwaysï¼šæ¯ä¸ªå†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œç«‹é©¬åŒæ­¥åœ°å°†æ—¥å¿—å†™å›ç£ç›˜</li><li>Everysecï¼šæ¯ä¸ªå†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œåªæ˜¯å…ˆæŠŠæ—¥å¿—å†™åˆ°AOFæ–‡ä»¶çš„å†…å­˜ç¼“å†²åŒºï¼Œæ¯éš”ä¸€ç§’æŠŠç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥ç£ç›˜</li><li>Noï¼šæ¯ä¸ªå†™å‘½ä»¤æ‰§è¡Œå®Œï¼Œåªæ˜¯å…ˆæŠŠæ—¥å¿—å†™åˆ°AOFæ–‡ä»¶çš„å†…å­˜ç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜</li></ul><p>ä¸ºäº†æé«˜æ–‡ä»¶çš„å†™å…¥æ•ˆç‡ï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨writeå‡½æ•°ï¼Œå°†ä¸€äº›æ•°æ®å†™å…¥åˆ°æ–‡ä»¶çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šå°†å†™å…¥æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºé‡Œé¢ï¼Œç­‰åˆ°ç¼“å†²åŒºçš„ç©ºé—´è¢«å¡«æ»¡ã€æˆ–è€…è¶…è¿‡äº†æŒ‡å®šçš„æ—¶é™ä¹‹åï¼Œæ‰çœŸæ­£åœ°å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜é‡Œé¢ã€‚<br />è¿™ç§åšæ³•è™½ç„¶æé«˜äº†æ•ˆç‡ï¼Œä½†ä¹Ÿä¸ºå†™å…¥æ•°æ®å¸¦æ¥äº†å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå¦‚æœè®¡ç®—æœºå‘ç”Ÿåœæœºï¼Œé‚£ä¹ˆä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºé‡Œé¢çš„å†™å…¥æ•°æ®å°†ä¼šä¸¢å¤±ã€‚<br />ä¸ºæ­¤ï¼Œç³»ç»Ÿæä¾›äº†fsyncå’Œfdatasyncä¸¤ä¸ªåŒæ­¥å‡½æ•°ï¼Œå®ƒä»¬<strong>å¯ä»¥å¼ºåˆ¶è®©æ“ä½œç³»ç»Ÿç«‹å³å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œä»è€Œç¡®ä¿å†™å…¥æ•°æ®çš„å®‰å…¨æ€§</strong>ã€‚</p><h2 id="aofæ–‡ä»¶è½½å…¥å’Œæ•°æ®è¿˜åŸ"><a class="markdownIt-Anchor" href="#aofæ–‡ä»¶è½½å…¥å’Œæ•°æ®è¿˜åŸ"></a> AOFæ–‡ä»¶è½½å…¥å’Œæ•°æ®è¿˜åŸ</h2><p>è½½å…¥ï¼š<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659588845176-67baafb5-fd4e-44d0-ba70-a7eca971cac1.jpeg" alt="" /></p><h2 id="aofé‡å†™"><a class="markdownIt-Anchor" href="#aofé‡å†™"></a> AOFé‡å†™</h2><p>éšç€æœåŠ¡å™¨è¿è¡Œæ—¶é—´çš„æµé€ï¼ŒAOFæ–‡ä»¶ä¸­çš„å†…å®¹ä¼šè¶Šæ¥è¶Šå¤šï¼Œæ–‡ä»¶çš„ä½“ç§¯ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¦‚æœä¸åŠ ä»¥æ§åˆ¶çš„è¯ï¼Œä½“ç§¯è¿‡å¤§çš„AOFæ–‡ä»¶å¾ˆå¯èƒ½å¯¹RedisæœåŠ¡å™¨ã€ç”šè‡³æ•´ä¸ªå®¿ä¸»è®¡ç®—æœºé€ æˆå½±å“ï¼Œå¹¶ä¸”AOFæ–‡ä»¶çš„ä½“ç§¯è¶Šå¤§ï¼Œä½¿ç”¨AOFæ–‡ä»¶æ¥è¿›è¡Œæ•°æ®è¿˜åŸæ‰€éœ€çš„æ—¶é—´å°±è¶Šå¤šã€‚<br />ä¸ºäº†è§£å†³AOFæ–‡ä»¶ä½“ç§¯è†¨èƒ€çš„é—®é¢˜ï¼ŒRedisæä¾›äº†**AOFæ–‡ä»¶é‡å†™ï¼ˆrewriteï¼‰**åŠŸèƒ½ã€‚<br />é€šè¿‡è¯¥åŠŸèƒ½ï¼ŒRedisæœåŠ¡å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„AOFæ–‡ä»¶æ¥æ›¿ä»£ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ç›¸åŒï¼Œä½†æ–°AOFæ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œæ‰€ä»¥æ–°AOFæ–‡ä»¶çš„ä½“ç§¯é€šå¸¸ä¼šæ¯”æ—§AOFæ–‡ä»¶çš„ä½“ç§¯è¦å°å¾—å¤šã€‚<br /><strong>AOFé‡å†™é€šè¿‡è¯»å–æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ¥å®ç°çš„ï¼Œç¨‹åºæ— é¡»å¯¹ç°æœ‰AOFæ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å…¥ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œ</strong><br />ä¸¾ä¸ªä¾‹å­ï¼š<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659535493275-500ebe16-d75a-4443-a5a3-3d850bceb7f3.jpeg#clientId=u22aea455-8f94-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;id=u9ae807bf&amp;margin=%5Bobject%20Object%5D&amp;originHeight=1080&amp;originWidth=3970&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u868f368b-8f59-4e8b-9ca2-038de49b617&amp;title=" alt="" /></p><h4 id="æ‰§è¡Œè¿‡ç¨‹"><a class="markdownIt-Anchor" href="#æ‰§è¡Œè¿‡ç¨‹"></a> æ‰§è¡Œè¿‡ç¨‹</h4><ul><li>ä¸»çº¿ç¨‹forkå‡ºå­è¿›ç¨‹é‡å†™aofæ—¥å¿—</li><li>å­è¿›ç¨‹é‡å†™æ—¥å¿—å®Œæˆåï¼Œä¸»çº¿ç¨‹è¿½åŠ aofæ—¥å¿—ç¼“å†²</li><li>æ›¿æ¢æ—¥å¿—æ–‡ä»¶</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659589676311-9267e880-4d33-4a35-884a-a665d16ab340.jpeg#clientId=u22aea455-8f94-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=338&amp;id=uf645d607&amp;margin=%5Bobject%20Object%5D&amp;originHeight=1080&amp;originWidth=2308&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;status=done&amp;style=none&amp;taskId=uad606050-7696-49ad-a51f-331b77f1107&amp;title=AOF%E9%87%8D%E5%86%99%E8%BF%87%E7%A8%8B&amp;width=723.0000610351562" alt="AOFé‡å†™è¿‡ç¨‹" title="AOFé‡å†™è¿‡ç¨‹" /><br />åœ¨æ‰§è¡ŒBGREWRITEAOFå‘½ä»¤æ—¶ï¼ŒRedisæœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ªAOFé‡å†™ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä¼šåœ¨å­è¿›ç¨‹åˆ›å»ºæ–°AOFæ–‡ä»¶æœŸé—´ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚å½“å­è¿›ç¨‹å®Œæˆåˆ›å»ºæ–°AOFæ–‡ä»¶çš„å·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå°†é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–°AOFæ–‡ä»¶çš„æœ«å°¾ï¼Œä½¿å¾—æ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚æœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„AOFæ–‡ä»¶æ›¿æ¢æ—§çš„AOFæ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®ŒæˆAOFæ–‡ä»¶é‡å†™æ“ä½œ</p><h4 id="å‡ ä¸ªé—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ ä¸ªé—®é¢˜"></a> å‡ ä¸ªé—®é¢˜</h4><h5 id="aofé‡å†™ä¼šé˜»å¡å—"><a class="markdownIt-Anchor" href="#aofé‡å†™ä¼šé˜»å¡å—"></a> AOFé‡å†™ä¼šé˜»å¡å—ï¼Ÿ</h5><p>AOFé‡å†™è¿‡ç¨‹æ˜¯ç”±åå°è¿›ç¨‹bgrewriteaofæ¥å®Œæˆçš„ã€‚ä¸»çº¿ç¨‹forkå‡ºåå°çš„bgrewriteaofå­è¿›ç¨‹ï¼Œforkä¼šæŠŠä¸»çº¿ç¨‹çš„å†…å­˜æ‹·è´ä¸€ä»½ç»™bgrewriteaofå­è¿›ç¨‹ï¼Œè¿™é‡Œé¢å°±åŒ…å«äº†æ•°æ®åº“çš„æœ€æ–°æ•°æ®ã€‚ç„¶åï¼Œbgrewriteaofå­è¿›ç¨‹å°±å¯ä»¥åœ¨ä¸å½±å“ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œé€ä¸€æŠŠæ‹·è´çš„æ•°æ®å†™æˆæ“ä½œï¼Œè®°å…¥é‡å†™æ—¥å¿—ã€‚<br />æ‰€ä»¥aofåœ¨é‡å†™æ—¶ï¼Œåœ¨forkè¿›ç¨‹æ—¶æ˜¯ä¼šé˜»å¡ä½ä¸»çº¿ç¨‹çš„ã€‚</p><h5 id="aofæ—¥å¿—ä½•æ—¶ä¼šé‡å†™"><a class="markdownIt-Anchor" href="#aofæ—¥å¿—ä½•æ—¶ä¼šé‡å†™"></a> AOFæ—¥å¿—ä½•æ—¶ä¼šé‡å†™ï¼Ÿ</h5><p>æœ‰ä¸¤ä¸ªé…ç½®é¡¹æ§åˆ¶AOFé‡å†™çš„è§¦å‘ï¼š</p><ul><li>auto-aof-rewrite-min-size:è¡¨ç¤ºè¿è¡ŒAOFé‡å†™æ—¶æ–‡ä»¶çš„æœ€å°å¤§å°ï¼Œé»˜è®¤ä¸º64MBã€‚</li><li>auto-aof-rewrite-percentage:è¿™ä¸ªå€¼çš„è®¡ç®—æ–¹å¼æ˜¯ï¼Œå½“å‰aofæ–‡ä»¶å¤§å°å’Œä¸Šä¸€æ¬¡é‡å†™åaofæ–‡ä»¶å¤§å°çš„å·®å€¼ï¼Œå†é™¤ä»¥ä¸Šä¸€æ¬¡é‡å†™åaofæ–‡ä»¶å¤§å°ã€‚ä¹Ÿå°±æ˜¯å½“å‰aofæ–‡ä»¶æ¯”ä¸Šä¸€æ¬¡é‡å†™åaofæ–‡ä»¶çš„å¢é‡å¤§å°ï¼Œå’Œä¸Šä¸€æ¬¡é‡å†™åaofæ–‡ä»¶å¤§å°çš„æ¯”å€¼</li></ul><h5 id="ä¸ºä½•ä¸å¤ç”¨æ—§çš„aofæ–‡ä»¶"><a class="markdownIt-Anchor" href="#ä¸ºä½•ä¸å¤ç”¨æ—§çš„aofæ–‡ä»¶"></a> ä¸ºä½•ä¸å¤ç”¨æ—§çš„AOFæ–‡ä»¶ï¼Ÿ</h5><ul><li>çˆ¶å­è¿›ç¨‹åŒæ—¶å†™åŒä¸€ä¸ªæ–‡ä»¶ï¼Œæ¶‰åŠèµ„æºç«äº‰é—®é¢˜</li><li>å¦‚æœAOFé‡å†™å¤±è´¥ï¼Œåˆ™ä¼šå¯¼è‡´åŸAOFæ–‡ä»¶å†…å®¹ä¸¢å¤±</li></ul><h2 id="ä¼˜ç¼ºç‚¹-2"><a class="markdownIt-Anchor" href="#ä¼˜ç¼ºç‚¹-2"></a> ä¼˜ç¼ºç‚¹</h2><p>ä¼˜ç‚¹ï¼š</p><ul><li>çµæ´»é…ç½®ï¼Œæä¾›ä¸‰ç§æ–‡ä»¶å†™å…¥å’ŒåŒæ­¥ç­–ç•¥</li><li>AOFæ–‡ä»¶æ˜¯åªè¯»çš„ï¼Œä¸å­˜åœ¨æ–­ç”µæ–‡ä»¶æŒ‡é’ˆä¸¢å¤±é—®é¢˜</li><li>å½“AOFæ–‡ä»¶è¿‡å¤§æ—¶ï¼Œæ”¯æŒåå°è‡ªåŠ¨é‡å†™AOFæ–‡ä»¶ï¼Œè¯¥è¿‡ç¨‹ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±</li><li>AOFæ–‡ä»¶ä¿å­˜äº†Rediså†™å‘½ä»¤ï¼Œå¯è¯»æ€§å¼º</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ç›¸åŒæƒ…å†µä¸‹ï¼ŒAOFæ–‡ä»¶å¤§å°è¦æ¯”RDBæ–‡ä»¶å¤§</li><li>AOFæ‰§è¡Œè¿‡ç¨‹è¦æ¯”RDBæ…¢ï¼Œå–å†³äºä¸åŒçš„<code>fsync</code>ç­–ç•¥</li></ul><h1 id="3ä»æŒä¹…åŒ–æ•°æ®ä¸­æ¢å¤æ•°æ®"><a class="markdownIt-Anchor" href="#3ä»æŒä¹…åŒ–æ•°æ®ä¸­æ¢å¤æ•°æ®"></a> 3.ä»æŒä¹…åŒ–æ•°æ®ä¸­æ¢å¤æ•°æ®</h1><p>æ•°æ®çš„å¤‡ä»½ã€æŒä¹…åŒ–åšå®Œäº†ï¼Œæˆ‘ä»¬å¦‚ä½•ä»è¿™äº›æŒä¹…åŒ–æ–‡ä»¶ä¸­æ¢å¤æ•°æ®å‘¢ï¼Ÿå¦‚æœä¸€å°æœåŠ¡å™¨ä¸Šæœ‰æ—¢æœ‰RDBæ–‡ä»¶ï¼Œåˆæœ‰AOFæ–‡ä»¶ï¼Œè¯¥åŠ è½½è°å‘¢ï¼Ÿ</p><ul><li>ä¼˜å…ˆåŠ è½½AOF</li><li>å…¶æ¬¡æ‰æ˜¯RDB</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659589558800-241b111b-ef95-4c21-980d-dde4737a8616.jpeg" alt="" /></p><h1 id="å‚è€ƒæ–‡ç« "><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡ç« "></a> å‚è€ƒæ–‡ç« </h1><ul><li>ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹</li><li><a href="https://redis.io/docs/manual/">https://redis.io/docs/manual/</a></li><li><a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-rdb-aof.html">https://pdai.tech/md/db/nosql-redis/db-redis-x-rdb-aof.html</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AOF</tag>
      
      <tag>RDB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>InnoDBå­˜å‚¨å¼•æ“ä¸­çš„ç´¢å¼•</title>
    <link href="/2022/08/01/InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95/"/>
    <url>/2022/08/01/InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95/</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h1 id="0-å‰è¨€"><a class="markdownIt-Anchor" href="#0-å‰è¨€"></a> 0. å‰è¨€</h1><p>åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œè¡¨éƒ½æ˜¯æ ¹æ®ä¸»é”®é¡ºåºç»„ç»‡å­˜æ”¾çš„ï¼Œè¿™ç§å­˜å‚¨æ–¹å¼çš„è¡¨ç§°ä¸º<strong>ç´¢å¼•ç»„ç»‡è¡¨</strong>ï¼ˆindex organized tableï¼‰ã€‚<br />åœ¨InnoDBå­˜å‚¨å¼•æ“è¡¨ä¸­ï¼Œæ¯å¼ è¡¨éƒ½æœ‰ä¸ªä¸»é”®ï¼ˆPrimary Keyï¼‰ï¼Œå¦‚æœåœ¨åˆ›å»ºè¡¨æ—¶æ²¡æœ‰æ˜¾å¼åœ°å®šä¹‰ä¸»é”®ï¼Œåˆ™InnoDBå­˜å‚¨å¼•æ“ä¼šæŒ‰å¦‚ä¸‹æ–¹å¼é€‰æ‹©æˆ–åˆ›å»ºä¸»é”®ï¼š</p><ul><li>é¦–å…ˆåˆ¤æ–­è¡¨ä¸­æ˜¯å¦æœ‰<strong>éç©ºçš„å”¯ä¸€ç´¢å¼•</strong>ï¼ˆUnique NOT NULLï¼‰ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¯¥åˆ—å³ä¸ºä¸»é”®ï¼ˆå¦‚æœæœ‰å¤šä¸ªï¼Œåˆ™é€‰å–<strong>å®šä¹‰ç´¢å¼•é¡ºåºçš„ç¬¬ä¸€ä¸ª</strong>ï¼Œè€Œä¸æ˜¯å®šä¹‰åˆ—çš„é¡ºåºï¼‰</li><li>å¦‚æœä¸ç¬¦åˆä¸Šè¿°æ¡ä»¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª6å­—èŠ‚å¤§å°çš„æŒ‡é’ˆ</li></ul><h1 id="1innodbç´¢å¼•åˆ†ç±»"><a class="markdownIt-Anchor" href="#1innodbç´¢å¼•åˆ†ç±»"></a> 1.InnoDBç´¢å¼•åˆ†ç±»</h1><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659351643476-d531b370-5d15-46ae-b1e0-444befcf3219.jpeg" alt="" /></p><h1 id="2bæ ‘ç´¢å¼•"><a class="markdownIt-Anchor" href="#2bæ ‘ç´¢å¼•"></a> 2.B+æ ‘ç´¢å¼•</h1><h2 id="21èšé›†ç´¢å¼•"><a class="markdownIt-Anchor" href="#21èšé›†ç´¢å¼•"></a> 2.1èšé›†ç´¢å¼•</h2><p>èšé›†ç´¢å¼•ï¼Œåˆå«<strong>ä¸»é”®ç´¢å¼•</strong>ï¼ŒæŒ‰ç…§æ¯å¼ è¡¨çš„ä¸»é”®æ„å»ºä¸€é¢—B+æ ‘ï¼Œä¸€ä¸ªç´¢å¼•å°±æ˜¯ä¸€é¢—B+æ ‘ï¼Œå¶å­èŠ‚ç‚¹ï¼ˆæ•°æ®é¡µï¼‰å­˜æ”¾æ•´å¼ è¡¨çš„è¡Œè®°å½•æ•°æ®ã€‚</p><h3 id="ç‰¹ç‚¹"><a class="markdownIt-Anchor" href="#ç‰¹ç‚¹"></a> ç‰¹ç‚¹</h3><ul><li>èšé›†ç´¢å¼•çš„å­˜å‚¨å¹¶ä¸æ˜¯ç‰©ç†ä¸Šè¿ç»­ï¼Œè€Œæ˜¯é€»è¾‘ä¸Šè¿ç»­<ul><li>é¡µé€šè¿‡åŒå‘é“¾è¡¨é“¾æ¥ï¼Œé¡µæŒ‰ç…§ä¸»é”®çš„é¡ºåºæ’åº</li><li>æ¯ä¸ªé¡µä¸­çš„è®°å½•ä¹Ÿæ˜¯é€šè¿‡åŒå‘é“¾è¡¨è¿›è¡Œç»´æŠ¤çš„</li></ul></li><li>ç”±äºå®é™…çš„æ•°æ®é¡µåªèƒ½æŒ‰ç…§ä¸€æ£µB+æ ‘è¿›è¡Œæ’åºï¼Œå› æ­¤<strong>æ¯å¼ è¡¨åªèƒ½æ‹¥æœ‰ä¸€ä¸ªèšé›†ç´¢å¼•</strong>ã€‚</li><li>åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å€¾å‘äºé‡‡ç”¨èšé›†ç´¢å¼•ã€‚å› ä¸ºèšé›†ç´¢å¼•èƒ½å¤Ÿåœ¨B+æ ‘ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šç›´æ¥æ‰¾åˆ°æ•°æ®</li><li>æ­¤å¤–ï¼Œç”±äºå®šä¹‰äº†æ•°æ®çš„é€»è¾‘é¡ºåºï¼Œèšé›†ç´¢å¼•èƒ½å¤Ÿç‰¹åˆ«å¿«åœ°è®¿é—®é’ˆå¯¹<strong>èŒƒå›´å€¼çš„æŸ¥è¯¢å’Œæ’åº</strong>ã€‚</li></ul><h2 id="22éèšé›†ç´¢å¼•"><a class="markdownIt-Anchor" href="#22éèšé›†ç´¢å¼•"></a> 2.2éèšé›†ç´¢å¼•</h2><p>è¾…åŠ©ç´¢å¼•ï¼ˆSecondary Indexï¼Œä¹Ÿç§°éèšé›†ç´¢å¼•ï¼‰ï¼Œå¶å­èŠ‚ç‚¹å¹¶ä¸åŒ…å«è¡Œè®°å½•çš„å…¨éƒ¨æ•°æ®ã€‚å¶å­èŠ‚ç‚¹é™¤äº†åŒ…å«é”®å€¼ä»¥å¤–ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹ä¸­çš„ç´¢å¼•è¡Œä¸­è¿˜åŒ…å«äº†ä¸€ä¸ªä¹¦ç­¾ï¼ˆbookmarkï¼‰ã€‚è¯¥ä¹¦ç­¾ç”¨æ¥å‘Šè¯‰InnoDBå­˜å‚¨å¼•æ“å“ªé‡Œå¯ä»¥æ‰¾åˆ°ä¸ç´¢å¼•ç›¸å¯¹åº”çš„è¡Œæ•°æ®ã€‚ç”±äºInnoDBå­˜å‚¨å¼•æ“è¡¨æ˜¯ç´¢å¼•ç»„ç»‡è¡¨ï¼Œå› æ­¤InnoDBå­˜å‚¨å¼•æ“çš„è¾…åŠ©ç´¢å¼•çš„ä¹¦ç­¾å°±æ˜¯ç›¸åº”è¡Œæ•°æ®çš„<strong>èšé›†ç´¢å¼•é”®</strong></p><h3 id="ç‰¹ç‚¹-2"><a class="markdownIt-Anchor" href="#ç‰¹ç‚¹-2"></a> ç‰¹ç‚¹</h3><ul><li>è¾…åŠ©ç´¢å¼•çš„å­˜åœ¨å¹¶ä¸å½±å“æ•°æ®åœ¨èšé›†ç´¢å¼•ä¸­çš„ç»„ç»‡ï¼Œå› æ­¤<strong>æ¯å¼ è¡¨ä¸Šå¯ä»¥æœ‰å¤šä¸ªè¾…åŠ©ç´¢å¼•</strong></li></ul><h3 id="æŸ¥æ‰¾è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#æŸ¥æ‰¾è¿‡ç¨‹"></a> æŸ¥æ‰¾è¿‡ç¨‹</h3><p>æŸ¥æ‰¾ä¸€ä¸ªéèšé›†ç´¢å¼•ï¼ŒInnoDBå¼•æ“é¦–å…ˆä¼šéå†éèšé›†ç´¢å¼•B+æ ‘ï¼Œé€šè¿‡é¡µçº§åˆ«çš„ æŒ‡é’ˆæ‰¾åˆ°æŒ‡å‘èšé›†ç´¢å¼•çš„é”®IDï¼Œç„¶åé€šè¿‡è¿™ä¸ªIDé”®å†å»æŸ¥æ‰¾èšé›†ç´¢å¼•ï¼Œå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„è¡Œæ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš<strong>å›è¡¨</strong>ã€‚<br />ä¾‹å­ï¼š</p><ul><li>å¦‚æœè¯­å¥æ˜¯ select * from T where ID=500ï¼Œå³ä¸»é”®æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™åªéœ€è¦æœç´¢ ID è¿™æ£µ B+ æ ‘ï¼›</li><li>å¦‚æœè¯­å¥æ˜¯ select * from T where k=5ï¼Œå³æ™®é€šç´¢å¼•æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™éœ€è¦å…ˆæœç´¢ k ç´¢å¼•æ ‘ï¼Œå¾—åˆ° ID çš„å€¼ä¸º 500ï¼Œå†åˆ° ID ç´¢å¼•æ ‘æœç´¢ä¸€æ¬¡</li></ul><h1 id="3ç´¢å¼•ç»´æŠ¤"><a class="markdownIt-Anchor" href="#3ç´¢å¼•ç»´æŠ¤"></a> 3.ç´¢å¼•ç»´æŠ¤</h1><p>åœ¨æ’å…¥æ–°çºªå½•ã€åˆ é™¤æ—§çºªå½•æ—¶ï¼ŒB+ æ ‘ä¸ºäº†ç»´æŠ¤ç´¢å¼•æœ‰åºæ€§ï¼Œä¼šæ¶‰åŠåˆ°ç´¢å¼•çš„ç»´æŠ¤é—®é¢˜ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2022/png/29351684/1659343760942-7134bf0c-ac1b-4452-86de-f10b92d18198.png#clientId=uc2bce005-9626-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=450&amp;id=u0e0ffe97&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=856&amp;originWidth=1142&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;size=169686&amp;status=done&amp;style=none&amp;taskId=u336d4bf8-f074-4b19-9eae-081b66a42b7&amp;title=%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E5%92%8C%E9%9D%9E%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95&amp;width=601" alt="image.png" title="èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•" /></p><ul><li>å¦‚æœ åœ¨ä¸Šå›¾ä¸­æ’å…¥<code>ID=700</code>çš„è®°å½•ï¼Œåˆ™åœ¨R5åé¢æ’å…¥ä¸€æ¡æ–°è®°å½•å°±è¡Œï¼›</li><li>å¦‚æœæ’å…¥<code>ID=400</code>çš„è®°å½•ï¼Œåˆ™éœ€è¦ç§»åŠ¨R4ï¼ŒR5ï¼Œç„¶åæŠŠID=400æ’è¿›å»ï¼›æ›´ç³Ÿç³•çš„ï¼Œå¦‚æœR4æ‰€åœ¨çš„é¡µæ»¡äº†ï¼Œå°±éœ€è¦ç”³è¯·æ–°çš„é¡µï¼ŒæŒªåŠ¨éƒ¨åˆ†æ•°æ®åˆ°æ–°é¡µä¸Šé¢ï¼ˆ<strong>é¡µåˆ†è£‚</strong>ï¼‰</li></ul><p>æ³¨æ„ï¼š</p><ul><li>é¡µåˆ†è£‚ä¼šé™ä½ç©ºé—´åˆ©ç”¨ç‡ã€æ€§èƒ½</li><li>ä¸»é”®é•¿åº¦è¶Šå°ï¼Œæ™®é€šç´¢å¼•çš„å¶å­èŠ‚ç‚¹å°±è¶Šå°ï¼Œæ™®é€šç´¢å¼•å ç”¨çš„ç©ºé—´ä¹Ÿå°±è¶Šå°</li></ul><h1 id="4ç´¢å¼•åº”ç”¨"><a class="markdownIt-Anchor" href="#4ç´¢å¼•åº”ç”¨"></a> 4.ç´¢å¼•åº”ç”¨</h1><h2 id="41è”åˆç´¢å¼•"><a class="markdownIt-Anchor" href="#41è”åˆç´¢å¼•"></a> 4.1è”åˆç´¢å¼•</h2><p>è”åˆç´¢å¼•æ˜¯æŒ‡å¯¹è¡¨ä¸Šçš„å¤šä¸ªåˆ—è¿›è¡Œç´¢å¼•</p><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t<span class="token punctuation">(</span>a <span class="token keyword">INT</span><span class="token punctuation">,</span>b <span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">KEY</span> idx_a_b<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29351684/1659344528829-ccd7baaa-9f81-4f14-8f59-5ffff518efe0.png#clientId=uc2bce005-9626-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=191&amp;id=u9ec55153&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=335&amp;originWidth=986&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;size=69496&amp;status=done&amp;style=none&amp;taskId=u7e86ae48-1cd6-4207-bf9d-9d60b18cebb&amp;title=%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95&amp;width=563.4285714285714" alt="image.png" title="è”åˆç´¢å¼•" /><br />æ˜¾ç„¶ï¼Œ(a, b)çš„è”åˆç´¢å¼•ï¼Œä¹Ÿæ˜¯æŒ‰ç…§(a, b)æ’åºæ¥å­˜æ”¾çš„ã€‚</p><h3 id="æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™"><a class="markdownIt-Anchor" href="#æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™"></a> æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™</h3><p>è”åˆç´¢å¼•ä¸­ï¼Œå¦‚æœä½ çš„ SQL è¯­å¥ä¸­ç”¨åˆ°äº†è”åˆç´¢å¼•ä¸­çš„æœ€å·¦è¾¹çš„ç´¢å¼•ï¼Œé‚£ä¹ˆè¿™æ¡ SQL è¯­å¥å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªè”åˆç´¢å¼•å»è¿›è¡ŒåŒ¹é…ã€‚<br />è¿™ä¸ªæœ€å·¦å‰ç¼€å¯ä»¥æ˜¯ï¼š</p><ul><li>è”åˆç´¢å¼•çš„æœ€å·¦ N ä¸ªå­—æ®µï¼›</li><li>ä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²ç´¢å¼•çš„æœ€å·¦ M ä¸ªå­—ç¬¦</li></ul><p>ä¾‹å¦‚ï¼š</p><ul><li>SELECT*FROM TABLE WHERE a=xxx and b=xxxï¼Œæ˜¾å¯ä»¥ä½¿ç”¨ï¼ˆaï¼Œbï¼‰è¿™ä¸ªè”åˆç´¢å¼•çš„</li><li>SELECT*FROM TABLE WHERE a=xxxï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªï¼ˆaï¼Œbï¼‰ç´¢å¼•</li><li>SELECT*FROM TABLE WHERE b=xxxï¼Œåˆ™<strong>ä¸å¯ä»¥</strong>ä½¿ç”¨è¿™æ£µB+æ ‘ç´¢å¼•</li></ul><p>é‚£ä¹ˆï¼Œå¦‚æœéè¦æŸ¥è¯¢bï¼Œæ€ä¹ˆåŠï¼Ÿ</p><h3 id="å¦‚æœå®‰æ’è”åˆç´¢å¼•é¡ºåº"><a class="markdownIt-Anchor" href="#å¦‚æœå®‰æ’è”åˆç´¢å¼•é¡ºåº"></a> å¦‚æœå®‰æ’è”åˆç´¢å¼•é¡ºåºï¼Ÿ</h3><p>è€ƒè™‘ç´¢å¼•å­—æ®µçš„å¤ç”¨æ€§ã€‚</p><ul><li>å¦‚æœé€šè¿‡è°ƒæ•´é¡ºåºï¼Œå¯ä»¥å°‘ç»´æŠ¤ä¸€ä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆè¿™ä¸ªé¡ºåºå¾€å¾€å°±æ˜¯éœ€è¦ä¼˜å…ˆè€ƒè™‘é‡‡ç”¨çš„</li><li>è€ƒè™‘ç©ºé—´-æ€§èƒ½æƒè¡¡</li></ul><h3 id="ä¸ºä½•è¦ç”¨è”åˆç´¢å¼•"><a class="markdownIt-Anchor" href="#ä¸ºä½•è¦ç”¨è”åˆç´¢å¼•"></a> ä¸ºä½•è¦ç”¨è”åˆç´¢å¼•ï¼Ÿ</h3><ul><li>å‡å°‘ä¸å¿…è¦çš„ç´¢å¼•å¼€é”€ï¼š(a, b, c)è¿™æ ·ä¸€ä¸ªè”åˆç´¢å¼•ï¼Œå¯ä»¥æä¾›å¯¹(a, b, c)ï¼Œ(a, b)ï¼Œ(a)çš„ç´¢å¼•æŸ¥è¯¢</li><li>å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼š</li></ul><h2 id="42è¦†ç›–ç´¢å¼•"><a class="markdownIt-Anchor" href="#42è¦†ç›–ç´¢å¼•"></a> 4.2è¦†ç›–ç´¢å¼•</h2><p>InnoDBå­˜å‚¨å¼•æ“æ”¯æŒè¦†ç›–ç´¢å¼•ï¼ˆcovering indexï¼Œæˆ–ç§°ç´¢å¼•è¦†ç›–ï¼‰ï¼Œå³<strong>ä»è¾…åŠ©ç´¢å¼•ä¸­å°±å¯ä»¥å¾—åˆ°æŸ¥è¯¢çš„è®°å½•ï¼Œè€Œä¸éœ€è¦æŸ¥è¯¢èšé›†ç´¢å¼•ä¸­çš„è®°å½•ï¼ˆä¸éœ€è¦å›è¡¨ï¼‰</strong>ã€‚</p><h3 id="æ‰§è¡Œæµç¨‹"><a class="markdownIt-Anchor" href="#æ‰§è¡Œæµç¨‹"></a> æ‰§è¡Œæµç¨‹</h3><p>ä¸¾ä¸ªä¾‹å­ï¼š<br />å¯¹äºä¸‹å›¾(name, age)è”åˆç´¢å¼•ï¼Œå¦‚ä¸‹æŸ¥è¯¢ï¼š</p><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> AGE <span class="token keyword">FROM</span> <span class="token keyword">USER</span> <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'ç‹äº”'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>æ‰§è¡Œæµç¨‹ï¼š</p><ol><li>åœ¨(name,age)è”åˆç´¢å¼•æ ‘ä¸Šæ‰¾åˆ°åç§°ä¸ºç‹äº”çš„èŠ‚ç‚¹</li><li>è¯¥èŠ‚ç‚¹é‡ŒåŒ…å«ageä¿¡æ¯ï¼Œç›´æ¥è¿”å›10</li></ol><h3 id="ä¸ºä½•ä½¿ç”¨è¦†ç›–ç´¢å¼•"><a class="markdownIt-Anchor" href="#ä¸ºä½•ä½¿ç”¨è¦†ç›–ç´¢å¼•"></a> ä¸ºä½•ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Ÿ</h3><ul><li>ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„ä¸€ä¸ªå¥½å¤„æ˜¯è¾…åŠ©ç´¢å¼•ä¸åŒ…å«æ•´è¡Œè®°å½•çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ•…å…¶å¤§å°è¦è¿œå°äºèšé›†ç´¢å¼•ï¼Œå› æ­¤å¯ä»¥<strong>å‡å°‘å¤§é‡çš„IOæ“ä½œï¼Œé¿å…å›è¡¨</strong>ã€‚</li><li>æœ‰åˆ©äºæŸäº›ç»Ÿè®¡æ“ä½œï¼Œå‡å°‘IOæ“ä½œï¼Œä¾‹å¦‚count(*)</li></ul><h2 id="43ç´¢å¼•ä¸‹æ¨"><a class="markdownIt-Anchor" href="#43ç´¢å¼•ä¸‹æ¨"></a> 4.3ç´¢å¼•ä¸‹æ¨</h2><p>æ»¡è¶³æœ€å·¦å‰ç¼€åŸåˆ™çš„æ—¶å€™ï¼Œæœ€å·¦å‰ç¼€å¯ä»¥ç”¨äºåœ¨ç´¢å¼•ä¸­å®šä½è®°å½•ã€‚è¿™æ—¶ï¼Œä½ å¯èƒ½è¦é—®ï¼Œé‚£äº›ä¸ç¬¦åˆæœ€å·¦å‰ç¼€çš„éƒ¨åˆ†ï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ<br />ä¸¾ä¸ªä¾‹å­ï¼š<br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659349509932-74d84a2a-bbd9-4ab6-87e3-d965e9a3df4d.jpeg#clientId=uc2bce005-9626-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=441&amp;id=u72411cba&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=818&amp;originWidth=1142&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;size=91771&amp;status=done&amp;style=none&amp;taskId=u8647e64a-94b9-4134-ac21-3a3e240d147&amp;title=%28name%2C%20age%29%20%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95&amp;width=616.0000610351562" alt="image.png" title="(name, age) è”åˆç´¢å¼•" /><br />å¯¹äºå¦‚ä¸‹æŸ¥è¯¢ï¼Œåªèƒ½æ ¹æ®æœ€å·¦å‰ç¼€åŒ¹é…â€œå¼ â€æ¥å®šä½åˆ°ID3ï¼Œä¹‹ååˆ¤æ–­ <code>age=10</code>å’Œ <code>ismale=1</code>æ˜¯å¦æ»¡è¶³ã€‚</p><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tuser <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'å¼  %'</span> <span class="token operator">and</span> age<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">and</span> ismale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><ul><li>åœ¨ MySQL 5.6 ä¹‹å‰ï¼Œåªèƒ½ä» ID3 å¼€å§‹ä¸€ä¸ªä¸ªå›è¡¨ã€‚åˆ°ä¸»é”®ç´¢å¼•ä¸Šæ‰¾å‡ºæ•°æ®è¡Œï¼Œå†å¯¹æ¯”å­—æ®µå€¼ã€‚</li><li>MySQL 5.6 å¼•å…¥çš„ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–ï¼ˆindex condition pushdown)ï¼Œ å¯ä»¥<strong>åœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°</strong></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659349959530-524c8319-c3d6-4333-aa83-e2fa03b1fdb8.jpeg#clientId=uc2bce005-9626-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=452&amp;id=ua21a9b35&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=833&amp;originWidth=1142&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;size=94058&amp;status=done&amp;style=none&amp;taskId=uad783a80-e5d2-465e-b13b-ddfaa2bdbe2&amp;title=%E6%97%A0%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8&amp;width=620.0000610351562" alt="image.png" title="æ— ç´¢å¼•ä¸‹æ¨" /><br /><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29351684/1659349984973-d0255af8-758a-43d4-9437-8f102910a1ec.jpeg#clientId=uc2bce005-9626-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=461&amp;id=u03a6278a&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=856&amp;originWidth=1142&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;size=95952&amp;status=done&amp;style=none&amp;taskId=uad22cb43-5dea-4dea-a737-e209f12d90f&amp;title=%E6%9C%89%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8&amp;width=615" alt="image.png" title="æœ‰ç´¢å¼•ä¸‹æ¨" /><br />InnoDB åœ¨ (name,age) ç´¢å¼•å†…éƒ¨å°±åˆ¤æ–­äº† age æ˜¯å¦ç­‰äº 10ï¼Œå¯¹äºä¸ç­‰äº 10 çš„è®°å½•ï¼Œç›´æ¥åˆ¤æ–­å¹¶è·³è¿‡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç´¢å¼•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®ç°LRU/LFUç¼“å­˜</title>
    <link href="/2022/07/28/%E5%AE%9E%E7%8E%B0LRU-LFU%E7%BC%93%E5%AD%98/"/>
    <url>/2022/07/28/%E5%AE%9E%E7%8E%B0LRU-LFU%E7%BC%93%E5%AD%98/</url>
    
    <content type="html"><![CDATA[<h1 id="0å‰è¨€"><a class="markdownIt-Anchor" href="#0å‰è¨€"></a> 0.å‰è¨€</h1><p>ä¸ç®¡æ˜¯è®¡ç®—æœºç³»ç»Ÿé‡Œçš„Cacheç¼“å­˜ï¼Œè¿˜æ˜¯ç°åœ¨æµè¡Œçš„å†…å­˜ç¼“å­˜ï¼Œç”±äºç¼“å­˜å®¹é‡çš„é™åˆ¶ï¼Œéƒ½ä¼šè®¾è®¡æ·˜æ±°ç®—æ³•ï¼Œå³é€‰æ‹©å“ªä¸€å—â€œæ—§çš„â€æ•°æ®æ›¿æ¢å‡ºå»ï¼Œç”¨ä»¥å­˜æ”¾â€œæœ€æ–°â€çš„æ•°æ®ã€‚<br />å¸¸è§çš„æ·˜æ±°ç®—æ³•æœ‰ï¼š</p><ul><li>FIFOï¼šå…ˆè¿›å…ˆå‡ºï¼Œæœ€å…ˆè¿›å…¥ç¼“å­˜çš„æ•°æ®ï¼Œåœ¨ç¼“å­˜ç©ºé—´ä¸è¶³æ—¶è¢«æ¸…é™¤ï¼Œä¸ºäº†ä¿è¯æœ€æ–°æ•°æ®å¯ç”¨ï¼Œä¿è¯å®æ—¶æ€§</li><li>LRUï¼ˆLeast Recently Usedï¼‰ï¼šæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ï¼ŒåŸºäºè®¿é—®æ¬¡æ•°ï¼Œå»é™¤å‘½ä¸­æ¬¡æ•°æœ€å°‘çš„å…ƒç´ ï¼Œä¿è¯é«˜é¢‘æ•°æ®æœ‰æ•ˆæ€§</li><li>LFUï¼ˆLeast Frequently Usedï¼‰ï¼šæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼ŒåŸºäºè®¿é—®æ—¶é—´ï¼Œåœ¨è¢«è®¿é—®è¿‡çš„å…ƒç´ ä¸­å»é™¤æœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´ ï¼Œä¿è¯çƒ­ç‚¹æ•°æ®çš„æœ‰æ•ˆæ€§</li></ul><h1 id="1lru"><a class="markdownIt-Anchor" href="#1lru"></a> 1.LRU</h1><p>ä¸€èˆ¬é¢è¯•è€ƒå¯ŸLRUçš„ç®—æ³•é¢˜ï¼ŒåŸºæœ¬æ˜¯è€ƒå¯Ÿç‚¹å°±æ˜¯å®ç°åŒé“¾è¡¨ï¼Œä¸å¤ªå¯èƒ½è®©ä½ å®ç°å“ˆå¸Œè¡¨ï¼Œæ‰€ä»¥å“ˆå¸Œè¡¨ç›´æ¥ç”¨HashMapå³å¯ã€‚<br />å®ç° LRUCache ç±»ï¼š</p><ul><li>LRUCache(int capacity) ï¼šä»¥ æ­£æ•´æ•° ä½œä¸ºå®¹é‡ capacity åˆå§‹åŒ– LRU ç¼“å­˜</li><li>int get(int key)ï¼š å¦‚æœå…³é”®å­— key å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™è¿”å›å…³é”®å­—çš„å€¼ï¼Œå¦åˆ™è¿”å› -1 ã€‚</li><li>void put(int key, int value)ï¼š å¦‚æœå…³é”®å­— key å·²ç»å­˜åœ¨ï¼Œåˆ™å˜æ›´å…¶æ•°æ®å€¼ value ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å‘ç¼“å­˜ä¸­æ’å…¥è¯¥ç»„ key-value ã€‚å¦‚æœæ’å…¥æ“ä½œå¯¼è‡´å…³é”®å­—æ•°é‡è¶…è¿‡ capacity ï¼Œåˆ™åº”è¯¥ é€å‡º æœ€ä¹…æœªä½¿ç”¨çš„å…³é”®å­—</li></ul><p>å‡½æ•° get å’Œ put å¿…é¡»ä»¥ O(1) çš„å¹³å‡æ—¶é—´å¤æ‚åº¦è¿è¡Œ</p><h2 id="å®ç°æ€è·¯"><a class="markdownIt-Anchor" href="#å®ç°æ€è·¯"></a> å®ç°æ€è·¯</h2><ul><li>ä½¿ç”¨åŒé“¾è¡¨æ¥ç»´æŠ¤â€œæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨â€æ€§è´¨ï¼Œé“¾è¡¨è¡¨å¤´å­˜æ”¾oldestçš„æ•°æ®ï¼Œè¡¨å°¾å­˜æ”¾youngestçš„æ•°æ®</li><li>ä½¿ç”¨å“ˆå¸Œè¡¨æ¥ç»´æŠ¤key-valueé”®å€¼å¯¹</li></ul><p>æ¯æ¬¡getæ—¶ï¼š</p><ul><li>å¦‚æœkeyä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›-1</li><li>å¦‚æœkeyå­˜åœ¨ï¼Œåˆ™å…ˆå°†è¯¥èŠ‚ç‚¹ä»é“¾è¡¨ä¸­åˆ é™¤ï¼Œç„¶åå°†å…¶æ’å…¥é“¾è¡¨æœ«å°¾ï¼Œæ ‡è¯†åˆšåˆšè®¿é—®è¿‡</li></ul><p>æ¯æ¬¡putæ—¶ï¼š</p><ul><li><p>å¦‚æœkeyå­˜åœ¨ï¼Œåˆ™æ›´æ–°keyå¯¹åº”çš„å€¼ä¸ºvalueï¼Œå¹¶ä¸”å°†è¯¥èŠ‚ç‚¹ä»é“¾è¡¨ä¸­åˆ é™¤ï¼Œç„¶åå°†å…¶æ’å…¥é“¾è¡¨æœ«å°¾ï¼Œæ ‡è¯†åˆšåˆšè®¿é—®è¿‡</p></li><li><p>å¦‚æœkeyä¸å­˜åœ¨ï¼Œæ–°å»ºèŠ‚ç‚¹ï¼Œæ”¾å…¥å“ˆå¸Œè¡¨ä¸­ï¼Œå¹¶å°†èŠ‚ç‚¹æ”¾å…¥é“¾è¡¨å°¾éƒ¨ï¼Œéšååˆ¤æ–­ç¼“å­˜å®¹é‡ï¼Œå¦‚æœè¶…äº†ï¼Œåˆ™æ‰§è¡Œæ›¿æ¢ï¼š</p><ul><li>é€å‡ºâ€œæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨â€çš„èŠ‚ç‚¹ï¼Œå³è¡¨å¤´èŠ‚ç‚¹ï¼ŒåŒæ—¶å°†å¯¹åº”çš„keyä»å“ˆå¸Œè¡¨ä¸­åˆ é™¤</li></ul></li><li><p>æ³¨æ„ï¼šä¸å¯ç›´æ¥ä½¿ç”¨Javaä¸­çš„LinkedListï¼ŒåŸå› æœ‰äºŒï¼š</p><ul><li>LinkedListç±»çš„remove(int val)æ˜¯é€šè¿‡é€ä¸ªæ‰«ææ¯”è¾ƒæ¥å®ç°çš„ï¼Œå³æ—¶é—´å¤æ‚åº¦Oï¼ˆ1ï¼‰</li><li>é¢è¯•å®˜çš„è€ƒç‚¹å°±æ˜¯è®©ä½ è‡ªå·±å®ç°åŒé“¾è¡¨</li></ul></li></ul><h2 id="ä»£ç å®ç°"><a class="markdownIt-Anchor" href="#ä»£ç å®ç°"></a> ä»£ç å®ç°</h2><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">LRUCache</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>    <span class="token comment">// åŒå‘é“¾è¡¨ç»´æŠ¤LRUæ€§è´¨ï¼Œheadå­˜æ”¾oldest,tailå­˜æ”¾youngest</span>    <span class="token class-name">DoubleLinkedList</span> keyCache<span class="token punctuation">;</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">></span></span> map<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">LRUCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>keyCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DoubleLinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> node <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        keyCache<span class="token punctuation">.</span><span class="token function">removeSpecific</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        keyCache<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> node<span class="token punctuation">.</span>val<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// å¦‚æœå­˜åœ¨ï¼Œæ›´æ–°kvï¼Œæ›´æ–°lru</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Node</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            node<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// åˆ é™¤å½“å‰è®¿é—®çš„èŠ‚ç‚¹ï¼Œæ”¾å…¥æœ€å</span>            keyCache<span class="token punctuation">.</span><span class="token function">removeSpecific</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            keyCache<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>            keyCache<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> capacity <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// é€å‡ºæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨</span>                <span class="token keyword">int</span> k_oldest <span class="token operator">=</span> keyCache<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>k_oldest<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> key<span class="token punctuation">;</span>    <span class="token keyword">int</span> val<span class="token punctuation">;</span>    <span class="token class-name">Node</span> pre<span class="token punctuation">;</span>    <span class="token class-name">Node</span> next<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>        pre <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">DoubleLinkedList</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// è™šæ‹ŸèŠ‚ç‚¹ï¼Œç»Ÿä¸€æ“ä½œ</span>    <span class="token class-name">Node</span> head<span class="token punctuation">;</span>    <span class="token class-name">Node</span> tail<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">DoubleLinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>        tail<span class="token punctuation">.</span>pre <span class="token operator">=</span> head<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> tail_pre <span class="token operator">=</span> tail<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>        tail_pre<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>        node<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>        node<span class="token punctuation">.</span>pre <span class="token operator">=</span> tail_pre<span class="token punctuation">;</span>        tail<span class="token punctuation">.</span>pre <span class="token operator">=</span> node<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> head_next <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token keyword">int</span> k <span class="token operator">=</span> head_next<span class="token punctuation">.</span>key<span class="token punctuation">;</span>        head<span class="token punctuation">.</span>next <span class="token operator">=</span> head_next<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        head_next<span class="token punctuation">.</span>next<span class="token punctuation">.</span>pre <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token keyword">return</span> k<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">removeSpecific</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        node<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        node<span class="token punctuation">.</span>next<span class="token punctuation">.</span>pre <span class="token operator">=</span> node<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h1 id="2lfu"><a class="markdownIt-Anchor" href="#2lfu"></a> 2.LFU</h1><p>å®ç° LFUCache ç±»ï¼š</p><ul><li>LFUCache(int capacity) - ç”¨æ•°æ®ç»“æ„çš„å®¹é‡Â capacity åˆå§‹åŒ–å¯¹è±¡</li><li>int get(int key)Â - å¦‚æœé”®Â key å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™è·å–é”®çš„å€¼ï¼Œå¦åˆ™è¿”å› -1 ã€‚</li><li>void put(int key, int value)Â - å¦‚æœé”®Â key å·²å­˜åœ¨ï¼Œåˆ™å˜æ›´å…¶å€¼ï¼›å¦‚æœé”®ä¸å­˜åœ¨ï¼Œè¯·æ’å…¥é”®å€¼å¯¹ã€‚å½“ç¼“å­˜è¾¾åˆ°å…¶å®¹é‡Â capacity æ—¶ï¼Œåˆ™åº”è¯¥åœ¨æ’å…¥æ–°é¡¹ä¹‹å‰ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„é¡¹ã€‚åœ¨æ­¤é—®é¢˜ä¸­ï¼Œå½“å­˜åœ¨å¹³å±€ï¼ˆå³ä¸¤ä¸ªæˆ–æ›´å¤šä¸ªé”®å…·æœ‰ç›¸åŒä½¿ç”¨é¢‘ç‡ï¼‰æ—¶ï¼Œåº”è¯¥å»é™¤ æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ çš„é”®</li></ul><p>å‡½æ•° get å’Œ put å¿…é¡»ä»¥ O(1) çš„å¹³å‡æ—¶é—´å¤æ‚åº¦è¿è¡Œ</p><h2 id="å®ç°æ€è·¯-2"><a class="markdownIt-Anchor" href="#å®ç°æ€è·¯-2"></a> å®ç°æ€è·¯</h2><ul><li>ä¸ºäº†ç¡®å®šæœ€ä¸å¸¸ä½¿ç”¨çš„é”®ï¼Œå¯ä»¥ä¸ºç¼“å­˜ä¸­çš„æ¯ä¸ªé”®ç»´æŠ¤ä¸€ä¸ª ä½¿ç”¨è®¡æ•°å™¨ ï¼Œä½¿ç”¨è®¡æ•°æœ€å°çš„é”®æ˜¯æœ€ä¹…æœªä½¿ç”¨çš„é”®</li><li>å…¶ä»–å®ç°æ€è·¯ç±»ä¼¼LRU</li></ul><h2 id="ä»£ç å®ç°-2"><a class="markdownIt-Anchor" href="#ä»£ç å®ç°-2"></a> ä»£ç å®ç°</h2><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">LFUCache</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>    <span class="token keyword">int</span> minRef<span class="token punctuation">;</span>    <span class="token comment">// k -> node</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">></span></span> map<span class="token punctuation">;</span>    <span class="token comment">// ref -> dlist, ç»´æŠ¤LRU</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">DoubleLinkedList</span><span class="token punctuation">></span></span> refMap<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">LFUCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>        minRef <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        refMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Node</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// æ—§çš„å¼•ç”¨è®¡æ•°é“¾è¡¨ä¸­åˆ é™¤è¯¥èŠ‚ç‚¹</span>            refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeSpecific</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å¦‚æœdlistæ²¡æœ‰å…ƒç´ äº†ï¼ŒrefMapä¸­çš„keyä¹Ÿè¦åˆ é™¤</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                refMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// å¼•ç”¨è®¡æ•°+1</span>            node<span class="token punctuation">.</span>ref<span class="token operator">++</span><span class="token punctuation">;</span>            minRef <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>minRef<span class="token punctuation">,</span> node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// nodeæ’å…¥æ–°çš„å¼•ç”¨è®¡æ•°(+1åçš„)é“¾è¡¨</span>            <span class="token class-name">DoubleLinkedList</span> cur_ref_list <span class="token operator">=</span> refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token operator">==</span> cur_ref_list <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// æ–°å»ºé“¾è¡¨</span>                cur_ref_list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DoubleLinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                cur_ref_list<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                refMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">,</span> cur_ref_list<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                cur_ref_list<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> node<span class="token punctuation">.</span>val<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> capacity <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Node</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            node<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>            <span class="token comment">// æ—§çš„refMapåˆ é™¤å½“å‰refå¯¹åº”çš„kv</span>            refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeSpecific</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                refMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            node<span class="token punctuation">.</span>ref<span class="token operator">++</span><span class="token punctuation">;</span>            minRef <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>minRef<span class="token punctuation">,</span> node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">DoubleLinkedList</span> cur_ref_list <span class="token operator">=</span> refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token operator">==</span> cur_ref_list <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// æ–°å»ºé“¾è¡¨</span>                cur_ref_list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DoubleLinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                cur_ref_list<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                refMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">,</span> cur_ref_list<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                cur_ref_list<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> capacity <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// å…ˆæŒ‰minRef</span>                <span class="token class-name">DoubleLinkedList</span> min_ref_list <span class="token operator">=</span> refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>minRef<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span> min_ref_list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    min_ref_list <span class="token operator">=</span> refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">++</span>minRef<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// ç›¸åŒçš„minRefä¸‹ï¼Œåˆ é™¤LRU</span>                <span class="token keyword">int</span> k <span class="token operator">=</span> min_ref_list<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> min_ref_list<span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    refMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>minRef<span class="token punctuation">)</span><span class="token punctuation">;</span>                    minRef<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            minRef <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>minRef<span class="token punctuation">,</span> node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">DoubleLinkedList</span> cur_ref_list <span class="token operator">=</span> refMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token operator">==</span> cur_ref_list <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// æ–°å»ºé“¾è¡¨</span>                cur_ref_list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DoubleLinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                cur_ref_list<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                refMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ref<span class="token punctuation">,</span> cur_ref_list<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                cur_ref_list<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> key<span class="token punctuation">;</span>    <span class="token keyword">int</span> val<span class="token punctuation">;</span>    <span class="token keyword">int</span> ref<span class="token punctuation">;</span>    <span class="token class-name">Node</span> pre<span class="token punctuation">;</span>    <span class="token class-name">Node</span> next<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        pre <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">DoubleLinkedList</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// è™šæ‹ŸèŠ‚ç‚¹ï¼Œç»Ÿä¸€æ“ä½œ</span>    <span class="token class-name">Node</span> head<span class="token punctuation">;</span>    <span class="token class-name">Node</span> tail<span class="token punctuation">;</span>    <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">DoubleLinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>        tail<span class="token punctuation">.</span>pre <span class="token operator">=</span> head<span class="token punctuation">;</span>        size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> tail_pre <span class="token operator">=</span> tail<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>        tail_pre<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>        node<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>        node<span class="token punctuation">.</span>pre <span class="token operator">=</span> tail_pre<span class="token punctuation">;</span>        tail<span class="token punctuation">.</span>pre <span class="token operator">=</span> node<span class="token punctuation">;</span>        size<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Node</span> head_next <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token keyword">int</span> k <span class="token operator">=</span> head_next<span class="token punctuation">.</span>key<span class="token punctuation">;</span>        head<span class="token punctuation">.</span>next <span class="token operator">=</span> head_next<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        head_next<span class="token punctuation">.</span>next<span class="token punctuation">.</span>pre <span class="token operator">=</span> head<span class="token punctuation">;</span>        size<span class="token operator">--</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> k<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">removeSpecific</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        node<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        node<span class="token punctuation">.</span>next<span class="token punctuation">.</span>pre <span class="token operator">=</span> node<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>        size<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•ä¸æ•°æ®ç»“æ„</category>
      
    </categories>
    
    
    <tags>
      
      <tag>LRU</tag>
      
      <tag>LFU</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQLä¸­çš„ã€Œé”ã€ä¸ã€Œäº‹åŠ¡ã€</title>
    <link href="/2022/07/24/MySQL%E4%B8%AD%E7%9A%84%E3%80%8C%E9%94%81%E3%80%8D%E4%B8%8E%E3%80%8C%E4%BA%8B%E5%8A%A1%E3%80%8D/"/>
    <url>/2022/07/24/MySQL%E4%B8%AD%E7%9A%84%E3%80%8C%E9%94%81%E3%80%8D%E4%B8%8E%E3%80%8C%E4%BA%8B%E5%8A%A1%E3%80%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="0å‰è¨€"><a class="markdownIt-Anchor" href="#0å‰è¨€"></a> 0.å‰è¨€</h1><p>ä¸€æ–¹é¢è¦æœ€å¤§ç¨‹åº¦åœ°åˆ©ç”¨æ•°æ®åº“çš„å¹¶å‘è®¿é—®ï¼Œå¦å¤–ä¸€æ–¹é¢è¿˜è¦ç¡®ä¿æ¯ä¸ªç”¨æˆ·èƒ½ä»¥ä¸€è‡´çš„æ–¹å¼è¯»å–å’Œä¿®æ”¹æ•°æ®ã€‚å› æ­¤ï¼Œä¾¿æœ‰äº†ã€Œé”ã€ï¼Œç”¨äºå¯¹å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®[1]ã€‚</p><p>äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯æ•°æ®åº“åŒºåˆ«äºæ–‡ä»¶ç³»ç»Ÿçš„é‡è¦ç‰¹æ€§ä¹‹ä¸€ã€‚äº‹åŠ¡ä¼šæŠŠæ•°æ®åº“ä»ä¸€ç§ä¸€è‡´çŠ¶æ€è½¬æ¢ä¸ºå¦ä¸€ç§ä¸€è‡´çŠ¶æ€ã€‚åœ¨æ•°æ®åº“æäº¤å·¥ä½œæ—¶ï¼Œå¯ä»¥ç¡®ä¿è¦ä¹ˆæ‰€æœ‰ä¿®æ”¹éƒ½å·²ç»ä¿å­˜äº†ï¼Œè¦ä¹ˆæ‰€æœ‰ä¿®æ”¹éƒ½ä¸ä¿å­˜ã€‚<br />æœ¬æ–‡ä¸»è¦ä»¥InnoDBä¸ºä¾‹ï¼Œå­¦ä¹ é”å’Œäº‹åŠ¡çš„è®¾è®¡ä¸å®ç°ã€‚</p><h1 id="1é”"><a class="markdownIt-Anchor" href="#1é”"></a> 1.é”</h1><h2 id="é”åˆ†ç±»"><a class="markdownIt-Anchor" href="#é”åˆ†ç±»"></a> é”åˆ†ç±»</h2><ul><li>æ‚²è§‚é”ï¼šè®¤ä¸ºæ•°æ®éšæ—¶ä¼šè¢«ä¿®æ”¹ï¼Œæ•°æ®æ“çºµè¿‡ç¨‹ä¸­å§‹ç»ˆåŠ é”</li><li>ä¹è§‚é”ï¼šè®¤ä¸ºè‡ªå·±æ“ä½œæ•°æ®æ—¶ï¼Œæ²¡æœ‰äººä¿®æ”¹æ•°æ®ï¼Œä¸åŠ é”ï¼Œä½†æ˜¯æ›´æ–°æ—¶ä¼šåˆ¤æ–­åœ¨æ­¤æœŸé—´æœ‰æ— ä»–äººä¿®æ”¹ï¼ˆéœ€ç¼–ç å®ç°ï¼Œæ¯”å¦‚åŸºäºversionã€timestampï¼‰</li></ul><p>é€šå¸¸ï¼Œæˆ‘ä»¬è¯´çš„é”ä¸€èˆ¬æ˜¯æ‚²è§‚é”ã€‚ä»¥ä¸‹ï¼Œå¯¹æ‚²è§‚é”è¿›è¡Œåˆ†ç±»ï¼š</p><h3 id="æŒ‰ä½œç”¨èŒƒå›´"><a class="markdownIt-Anchor" href="#æŒ‰ä½œç”¨èŒƒå›´"></a> æŒ‰ä½œç”¨èŒƒå›´</h3><ul><li>è¡¨çº§é”ï¼šé”å®šæ•´å¼ è¡¨ï¼Œå°é”åŠ›åº¦é«˜ï¼Œå¹¶å‘åŠ›åº¦ä½ï¼Œä¸ä¼šæ­»é”<ul><li>InnoDBæä¾›äº† è¡Œé” å’Œ è¡¨é”ï¼Œé»˜è®¤æ˜¯ è¡Œé”</li></ul></li><li>è¡Œçº§é”ï¼šé”å®šè¡Œï¼Œå¹¶å‘åŠ›åº¦é«˜ï¼Œå¼€é”€ä¹Ÿé«˜ï¼Œå¯èƒ½ä¼šæ­»é”<ul><li>MyISAMæä¾› è¡¨é”</li></ul></li></ul><h3 id="æŒ‰ä½¿ç”¨æ€§è´¨"><a class="markdownIt-Anchor" href="#æŒ‰ä½¿ç”¨æ€§è´¨"></a> æŒ‰ä½¿ç”¨æ€§è´¨</h3><ul><li>å…±äº«é”ï¼ˆè¯»é”/Sé”ï¼‰ï¼šå…è®¸äº‹åŠ¡è¯»ä¸€è¡Œæ•°æ®</li><li>æ’ä»–é”ï¼ˆå†™é”/Xé”ï¼‰ï¼šå…è®¸äº‹åŠ¡åˆ é™¤æˆ–æ›´æ–°ä¸€è¡Œæ•°æ®</li></ul><p><em><strong>æ³¨æ„</strong></em>ï¼š</p><ol><li>å…±äº«é”ã€æ’ä»–é”éƒ½æ˜¯è¡Œé”</li><li>é”å…¼å®¹é—®é¢˜ï¼š<br /><font color=yellow>ä»…å…±äº«é”å’Œå…±äº«é”ä¹‹é—´å¯å…¼å®¹ï¼Œå…¶ä»–ç»„åˆä¸€å¾‹ä¸å…¼å®¹</font>ã€‚</li></ol><h2 id="é”çš„ç®—æ³•"><a class="markdownIt-Anchor" href="#é”çš„ç®—æ³•"></a> é”çš„ç®—æ³•</h2><p>InnoDBæœ‰ä¸‰ç§è¡Œé”çš„ç®—æ³•ï¼š</p><ul><li>Record Lockï¼šå•ä¸ªè¡Œè®°å½•ä¸Šçš„é”</li><li>Gap Lockï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä½†ä¸åŒ…å«è®°å½•æœ¬èº«</li><li>Next-Key Lockï¼šRecod Lock + Gap Lockï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼ŒåŒ…å«è®°å½•æœ¬èº«</li></ul><h2 id="é”å¸¦æ¥çš„é—®é¢˜å¹¶å‘ä¸€è‡´æ€§é—®é¢˜"><a class="markdownIt-Anchor" href="#é”å¸¦æ¥çš„é—®é¢˜å¹¶å‘ä¸€è‡´æ€§é—®é¢˜"></a> é”å¸¦æ¥çš„é—®é¢˜(å¹¶å‘ä¸€è‡´æ€§é—®é¢˜)</h2><p>é€šè¿‡é”å®šæœºåˆ¶å¯ä»¥å®ç°äº‹åŠ¡çš„éš”ç¦»æ€§è¦æ±‚ï¼Œä½¿å¾—äº‹åŠ¡å¯ä»¥å¹¶å‘åœ°å·¥ä½œã€‚é”æé«˜äº†å¹¶å‘ï¼Œä½†æ˜¯å´ä¼šå¸¦æ¥æ½œåœ¨çš„é—®é¢˜ã€‚ä¸è¿‡å¥½åœ¨å› ä¸ºäº‹åŠ¡éš”ç¦»æ€§çš„è¦æ±‚ï¼Œé”åªä¼šå¸¦æ¥ä¸‰ç§é—®é¢˜ï¼Œå¦‚æœå¯ä»¥é˜²æ­¢è¿™ä¸‰ç§æƒ…å†µçš„å‘ç”Ÿï¼Œé‚£å°†ä¸ä¼šäº§ç”Ÿå¹¶å‘å¼‚å¸¸ã€‚</p><h3 id="è„è¯»-è¿åéš”ç¦»æ€§"><a class="markdownIt-Anchor" href="#è„è¯»-è¿åéš”ç¦»æ€§"></a> è„è¯»-è¿åéš”ç¦»æ€§</h3><p>è„æ•°æ®æ˜¯æŒ‡<font color=yellow>æœªæäº¤</font>çš„æ•°æ®ï¼Œå¦‚æœè¯»åˆ°äº†è„æ•°æ®ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸­æœªæäº¤çš„æ•°æ®ï¼Œåˆ™æ˜¾ç„¶è¿åäº†æ•°æ®åº“çš„éš”ç¦»æ€§ã€‚</p><p>è„è¯»æ˜¯æŒ‡ï¼šåœ¨ä¸åŒçš„äº‹åŠ¡ä¸‹ï¼Œå½“å‰äº‹åŠ¡å¯ä»¥è¯»åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯»åˆ°äº†è„æ•°æ®ã€‚å‘ç”Ÿæ¡ä»¶æ˜¯ï¼šäº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯ <font color=yellow>READ UNCOMMITED</font>ã€‚</p><h3 id="ä¸å¯é‡å¤è¯»-è¿åä¸€è‡´æ€§"><a class="markdownIt-Anchor" href="#ä¸å¯é‡å¤è¯»-è¿åä¸€è‡´æ€§"></a> ä¸å¯é‡å¤è¯»-è¿åä¸€è‡´æ€§</h3><p>ä¸å¯é‡å¤è¯»æ˜¯æŒ‡åœ¨åŒä¸€äº‹åŠ¡ä¸‹ï¼Œè¿ç»­æ‰§è¡Œä¸¤æ¬¡åŒæ ·çš„SQLè¯­å¥å¯èƒ½å¯¼è‡´ä¸åŒçš„ç»“æœï¼Œç¬¬äºŒæ¬¡çš„SQLè¯­å¥å¯èƒ½ä¼šä¸ä¸€æ ·ï¼ˆ<font color=yellow>è¡Œæ•°æ®è¢«ä¿®æ”¹</font>ï¼‰ã€‚<br />ä¸å¯é‡å¤è¯»ä¸€èˆ¬æ¥è¯´ï¼Œä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ï¼ˆ<font color=yellow>æ•°æ®å·²ç»æäº¤</font>ï¼‰ã€‚</p><blockquote><p>åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œé€šè¿‡ä½¿ç”¨Next-Key Lockç®—æ³•æ¥é¿å…ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚åœ¨MySQLå®˜æ–¹æ–‡æ¡£ä¸­å°†ä¸å¯é‡å¤è¯»çš„é—®é¢˜å®šä¹‰ä¸ºPhantom Problemï¼Œå³å¹»åƒé—®é¢˜ã€‚åœ¨Next-Key Lockç®—æ³•ä¸‹ï¼Œå¯¹äºç´¢å¼•çš„æ‰«æï¼Œä¸ä»…æ˜¯é”ä½æ‰«æåˆ°çš„ç´¢å¼•ï¼Œè€Œä¸”è¿˜é”ä½è¿™äº›ç´¢å¼•è¦†ç›–çš„èŒƒå›´ï¼ˆgapï¼‰ã€‚å› æ­¤åœ¨è¿™ä¸ªèŒƒå›´å†…çš„æ’å…¥éƒ½æ˜¯ä¸å…è®¸çš„ã€‚è¿™æ ·å°±é¿å…äº†å¦å¤–çš„äº‹åŠ¡åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ•°æ®å¯¼è‡´çš„ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚<br />â€“ã€ŠMySQLæŠ€æœ¯å†…å¹•ï¼šInnoDBå­˜å‚¨å¼•æ“ã€‹</p></blockquote><h3 id="å¹»è¯»"><a class="markdownIt-Anchor" href="#å¹»è¯»"></a> å¹»è¯»</h3><p>å¹»è¯»æ˜¯æŒ‡åœ¨åŒä¸€äº‹åŠ¡ä¸‹ï¼Œè¿ç»­æ‰§è¡Œä¸¤æ¬¡åŒæ ·çš„SQLè¯­å¥å¯èƒ½å¯¼è‡´ä¸åŒçš„ç»“æœï¼Œç¬¬äºŒæ¬¡çš„SQLè¯­å¥å¯èƒ½ä¼š<font color=yellow>è¿”å›ä¹‹å‰ä¸å­˜åœ¨çš„è¡Œ</font>ã€‚</p><p><em><strong>æ³¨æ„</strong></em>ï¼š<br />æœ‰æ—¶å€™ï¼Œä¹ŸæŠŠå¹»è¯»æ”¾å…¥ä¸å¯é‡å¤è¯»èŒƒç•´ã€‚</p><h3 id="ä¸¢å¤±æ›´æ–°"><a class="markdownIt-Anchor" href="#ä¸¢å¤±æ›´æ–°"></a> ä¸¢å¤±æ›´æ–°</h3><p>ä¸€ä¸ªäº‹åŠ¡çš„æ›´æ–°æ“ä½œä¼šè¢«å¦ä¸€ä¸ªäº‹åŠ¡çš„æ›´æ–°æ“ä½œæ‰€è¦†ç›–ï¼Œä»è€Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚</p><p>åœ¨å½“å‰æ•°æ®åº“çš„ä»»ä½•éš”ç¦»çº§åˆ«ä¸‹ï¼Œ<strong>éƒ½ä¸ä¼šå¯¼è‡´æ•°æ®åº“ç†è®ºæ„ä¹‰ä¸Šçš„ä¸¢å¤±æ›´æ–°é—®é¢˜</strong>ã€‚è¿™æ˜¯å› ä¸ºï¼Œå³ä½¿æ˜¯READ UNCOMMITTEDçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå¯¹äºè¡Œçš„DMLæ“ä½œï¼Œéœ€è¦å¯¹è¡Œæˆ–å…¶ä»–ç²—ç²’åº¦çº§åˆ«çš„å¯¹è±¡åŠ é”ã€‚</p><p>ä½†æ˜¯åœ¨ç”Ÿäº§åº”ç”¨ä¸­è¿˜æœ‰å¦ä¸€ä¸ª<strong>é€»è¾‘æ„ä¹‰çš„ä¸¢å¤±æ›´æ–°é—®é¢˜</strong>ï¼Œè€Œå¯¼è‡´è¯¥é—®é¢˜çš„å¹¶ä¸æ˜¯å› ä¸ºæ•°æ®åº“æœ¬èº«çš„é—®é¢˜ã€‚</p><h1 id="2äº‹åŠ¡"><a class="markdownIt-Anchor" href="#2äº‹åŠ¡"></a> 2.äº‹åŠ¡</h1><p>äº‹åŠ¡æ˜¯è®¿é—®å¹¶æ›´æ–°æ•°æ®åº“ä¸­å„ç§æ•°æ®é¡¹çš„ä¸€ä¸ªç¨‹åºæ‰§è¡Œå•å…ƒã€‚åœ¨äº‹åŠ¡ä¸­çš„æ“ä½œï¼Œè¦ä¹ˆéƒ½åšä¿®æ”¹ï¼Œè¦ä¹ˆéƒ½ä¸åšï¼Œè¿™å°±æ˜¯äº‹åŠ¡çš„ç›®çš„ã€‚</p><p><img src="https://pdai.tech/_images/pics/185b9c49-4c13-4241-a848-fbff85c03a64.png" alt="image" /></p><p><strong>å¯¹äºInnoDBå­˜å‚¨å¼•æ“è€Œè¨€ï¼Œå…¶é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºREAD REPEATABLE</strong>ï¼Œå®Œå…¨éµå¾ªå’Œæ»¡è¶³äº‹åŠ¡çš„ACIDç‰¹æ€§ã€‚<br />MySQL é»˜è®¤é‡‡ç”¨è‡ªåŠ¨æäº¤æ¨¡å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸æ˜¾å¼ä½¿ç”¨START TRANSACTIONè¯­å¥æ¥å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆæ¯ä¸ªæŸ¥è¯¢éƒ½ä¼šè¢«å½“åšä¸€ä¸ªäº‹åŠ¡è‡ªåŠ¨æäº¤ã€‚</p><p>è¿™é‡Œï¼Œå…·ä½“ä»‹ç»äº‹åŠ¡çš„ACIDç‰¹æ€§ï¼Œå¹¶ç»™å‡ºç›¸å…³æ¦‚å¿µã€‚</p><h2 id="acidç‰¹æ€§"><a class="markdownIt-Anchor" href="#acidç‰¹æ€§"></a> ACIDç‰¹æ€§</h2><ul><li>Aï¼ˆAtomicityï¼‰ï¼ŒåŸå­æ€§ã€‚<br />åŸå­æ€§æŒ‡æ•´ä¸ªæ•°æ®åº“äº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ã€‚åªæœ‰ä½¿äº‹åŠ¡ä¸­æ‰€æœ‰çš„æ•°æ®åº“æ“ä½œéƒ½æ‰§è¡ŒæˆåŠŸï¼Œæ‰ç®—æ•´ä¸ªäº‹åŠ¡æˆåŠŸã€‚äº‹åŠ¡ä¸­ä»»ä½•ä¸€ä¸ªSQLè¯­å¥æ‰§è¡Œå¤±è´¥ï¼Œå·²ç»æ‰§è¡ŒæˆåŠŸçš„SQLè¯­å¥ä¹Ÿå¿…é¡»æ’¤é”€ï¼Œæ•°æ®åº“çŠ¶æ€åº”è¯¥é€€å›åˆ°æ‰§è¡Œäº‹åŠ¡å‰çš„çŠ¶æ€ã€‚</li><li>Cï¼ˆconsistencyï¼‰ï¼Œä¸€è‡´æ€§ã€‚ä¸€è‡´æ€§æŒ‡äº‹åŠ¡å°†æ•°æ®åº“ä»ä¸€ç§çŠ¶æ€è½¬å˜ä¸ºä¸‹ä¸€ç§ä¸€è‡´çš„çŠ¶æ€ã€‚åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åã€‚</li><li>Iï¼ˆisolationï¼‰ï¼Œéš”ç¦»æ€§ã€‚éš”ç¦»æ€§è¿˜æœ‰å…¶ä»–çš„ç§°å‘¼ï¼Œå¦‚å¹¶å‘æ§åˆ¶ï¼ˆconcurrency controlï¼‰ã€å¯ä¸²è¡ŒåŒ–ï¼ˆserializabilityï¼‰ã€é”ï¼ˆlockingï¼‰ç­‰ã€‚äº‹åŠ¡çš„éš”ç¦»æ€§è¦æ±‚æ¯ä¸ªè¯»å†™äº‹åŠ¡çš„å¯¹è±¡å¯¹å…¶ä»–äº‹åŠ¡çš„æ“ä½œå¯¹è±¡èƒ½ç›¸äº’åˆ†ç¦»ï¼Œå³è¯¥äº‹åŠ¡æäº¤å‰å¯¹å…¶ä»–äº‹åŠ¡éƒ½ä¸å¯è§ï¼Œé€šå¸¸è¿™ä½¿ç”¨é”æ¥å®ç°ã€‚</li><li>Dï¼ˆdurabilityï¼‰ï¼ŒæŒä¹…æ€§ã€‚äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå…¶ç»“æœå°±æ˜¯æ°¸ä¹…æ€§çš„ã€‚å³ä½¿å‘ç”Ÿå®•æœºç­‰æ•…éšœï¼Œæ•°æ®åº“ä¹Ÿèƒ½å°†æ•°æ®æ¢å¤ã€‚</li></ul><p><font color=red><em><strong>æ³¨æ„ï¼šACIDä¸æ˜¯å¹³çº§çš„å…³ç³»</strong></em></font></p><ul><li>åªæœ‰æ»¡è¶³ä¸€è‡´æ€§ï¼Œäº‹åŠ¡çš„æ‰§è¡Œç»“æœæ‰æ˜¯æ­£ç¡®çš„ã€‚</li><li>åœ¨æ— å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œéš”ç¦»æ€§ä¸€å®šèƒ½å¤Ÿæ»¡è¶³ã€‚æ­¤æ—¶åªè¦èƒ½æ»¡è¶³åŸå­æ€§ï¼Œå°±ä¸€å®šèƒ½æ»¡è¶³ä¸€è‡´æ€§ã€‚</li><li>åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œäº‹åŠ¡ä¸ä»…è¦æ»¡è¶³åŸå­æ€§ï¼Œè¿˜éœ€è¦æ»¡è¶³éš”ç¦»æ€§ï¼Œæ‰èƒ½æ»¡è¶³ä¸€è‡´æ€§ã€‚</li><li>äº‹åŠ¡æ»¡è¶³æŒä¹…åŒ–æ˜¯ä¸ºäº†èƒ½åº”å¯¹æ•°æ®åº“å´©æºƒçš„æƒ…å†µã€‚</li></ul><p><img src="https://pdai.tech/_images/pics/a58e294a-615d-4ea0-9fbf-064a6daec4b2.png" alt="image" /></p><h2 id="äº‹åŠ¡çš„åˆ†ç±»"><a class="markdownIt-Anchor" href="#äº‹åŠ¡çš„åˆ†ç±»"></a> äº‹åŠ¡çš„åˆ†ç±»</h2><ul><li>æ‰å¹³äº‹åŠ¡ï¼ˆFlat Transactionsï¼‰</li><li>å¸¦æœ‰ä¿å­˜ç‚¹çš„æ‰å¹³äº‹åŠ¡ï¼ˆFlat Transactions with Savepointsï¼‰</li><li>é“¾äº‹åŠ¡ï¼ˆChained Transactionsï¼‰</li><li>åµŒå¥—äº‹åŠ¡ï¼ˆNested Transactionsï¼‰</li><li>åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆDistributed Transactionsï¼‰</li></ul><h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«"><a class="markdownIt-Anchor" href="#äº‹åŠ¡éš”ç¦»çº§åˆ«"></a> äº‹åŠ¡éš”ç¦»çº§åˆ«</h2><ul><li>æœªæäº¤è¯»(READ UNCOMMITTED)ï¼šäº‹åŠ¡ä¸­çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„</li><li>æäº¤è¯»(READ COMMITTED)ï¼šä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹åœ¨æäº¤ä¹‹å‰å¯¹å…¶å®ƒäº‹åŠ¡æ˜¯ä¸å¯è§çš„</li><li>å¯é‡å¤è¯»(REPEATABLE READ)ï¼šä¿è¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒæ ·æ•°æ®çš„ç»“æœæ˜¯ä¸€æ ·çš„</li><li>å¯ä¸²è¡ŒåŒ–(SERIALIZABLE)ï¼šå¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œ</li></ul><p>READ UNCOMMITTEDç§°ä¸ºæµè§ˆè®¿é—®ï¼ˆbrowse accessï¼‰ï¼Œä»…ä»…é’ˆå¯¹äº‹åŠ¡è€Œè¨€çš„ã€‚READ COMMITTEDç§°ä¸ºæ¸¸æ ‡ç¨³å®šï¼ˆcursor stabilityï¼‰ã€‚REPEATABLE READæ˜¯2.9999Â°çš„éš”ç¦»ï¼Œæ²¡æœ‰å¹»è¯»çš„ä¿æŠ¤ã€‚SERIALIZABLEç§°ä¸ºéš”ç¦»ï¼Œæˆ–3Â°çš„éš”ç¦»ã€‚</p><table><thead><tr><th style="text-align:left">éš”ç¦»çº§åˆ«</th><th style="text-align:center">è„è¯»å¯èƒ½æ€§</th><th style="text-align:center">ä¸å¯é‡å¤è¯»å¯èƒ½æ€§</th><th style="text-align:right">å¹»è¯»å¯èƒ½æ€§</th></tr></thead><tbody><tr><td style="text-align:left">æœªæäº¤è¯»</td><td style="text-align:center">âœ“</td><td style="text-align:center">âœ“</td><td style="text-align:right">âœ“</td></tr><tr><td style="text-align:left">æäº¤è¯»</td><td style="text-align:center">âœ•</td><td style="text-align:center">âœ“</td><td style="text-align:right">âœ“</td></tr><tr><td style="text-align:left">å¯é‡å¤è¯»</td><td style="text-align:center">âœ•</td><td style="text-align:center">âœ•</td><td style="text-align:right">âœ“</td></tr><tr><td style="text-align:left">å¯ä¸²è¡ŒåŒ–</td><td style="text-align:center">âœ•</td><td style="text-align:center">âœ•</td><td style="text-align:right">âœ•</td></tr></tbody></table><blockquote><p>InnoDBå­˜å‚¨å¼•æ“é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯REPEATABLE READï¼Œä½†æ˜¯ä¸æ ‡å‡†SQLä¸åŒçš„æ˜¯ï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œä½¿ç”¨Next-Key Locké”çš„ç®—æ³•ï¼Œå› æ­¤é¿å…å¹»è¯»çš„äº§ç”Ÿã€‚è¿™ä¸å…¶ä»–æ•°æ®åº“ç³»ç»Ÿï¼ˆå¦‚Microsoft SQL Serveræ•°æ®åº“ï¼‰æ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥è¯´ï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨é»˜è®¤çš„REPEATABLE READçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹å·²ç»èƒ½å®Œå…¨ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§è¦æ±‚ï¼Œå³è¾¾åˆ°SQLæ ‡å‡†çš„SERIALIZABLEéš”ç¦»çº§åˆ«ã€‚</p><p>éš”ç¦»çº§åˆ«è¶Šä½ï¼Œäº‹åŠ¡è¯·æ±‚çš„é”è¶Šå°‘æˆ–ä¿æŒé”çš„æ—¶é—´å°±è¶ŠçŸ­ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯READ COMMITTEDã€‚</p></blockquote><h2 id="äº‹åŠ¡çš„å®ç°"><a class="markdownIt-Anchor" href="#äº‹åŠ¡çš„å®ç°"></a> äº‹åŠ¡çš„å®ç°</h2><ul><li>éš”ç¦»æ€§ï¼šç”±é”å®ç°</li><li>åŸå­æ€§ã€æŒä¹…æ€§ï¼šç”±redo logå®ç°<ul><li>redo log æ˜¯InnoDB å¼•æ“å±‚ç‰¹æœ‰</li><li>ç‰©ç†æ—¥å¿—ï¼Œè®°å½•â€œæŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€</li><li>å¾ªç¯å†™çš„ï¼Œç©ºé—´å›ºå®šä¼šç”¨å®Œ</li><li>ä¿è¯å³ä½¿æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œä¹‹å‰æäº¤çš„è®°å½•éƒ½ä¸ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªèƒ½åŠ›ç§°ä¸º crash-safe</li><li>å½“æœ‰ä¸€æ¡è®°å½•éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼ŒInnoDB å¼•æ“å°±ä¼šå…ˆæŠŠè®°å½•å†™åˆ° redo log é‡Œé¢ï¼Œå¹¶æ›´æ–°å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚</li><li>åŒæ—¶ï¼ŒInnoDB å¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªæ“ä½œè®°å½•æ›´æ–°åˆ°ç£ç›˜é‡Œé¢ï¼Œè€Œè¿™ä¸ªæ›´æ–°å¾€å¾€æ˜¯åœ¨ç³»ç»Ÿæ¯”è¾ƒç©ºé—²çš„æ—¶å€™åš</li></ul></li><li>ä¸€è‡´æ€§ï¼šç”±undo logå®ç°<!-- - Serverå±‚å®ç°undo logï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ç”¨- é€»è¾‘æ—¥å¿—ï¼Œè®°å½•â€œè¯­å¥çš„åŸå§‹é€»è¾‘â€-  è¿½åŠ å†™ï¼Œä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿— --><ul><li>undo log æ˜¯é€»è¾‘æ—¥å¿—ï¼Œå› æ­¤åªæ˜¯å°†æ•°æ®åº“é€»è¾‘åœ°æ¢å¤åˆ°åŸæ¥çš„æ ·å­</li><li>è®°å½•äº†äº‹åŠ¡çš„è¡Œä¸ºï¼Œå¯ä»¥å¾ˆå¥½åœ°é€šè¿‡å…¶å¯¹é¡µè¿›è¡Œâ€œé‡åšâ€æ“ä½œ</li><li>undo log ä¼šäº§ç”Ÿ redo log</li></ul></li></ul><h1 id="3å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶mvcc"><a class="markdownIt-Anchor" href="#3å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶mvcc"></a> 3.å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰</h1><blockquote><p>MySQLçš„å¤§å¤šæ•°äº‹åŠ¡å‹å­˜å‚¨å¼•æ“å®ç°çš„éƒ½ä¸æ˜¯ç®€å•çš„è¡Œçº§é”ã€‚åŸºäºæå‡å¹¶å‘æ€§èƒ½çš„è€ƒè™‘ï¼Œå®ƒä»¬ä¸€èˆ¬éƒ½åŒæ—¶å®ç°äº†å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ã€‚ä¸ä»…æ˜¯MySQLï¼ŒåŒ…æ‹¬Oracleã€PostgreSQLç­‰å…¶ä»–æ•°æ®åº“ç³»ç»Ÿä¹Ÿéƒ½å®ç°äº†MVCCï¼Œä½†å„è‡ªçš„å®ç°æœºåˆ¶ä¸å°½ç›¸åŒï¼Œå› ä¸ºMVCCæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„å®ç°æ ‡å‡†ã€‚</p></blockquote><ul><li>å¯ä»¥è®¤ä¸ºMVCCæ˜¯è¡Œçº§é”çš„ä¸€ä¸ªå˜ç§ï¼Œä½†æ˜¯å®ƒåœ¨å¾ˆå¤šæƒ…å†µä¸‹é¿å…äº†åŠ é”æ“ä½œï¼Œå› æ­¤å¼€é”€æ›´ä½ã€‚è™½ç„¶å®ç°æœºåˆ¶æœ‰æ‰€ä¸åŒï¼Œä½†å¤§éƒ½å®ç°äº†éé˜»å¡çš„è¯»æ“ä½œï¼Œå†™æ“ä½œä¹Ÿåªé”å®šå¿…è¦çš„è¡Œã€‚</li><li><font color=yellow>MVCCåªåœ¨REPEATABLE READå’ŒREAD COMMITTEDä¸¤ä¸ªéš”ç¦»çº§åˆ«ä¸‹å·¥ä½œ</font>ã€‚å…¶ä»–ä¸¤ä¸ªéš”ç¦»çº§åˆ«éƒ½å’ŒMVCCä¸å…¼å®¹ï¼Œå› ä¸ºREAD UNCOMMITTEDæ€»æ˜¯è¯»å–æœ€æ–°çš„æ•°æ®è¡Œï¼Œè€Œä¸æ˜¯ç¬¦åˆå½“å‰äº‹åŠ¡ç‰ˆæœ¬çš„æ•°æ®è¡Œã€‚è€ŒSERIALIZABLEåˆ™ä¼šå¯¹æ‰€æœ‰è¯»å–çš„è¡Œéƒ½åŠ é”ã€‚</li></ul><h2 id="innodbå®ç°"><a class="markdownIt-Anchor" href="#innodbå®ç°"></a> InnoDBå®ç°</h2><p>MVCCçš„å®ç°ï¼Œæ˜¯é€šè¿‡ä¿å­˜æ•°æ®åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§æ¥å®ç°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡éœ€è¦æ‰§è¡Œå¤šé•¿æ—¶é—´ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„æ•°æ®éƒ½æ˜¯ä¸€è‡´çš„ã€‚æ ¹æ®äº‹åŠ¡å¼€å§‹çš„æ—¶é—´ä¸åŒï¼Œæ¯ä¸ªäº‹åŠ¡å¯¹åŒä¸€å¼ è¡¨ï¼ŒåŒä¸€æ—¶åˆ»çœ‹åˆ°çš„æ•°æ®å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><ul><li>åˆ›å»ºæ—¶é—´</li><li>è¿‡æœŸæ—¶é—´</li></ul><p>InnoDBçš„MVCCï¼Œæ˜¯é€šè¿‡åœ¨æ¯è¡Œè®°å½•åé¢ä¿å­˜ä¸¤ä¸ªéšè—çš„åˆ—æ¥å®ç°çš„ã€‚<font color=yellow>è¿™ä¸¤ä¸ªåˆ—ï¼Œä¸€ä¸ªä¿å­˜äº†è¡Œçš„åˆ›å»ºæ—¶é—´ï¼Œä¸€ä¸ªä¿å­˜è¡Œçš„è¿‡æœŸæ—¶é—´ï¼ˆæˆ–åˆ é™¤æ—¶é—´ï¼‰</font>ã€‚å½“ç„¶å­˜å‚¨çš„å¹¶ä¸æ˜¯å®é™…çš„æ—¶é—´å€¼ï¼Œè€Œæ˜¯***ç³»ç»Ÿç‰ˆæœ¬å·ï¼ˆsystem version numberï¼‰***ã€‚</p><p>æ¯å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œç³»ç»Ÿç‰ˆæœ¬å·éƒ½ä¼šè‡ªåŠ¨é€’å¢ã€‚äº‹åŠ¡å¼€å§‹æ—¶åˆ»çš„ç³»ç»Ÿç‰ˆæœ¬å·ä¼šä½œä¸ºäº‹åŠ¡çš„ç‰ˆæœ¬å·ï¼Œç”¨æ¥å’ŒæŸ¥è¯¢åˆ°çš„æ¯è¡Œè®°å½•çš„ç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒã€‚ä¸‹é¢çœ‹ä¸€ä¸‹åœ¨REPEATABLE READéš”ç¦»çº§åˆ«ä¸‹ï¼ŒMVCCå…·ä½“æ˜¯å¦‚ä½•æ“ä½œçš„ã€‚</p><h3 id="select"><a class="markdownIt-Anchor" href="#select"></a> SELECT</h3><ul><li>InnoDBåªæŸ¥æ‰¾ç‰ˆæœ¬æ—©äºå½“å‰äº‹åŠ¡ç‰ˆæœ¬çš„æ•°æ®è¡Œï¼ˆç¡®ä¿äº‹åŠ¡è¯»å–çš„è¡Œï¼Œè¦ä¹ˆå·²å­˜åœ¨ï¼Œè¦ä¹ˆæ˜¯äº‹åŠ¡è‡ªèº«æ’å…¥/ä¿®æ”¹çš„ï¼‰</li><li>è¡Œçš„åˆ é™¤ç‰ˆæœ¬è¦ä¹ˆæœªå®šä¹‰ï¼Œè¦ä¹ˆå¤§äºå½“å‰äº‹åŠ¡ç‰ˆæœ¬å·ï¼ˆç¡®ä¿äº‹åŠ¡è¯»å–åˆ°çš„è¡Œï¼Œåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰æœªè¢«åˆ é™¤ï¼‰</li></ul><h3 id="insert"><a class="markdownIt-Anchor" href="#insert"></a> INSERT</h3><ul><li>InnoDBä¸ºæ–°æ’å…¥çš„æ¯ä¸€è¡Œä¿å­˜å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºè¡Œç‰ˆæœ¬å·</li></ul><h3 id="delete"><a class="markdownIt-Anchor" href="#delete"></a> DELETE</h3><ul><li>InnoDBä¸ºåˆ é™¤çš„æ¯ä¸€è¡Œä¿å­˜å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºè¡Œåˆ é™¤æ ‡è¯†</li></ul><h3 id="update"><a class="markdownIt-Anchor" href="#update"></a> UPDATE</h3><ul><li>InnoDBä¸ºæ’å…¥ä¸€è¡Œæ–°è®°å½•ï¼Œä¿å­˜å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºè¡Œç‰ˆæœ¬å·ï¼ŒåŒæ—¶ä¿å­˜å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·åˆ°åŸæ¥çš„è¡Œä½œä¸ºè¡Œåˆ é™¤æ ‡è¯†</li></ul>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é”</tag>
      
      <tag>äº‹åŠ¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Œåˆ†å¸ƒå¼IDã€ç”Ÿæˆæ–¹æ¡ˆ</title>
    <link href="/2022/07/22/%E3%80%8C%E5%88%86%E5%B8%83%E5%BC%8FID%E3%80%8D%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88/"/>
    <url>/2022/07/22/%E3%80%8C%E5%88%86%E5%B8%83%E5%BC%8FID%E3%80%8D%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h1><p>å…¨å±€å”¯ä¸€IDï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªå®ä½“ï¼ˆç”¨æˆ·ã€äº§å“ç­‰ï¼‰ã€‚åœ¨ä¼ ç»Ÿçš„å•æœºæ¶æ„ä¸‹ï¼Œä¸€ç§å¸¸ç”¨çš„åšæ³•æ˜¯ä½¿ç”¨æ•°æ®åº“è‡ªå¢IDæ¥ä½œä¸ºä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ªå®ä½“ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼Œè™½ç„¶å¯ä»¥è®¾ç½®è‡ªå¢èµ·å§‹å€¼å’Œè‡ªå¢æ­¥é•¿æ¥å®ç°ä½†æ˜¯å—é™äºä¸šåŠ¡è§„æ¨¡ï¼Œéš¾ä»¥æ‰©å±•ï¼Œä¸”å—é™äºDBæ€§èƒ½ç“¶é¢ˆã€‚</p><p>ç°æœ‰çš„åˆ†å¸ƒå¼å…¨å±€å”¯ä¸€IDå¯å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç±»ï¼š</p><ul><li>UUID</li><li>åŸºäºDB</li><li>åŸºäºé›ªèŠ±ID(Snowflake)æ–¹æ¡ˆ</li></ul><h2 id="éœ€æ»¡è¶³çš„æ¡ä»¶"><a class="markdownIt-Anchor" href="#éœ€æ»¡è¶³çš„æ¡ä»¶"></a> éœ€æ»¡è¶³çš„æ¡ä»¶</h2><ul><li>å…¨å±€å”¯ä¸€ï¼šå¿…é¡»ä¿è¯IDæ˜¯å…¨å±€æ€§å”¯ä¸€çš„ï¼ŒåŸºæœ¬è¦æ±‚</li><li>é«˜æ€§èƒ½ï¼šé«˜å¯ç”¨ä½å»¶æ—¶ï¼ŒIDç”Ÿæˆå“åº”è¦å—ï¼Œå¦åˆ™åå€’ä¼šæˆä¸ºä¸šåŠ¡ç“¶é¢ˆ</li><li>é«˜å¯ç”¨ï¼š100%çš„å¯ç”¨æ€§æ˜¯éª—äººçš„ï¼Œä½†æ˜¯ä¹Ÿè¦æ— é™æ¥è¿‘äº100%çš„å¯ç”¨æ€§</li><li>å¥½æ¥å…¥ï¼šè¦ç§‰ç€æ‹¿æ¥å³ç”¨çš„è®¾è®¡åŸåˆ™ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡å’Œå®ç°ä¸Šè¦å°½å¯èƒ½çš„ç®€å•</li><li>è¶‹åŠ¿é€’å¢ï¼šæœ€å¥½è¶‹åŠ¿é€’å¢ï¼Œè¿™ä¸ªè¦æ±‚å°±å¾—çœ‹å…·ä½“ä¸šåŠ¡åœºæ™¯äº†ï¼Œä¸€èˆ¬ä¸ä¸¥æ ¼è¦æ±‚</li></ul><h1 id="1uuid"><a class="markdownIt-Anchor" href="#1uuid"></a> 1.UUID</h1><p>UUID ï¼ˆUniversally Unique Identifierï¼‰ï¼Œé€šç”¨å”¯ä¸€è¯†åˆ«ç çš„ç¼©å†™ã€‚UUIDæ˜¯ç”±ä¸€ç»„32ä½æ•°çš„16è¿›åˆ¶æ•°å­—æ‰€æ„æˆï¼Œæ‰€ä»¥UUIDç†è®ºä¸Šçš„æ€»æ•°ä¸º 16<sup>32=2</sup>128ï¼Œçº¦ç­‰äº 3.4 x 10^38ã€‚ä¹Ÿå°±æ˜¯è¯´è‹¥æ¯çº³ç§’äº§ç”Ÿ1å…†ä¸ªUUIDï¼Œè¦èŠ±100äº¿å¹´æ‰ä¼šå°†æ‰€æœ‰UUIDç”¨å®Œã€‚</p><p>ç”Ÿæˆçš„UUIDæ˜¯ç”± 8-4-4-4-12æ ¼å¼çš„æ•°æ®ç»„æˆï¼Œå…¶ä¸­32ä¸ªå­—ç¬¦å’Œ4ä¸ªè¿å­—ç¬¦â€™ - 'ï¼Œä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™ä¼šå°†è¿å­—ç¬¦åˆ é™¤ã€‚</p><h2 id="ä¼˜ç‚¹"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹"></a> ä¼˜ç‚¹</h2><ul><li>æœ¬åœ°ç”Ÿæˆï¼Œæ— ç½‘ç»œæ¶ˆè€—</li></ul><h2 id="ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹"></a> ç¼ºç‚¹</h2><ul><li>å ç”¨ç©ºé—´è¾ƒå¤§ï¼Œä¸æ˜“å­˜å‚¨ï¼Œé€šå¸¸ç”¨varcharå­˜å‚¨</li><li>æ— ä¸šåŠ¡æ„ä¹‰ï¼Œå®Œå…¨æ˜¯ä¸€ä¸²éšæœºå­—ç¬¦ä¸²</li><li>ä¸æ˜¯è¶‹åŠ¿è‡ªå¢ï¼Œæ’å…¥DBä¼šå¼•èµ·B+æ ‘é¡µåˆ†è£‚å’ŒèŠ‚ç‚¹åˆ†è£‚</li></ul><h1 id="2mysqlè‡ªå¢id"><a class="markdownIt-Anchor" href="#2mysqlè‡ªå¢id"></a> 2.MySQLè‡ªå¢ID</h1><p>ä½¿ç”¨MySQLè‡ªå¢IDæ¥ä½œä¸ºå…¨å±€å”¯ä¸€IDæ˜¯ä¸€ç§å¸¸ç”¨åšæ³•</p><h2 id="å•æœº"><a class="markdownIt-Anchor" href="#å•æœº"></a> å•æœº</h2><p>å•æœºä¸‹ï¼Œç›´æ¥è®¾ç½® ä»1å¼€å§‹è‡ªå¢<code>auto_increment_offset=1</code>ï¼Œå¢é‡ä¸º1 <code>auto_increment_increment=1</code>ï¼Œæ¯æ¬¡å‘å·æ—¶ï¼Œå‘DBæ’å…¥ä¸€æ¡æ•°æ®ï¼Œå°†ä¸»é”®ä½œä¸ºID</p><h3 id="ä¼˜ç‚¹-2"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-2"></a> ä¼˜ç‚¹</h3><ul><li>å®ç°ç®€å•</li></ul><h3 id="ç¼ºç‚¹-2"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹-2"></a> ç¼ºç‚¹</h3><ul><li>ä¸æ»¡è¶³é«˜å¯ç”¨ï¼ŒDBæœ‰å®•æœºé£é™©</li></ul><h2 id="é›†ç¾¤"><a class="markdownIt-Anchor" href="#é›†ç¾¤"></a> é›†ç¾¤</h2><p>æ—¢ç„¶å•æœºå­˜åœ¨å®•æœºé£é™©ï¼Œé‚£ä¹ˆéƒ¨ç½²ä¸€ä¸ªMySQLé›†ç¾¤å‘—ï¼Œè®¾ç½®åŒä¸»é›†ç¾¤ï¼Œä¸¤ä¸ªèŠ‚ç‚¹éƒ½èƒ½å‘å·ã€‚</p><p>MySQL Aé…ç½®-å‘å•å·</p><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">auto_increment_offset<span class="token operator">=</span><span class="token number">1</span>auto_increment_increment<span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div><p>MySQL Bé…ç½®-å‘åŒå·</p><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">auto_increment_offset<span class="token operator">=</span><span class="token number">2</span>auto_increment_increment<span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div><p>å¦‚æœåç»­è¿˜æ˜¯æ‰›ä¸ä½å¹¶å‘ï¼Œéœ€è¦ç»§ç»­æ‰©å±•ï¼Œé‚£å°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚ã€‚ã€‚å¹¶ä¸”è¿˜å­˜åœ¨ç€é›†ç¾¤åŒæ­¥é—®é¢˜ã€‚</p><h3 id="ä¼˜ç‚¹-3"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-3"></a> ä¼˜ç‚¹</h3><ul><li>è§£å†³DBå•ç‚¹é—®é¢˜</li></ul><h3 id="ç¼ºç‚¹-3"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹-3"></a> ç¼ºç‚¹</h3><ul><li>å­˜åœ¨é›†ç¾¤åŒæ­¥é—®é¢˜</li><li>ä¸æ˜“æ‰©å±•</li></ul><h1 id="3åŸºäºrediså®ç°"><a class="markdownIt-Anchor" href="#3åŸºäºrediså®ç°"></a> 3.åŸºäºRediså®ç°</h1><p>Rediså®ç°åˆ†å¸ƒå¼å”¯ä¸€IDä¸»è¦æ˜¯é€šè¿‡æä¾›åƒ <code>INCR</code> å’Œ <code>INCRBY</code> è¿™æ ·çš„è‡ªå¢åŸå­å‘½ä»¤ï¼Œç”±äºRedisè‡ªèº«çš„<strong>å•çº¿ç¨‹</strong>çš„ç‰¹ç‚¹æ‰€ä»¥èƒ½ä¿è¯ç”Ÿæˆçš„ ID æ˜¯å”¯ä¸€æœ‰åºçš„ã€‚ ä½†æ˜¯å•æœºå­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼Œæ— æ³•æ»¡è¶³é«˜å¹¶å‘çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå¯ä»¥é‡‡ç”¨é›†ç¾¤çš„æ–¹å¼æ¥å®ç°ã€‚</p><p>æ­¤å¤–ï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæœ€å¥½ä½¿ç”¨Luaè„šæœ¬æ¥è¿›è¡Œç¼–ç ï¼Œä¿è¯å®Œå…¨çš„åŸå­æ€§æ“ä½œã€‚</p><h2 id="ä¼˜ç‚¹-4"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-4"></a> ä¼˜ç‚¹</h2><ul><li>IDè‡ªå¢ï¼Œåˆ©äºB+æ ‘ç´¢å¼•</li><li>å®ç°ç®€å•ï¼Œæ€§èƒ½è¾ƒé«˜</li></ul><h2 id="ç¼ºç‚¹-4"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹-4"></a> ç¼ºç‚¹</h2><ul><li>éœ€å¼•å…¥Redisï¼Œæé«˜ç³»ç»Ÿå¤æ‚æ€§</li></ul><h1 id="4é›ªèŠ±ç®—æ³•"><a class="markdownIt-Anchor" href="#4é›ªèŠ±ç®—æ³•"></a> 4.é›ªèŠ±ç®—æ³•</h1><p>é›ªèŠ±ç®—æ³•æ˜¯Twitterå¼€æºçš„åŸºäºç³»ç»Ÿæ—¶é—´æˆ³çš„åˆ†å¸ƒå¼IDæ–¹æ¡ˆï¼Œä»¥åˆ’åˆ†å‘½åç©ºé—´çš„æ–¹å¼å°†64bitåˆ†å‰²ä¸ºå¤šä¸ªéƒ¨åˆ†ã€‚</p><ul><li>ç¬¬1ä½å ç”¨1bitï¼Œå…¶å€¼å§‹ç»ˆæ˜¯0ï¼Œå¯çœ‹åšæ˜¯ç¬¦å·ä½ä¸ä½¿ç”¨</li><li>ç¬¬2ä½å¼€å§‹çš„41ä½æ˜¯æ—¶é—´æˆ³ï¼Œ41-bitä½å¯è¡¨ç¤º2^41ä¸ªæ•°ï¼Œæ¯ä¸ªæ•°ä»£è¡¨æ¯«ç§’ï¼Œé‚£ä¹ˆé›ªèŠ±ç®—æ³•å¯ç”¨çš„æ—¶é—´å¹´é™æ˜¯(1L&lt;&lt;41)/(1000L360024*365)=69 å¹´çš„æ—¶é—´</li><li>ä¸­é—´çš„10-bitä½å¯è¡¨ç¤ºæœºå™¨æ•°ï¼Œå³2^10 = 1024å°æœºå™¨ï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šéƒ¨ç½²è¿™ä¹ˆå°æœºå™¨ã€‚å¦‚æœæˆ‘ä»¬å¯¹IDCï¼ˆäº’è”ç½‘æ•°æ®ä¸­å¿ƒï¼‰æœ‰éœ€æ±‚ï¼Œè¿˜å¯ä»¥å°† 10-bit åˆ† 5-bit ç»™ IDCï¼Œåˆ†5-bitç»™å·¥ä½œæœºå™¨ã€‚è¿™æ ·å°±å¯ä»¥è¡¨ç¤º32ä¸ªIDCï¼Œæ¯ä¸ªIDCä¸‹å¯ä»¥æœ‰32å°æœºå™¨ï¼Œå…·ä½“çš„åˆ’åˆ†å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚å®šä¹‰</li><li>æœ€å12-bitä½æ˜¯è‡ªå¢åºåˆ—ï¼Œå¯è¡¨ç¤º2^12 = 4096ä¸ªæ•°ã€‚</li></ul><p>ä»¥ä¸‹æ˜¯Javaå®ç°ã€‚å…¶ä¸­<code>nextId()</code>æ˜¯ä½¿ç”¨synchronizedåŠ é”çš„ï¼Œè™½ç„¶synchronizedåªåœ¨å•å®ä¾‹ä¸‹æœ‰æ•ˆï¼Œåœ¨é›†ç¾¤éƒ¨ç½²ä¸‹ï¼Œé€šè¿‡è®¾ç½®ä¸åŒçš„worker idï¼Œä¹Ÿå¯ä»¥ä¿è¯IDçš„å…¨å±€å”¯ä¸€æ€§ã€‚</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * twitterçš„snowflakeç®—æ³• -- javaå®ç° * https://github.com/beyondfengyu/SnowFlake/blob/master/SnowFlake.java * @author beyond * @date 2016/11/26 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnowFlake</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * èµ·å§‹çš„æ—¶é—´æˆ³     */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> START_STMP <span class="token operator">=</span> <span class="token number">1480166465631L</span><span class="token punctuation">;</span>    <span class="token comment">/**     * æ¯ä¸€éƒ¨åˆ†å ç”¨çš„ä½æ•°     */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> SEQUENCE_BIT <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">//åºåˆ—å·å ç”¨çš„ä½æ•°</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> MACHINE_BIT <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>   <span class="token comment">//æœºå™¨æ ‡è¯†å ç”¨çš„ä½æ•°</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> DATACENTER_BIT <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//æ•°æ®ä¸­å¿ƒå ç”¨çš„ä½æ•°</span>    <span class="token comment">/**     * æ¯ä¸€éƒ¨åˆ†çš„æœ€å¤§å€¼     */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> MAX_DATACENTER_NUM <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> DATACENTER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> MAX_MACHINE_NUM <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> MACHINE_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> MAX_SEQUENCE <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> SEQUENCE_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * æ¯ä¸€éƒ¨åˆ†å‘å·¦çš„ä½ç§»     */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> MACHINE_LEFT <span class="token operator">=</span> SEQUENCE_BIT<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> DATACENTER_LEFT <span class="token operator">=</span> SEQUENCE_BIT <span class="token operator">+</span> MACHINE_BIT<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> TIMESTMP_LEFT <span class="token operator">=</span> DATACENTER_LEFT <span class="token operator">+</span> DATACENTER_BIT<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> datacenterId<span class="token punctuation">;</span>  <span class="token comment">//æ•°æ®ä¸­å¿ƒ</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> machineId<span class="token punctuation">;</span>     <span class="token comment">//æœºå™¨æ ‡è¯†</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span> <span class="token comment">//åºåˆ—å·</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> lastStmp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span><span class="token comment">//ä¸Šä¸€æ¬¡æ—¶é—´æˆ³</span>    <span class="token keyword">public</span> <span class="token class-name">SnowFlake</span><span class="token punctuation">(</span><span class="token keyword">long</span> datacenterId<span class="token punctuation">,</span> <span class="token keyword">long</span> machineId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>datacenterId <span class="token operator">></span> MAX_DATACENTER_NUM <span class="token operator">||</span> datacenterId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"datacenterId can't be greater than MAX_DATACENTER_NUM or less than 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>machineId <span class="token operator">></span> MAX_MACHINE_NUM <span class="token operator">||</span> machineId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"machineId can't be greater than MAX_MACHINE_NUM or less than 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>datacenterId <span class="token operator">=</span> datacenterId<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>machineId <span class="token operator">=</span> machineId<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * äº§ç”Ÿä¸‹ä¸€ä¸ªID     *     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">long</span> currStmp <span class="token operator">=</span> <span class="token function">getNewstmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currStmp <span class="token operator">&lt;</span> lastStmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Clock moved backwards.  Refusing to generate id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currStmp <span class="token operator">==</span> lastStmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//ç›¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢</span>            sequence <span class="token operator">=</span> <span class="token punctuation">(</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> MAX_SEQUENCE<span class="token punctuation">;</span>            <span class="token comment">//åŒä¸€æ¯«ç§’çš„åºåˆ—æ•°å·²ç»è¾¾åˆ°æœ€å¤§</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                currStmp <span class="token operator">=</span> <span class="token function">getNextMill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//ä¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·ç½®ä¸º0</span>            sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        lastStmp <span class="token operator">=</span> currStmp<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>currStmp <span class="token operator">-</span> START_STMP<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> TIMESTMP_LEFT <span class="token comment">//æ—¶é—´æˆ³éƒ¨åˆ†</span>                <span class="token operator">|</span> datacenterId <span class="token operator">&lt;&lt;</span> DATACENTER_LEFT       <span class="token comment">//æ•°æ®ä¸­å¿ƒéƒ¨åˆ†</span>                <span class="token operator">|</span> machineId <span class="token operator">&lt;&lt;</span> MACHINE_LEFT             <span class="token comment">//æœºå™¨æ ‡è¯†éƒ¨åˆ†</span>                <span class="token operator">|</span> sequence<span class="token punctuation">;</span>                             <span class="token comment">//åºåˆ—å·éƒ¨åˆ†</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">getNextMill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">long</span> mill <span class="token operator">=</span> <span class="token function">getNewstmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>mill <span class="token operator">&lt;=</span> lastStmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            mill <span class="token operator">=</span> <span class="token function">getNewstmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> mill<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">getNewstmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">SnowFlake</span> snowFlake <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnowFlake</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>snowFlake<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="ä¼˜ç‚¹-5"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-5"></a> ä¼˜ç‚¹</h2><ul><li>ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸ä¾èµ–å…¶ä»–ç»„ä»¶</li><li>è¶‹åŠ¿é€’å¢</li><li>é«˜æ€§èƒ½</li><li>å­—æ®µå®šä¹‰çµæ´»</li></ul><h2 id="ç¼ºç‚¹-5"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹-5"></a> ç¼ºç‚¹</h2><ul><li>æ—¶é’Ÿå›æ‹¨é—®é¢˜ï¼Œä¼šå¯¼è‡´å‘å·é‡å¤æˆ–è€…æœåŠ¡ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€</li><li>IDå­—æ®µç»“æ„æš´éœ²ï¼Œå®¹æ˜“æš´éœ²ä¸šåŠ¡è§„æ¨¡</li></ul><h2 id="é’ˆå¯¹æ—¶é’Ÿå›æ‹¨é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#é’ˆå¯¹æ—¶é’Ÿå›æ‹¨é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ"></a> é’ˆå¯¹æ—¶é’Ÿå›æ‹¨é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ</h2><ul><li>æŠ›å‡ºå¼‚å¸¸ï¼ˆæ—¶é—´è¢«è¿½å›ä¹‹å‰çš„è¿™æ®µæ—¶é—´æœåŠ¡ä¸å¯ç”¨ï¼‰</li><li>å…³é—­æœºå™¨æ—¶é’ŸåŒæ­¥</li><li>ä¿å­˜è¿‡å»ä¸€æ®µæ—¶é—´å†…æ¯å°æœºå™¨åœ¨å½“å‰è¿™ä¸€æ¯«ç§’äº§ç”Ÿçš„æœ€å¤§IDï¼ˆmax_idï¼‰ï¼Œå¦‚æœå‘ç”Ÿå›æ‹¨ï¼Œåˆ™max_id+1å³å¯</li><li>æ¯æ¬¡ç”Ÿæˆæ—¶ï¼Œé¢„ç•™ä¸€äº›IDå·æ®µï¼Œå‘ç”Ÿå›æ‹¨ï¼Œå°†è¿™äº›IDåˆ†é…å‡ºå»</li></ul><h2 id="å®æˆ˜åº”ç”¨"><a class="markdownIt-Anchor" href="#å®æˆ˜åº”ç”¨"></a> å®æˆ˜åº”ç”¨</h2><p>åœ¨ä¹‹å‰ç¥å·ä¿¡æ¯åˆ†å¸ƒå¼èµ›é“ä¸­ï¼Œæˆ‘è·Ÿåˆ˜å“¥ä½¿ç”¨äº†é›ªèŠ±IDä½œä¸ºåˆ†å¸ƒå¼IDæ–¹æ¡ˆã€‚èµ›é¢˜ç»™å®šçš„ä¸»é”®å­—æ®µæ˜¯20ä½å­—ç¬¦å‹ï¼Œç”±äºè®¾è®¡ä¹‹åˆè€ƒè™‘åˆ°äº†å•è¡¨å®¹é‡è¿‡å¤§çš„é—®é¢˜ï¼Œé‡‡ç”¨äº†åˆ†åº“åˆ†è¡¨ç­–ç•¥ï¼Œå°†2ä½åº“æ ‡è¯†+4ä½è¡¨æ ‡è¯†è®¾è®¡åˆ°IDå‰å…­ä½ï¼Œè¿˜å‰©ä¸‹14ä½å¯ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åŸºäºé›ªèŠ±ç®—æ³•çš„åˆ†å¸ƒå¼IDæ–¹æ¡ˆã€‚</p><h3 id="idè®¾è®¡"><a class="markdownIt-Anchor" href="#idè®¾è®¡"></a> IDè®¾è®¡</h3><p>2ä½åº“æ ‡è¯†+4ä½è¡¨æ ‡è¯†+14ä½IceFlake ID</p><h3 id="åŸºäºsnowflakeçš„iceflake-idè®¾è®¡"><a class="markdownIt-Anchor" href="#åŸºäºsnowflakeçš„iceflake-idè®¾è®¡"></a> åŸºäºSnowFlakeçš„IceFlake IDè®¾è®¡</h3><ul><li>64ä½longç±»å‹å­˜å‚¨</li><li>ä½6ä½ï¼šåºåˆ—å·ï¼Œå¯æ ‡è¯†2^6=64ä¸ªid</li><li>æ¬¡ä½4ä½ï¼šå®ä¾‹idæ ‡è¯†ä½ï¼Œå¯æ ‡è¯†2^4=16ä¸ªå®ä¾‹</li><li>ä¸­é—´41ä½ï¼šæ¯«ç§’çº§æ—¶é—´æˆ³ï¼Œå¯æ ‡è¯†æ—¶é—´èŒƒå›´ï¼š2^41/1000/60/60/24/365=69å¹´</li><li>å‰©ä½™é«˜ä½ï¼š0å¡«å……</li></ul><p>æœ€åï¼Œæˆªå–ä½52ä½ï¼Œè½¬ä¸º14ä½16è¿›åˆ¶æ¯”ç‰¹ä½å­—ç¬¦ä¸²ï¼ˆé«˜ä½å¡«å……1ä¸ªâ€œ0â€ï¼‰ï¼Œç»„æˆ14ä½ Iceflake id</p><p>ä»£ç å®ç°ï¼š</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnowFlakeIdUtils</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 2015-01-01</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> START_DATE <span class="token operator">=</span> <span class="token number">1420041600000L</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> NUM_WORKER_ID_BITS <span class="token operator">=</span> <span class="token number">4L</span><span class="token punctuation">;</span>    <span class="token comment">// åºåˆ—å·ä½æ•°ï¼š6ï¼Œ ä¸€ä¸ªæ¯«ç§’å•ä½å†…å¯å•ä¸ªå®ä¾‹æ‰¿å—å¹¶å‘64ä¸ªID</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> NUM_SEQUENCE_ID_BITS <span class="token operator">=</span> <span class="token number">6L</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> NUM_WORKER_ID_SHIFTS <span class="token operator">=</span> NUM_SEQUENCE_ID_BITS<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> NUM_TIMESTAMP_ID_SHIFTS <span class="token operator">=</span> NUM_SEQUENCE_ID_BITS <span class="token operator">+</span> NUM_WORKER_ID_BITS<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> SEQUENCE_MASK <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> NUM_SEQUENCE_ID_BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// é›†ç¾¤éƒ¨ç½²ï¼Œé…ç½®worker-id</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;worker-id&#125;"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> workerId<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> sequenceId<span class="token operator">=</span><span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> lastTimestamp<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">String</span> <span class="token function">getSnowflakeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">long</span> time_stamp <span class="token operator">=</span> <span class="token function">getCurrentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// TODO: ä¼˜åŒ–æ—¶é’Ÿå›æ‹¨é”™è¯¯</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> time_stamp <span class="token operator">&lt;</span> lastTimestamp <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"clock moved backward! Failed to generate Snowflake ID for %d millisecond..."</span><span class="token punctuation">,</span> lastTimestamp <span class="token operator">-</span> time_stamp<span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// å¦‚æœæ˜¯åŒä¸€æ—¶é—´ç”Ÿæˆï¼Œåˆ™åºåˆ—å·+1</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> lastTimestamp <span class="token operator">==</span> time_stamp <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sequenceId <span class="token operator">=</span> <span class="token punctuation">(</span>sequenceId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> SEQUENCE_MASK<span class="token punctuation">;</span>            <span class="token comment">// åºåˆ—æº¢å‡º</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> sequenceId <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                time_stamp <span class="token operator">=</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// å¦åˆ™ï¼Œä»0å¼€å§‹</span>            sequenceId <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        lastTimestamp <span class="token operator">=</span> time_stamp<span class="token punctuation">;</span>        <span class="token comment">// å¾€14ä½å¡«å……</span>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%14s"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>                <span class="token punctuation">(</span><span class="token punctuation">(</span>time_stamp <span class="token operator">-</span> START_DATE<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> NUM_TIMESTAMP_ID_SHIFTS<span class="token punctuation">)</span>                        <span class="token operator">|</span> <span class="token punctuation">(</span>workerId <span class="token operator">&lt;&lt;</span> NUM_WORKER_ID_SHIFTS<span class="token punctuation">)</span>                        <span class="token operator">|</span> sequenceId<span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * é˜»å¡åˆ°ä¸‹ä¸€ä¸ªæ¯«ç§’ï¼Œç›´åˆ°è·å¾—æ–°çš„æ—¶é—´æˆ³     * @param lastTimestamp     * @return     */</span>    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">long</span> time_stamp <span class="token operator">=</span> <span class="token function">getCurrentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> time_stamp <span class="token operator">&lt;=</span> lastTimestamp <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            time_stamp <span class="token operator">=</span> <span class="token function">getCurrentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> time_stamp<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">getCurrentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>]]></content>
    
    
    <categories>
      
      <category>åˆ†å¸ƒå¼ç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼ID</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ŒTOP Kã€é—®é¢˜çš„å‡ ç§è§£æ³•</title>
    <link href="/2022/06/01/%E3%80%8CTOP%20K%E3%80%8D%E9%97%AE%E9%A2%98%E7%9A%84%E5%87%A0%E7%A7%8D%E8%A7%A3%E6%B3%95/"/>
    <url>/2022/06/01/%E3%80%8CTOP%20K%E3%80%8D%E9%97%AE%E9%A2%98%E7%9A%84%E5%87%A0%E7%A7%8D%E8%A7%A3%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="åºè¨€"><a class="markdownIt-Anchor" href="#åºè¨€"></a> åºè¨€</h1><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>O</mi><mi>P</mi><mi>K</mi></mrow><annotation encoding="application/x-tex">TOP K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> é—®é¢˜åº”è¯¥æ˜¯é¢è¯•å¿…é—®çš„ç®—æ³•é¢˜äº†ï¼Œé€šå¸¸æ˜¯é—®æ•°ç»„ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">nums</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span></span></span></span> ä¸­ç¬¬ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> å¤§æˆ–è€…ç¬¬ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> å°çš„å…ƒç´ ã€‚<br />é€šå¸¸æœ‰å¦‚ä¸‹å‡ ç§è§£æ³•ï¼š</p><ul><li>ç›´æ¥æ’åº</li><li>ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå¤§æ ¹å †/å°æ ¹å †ï¼‰</li><li>å¿«é€Ÿé€‰æ‹©ï¼ˆåŸºäºå¿«æ’çš„åˆ’åˆ†ï¼‰</li></ul><p>æœ¬æ–‡ä»¥ <a href="https://leetcode.cn/problems/kth-largest-element-in-an-array/">LC 215. æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´ </a>ä¸ºä¾‹åˆ†æã€‚</p><h1 id="ç›´æ¥æ’åº"><a class="markdownIt-Anchor" href="#ç›´æ¥æ’åº"></a> ç›´æ¥æ’åº</h1><p>è¿™é‡Œè´´ä¸€ä¸ªå¿«æ’æ¨¡æ¿ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯æ¬¡åˆ’åˆ†ä¸­pivotçš„é€‰å–å¯¹å¿«æ’æ€§èƒ½å½±å“å¾ˆå¤§ï¼Œæç«¯æƒ…å†µä¸‹ï¼ˆæ•°ç»„é€†åºï¼‰æ—¶é—´å¤æ‚åº¦ä¼šé€€åŒ–åˆ° <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>ã€‚å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ˜¯ <em><strong>ä¸‰è€…å–ä¸­</strong></em>ï¼Œå³é¦–å°¾å’Œä¸­é—´ï¼Œå–å…¶ä¸­ä½æ•°ã€‚</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findKthLargest</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> nums<span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token operator">-</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> piv <span class="token operator">=</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> left <span class="token operator">&lt;</span> right <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// rightæ‰¾æ¯”pivå°çš„</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span> left <span class="token operator">&lt;</span> right <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">>=</span> piv <span class="token punctuation">)</span> right<span class="token operator">--</span><span class="token punctuation">;</span>            nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span> left <span class="token operator">&lt;</span> right <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> piv <span class="token punctuation">)</span> left<span class="token operator">++</span><span class="token punctuation">;</span>            nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// pivæ”¾å…¥æœ€ç»ˆä½ç½®</span>        nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">=</span> piv<span class="token punctuation">;</span>        <span class="token keyword">return</span> left<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> left <span class="token operator">&lt;</span> right <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> piv_index <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> left<span class="token punctuation">,</span> piv_index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> piv_index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(nlogn)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ï¼Œæç«¯æƒ…å†µä¸‹é€€åŒ–åˆ° <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(logn)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ï¼Œé€’å½’è°ƒç”¨æ ˆçš„å¼€é”€</p></li></ul><h1 id="ä¼˜å…ˆé˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#ä¼˜å…ˆé˜Ÿåˆ—"></a> ä¼˜å…ˆé˜Ÿåˆ—</h1><p>ä¼˜å…ˆé˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯å †ã€‚å¯¹äº <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>O</mi><mi>P</mi><mi>K</mi></mrow><annotation encoding="application/x-tex">TOP K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> å¤§çš„å…ƒç´ ï¼Œç»´æŠ¤å¤§å°ä¸º <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> çš„å°æ ¹å †ï¼Œä¸æ–­å°† <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">nums</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span></span></span></span> ä¸­çš„å…ƒç´ é€è¿›å»ï¼Œæœ€ç»ˆå †é¡¶å…ƒç´ å°±æ˜¯ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>O</mi><mi>P</mi><mi>K</mi></mrow><annotation encoding="application/x-tex">TOP K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> å¤§çš„å…ƒç´ ã€‚</p><ul><li>ä¸ºä»€ä¹ˆæ˜¯å°æ ¹å †è€Œä¸æ˜¯å¤§æ ¹å †ï¼Ÿ</li><li>å¦‚æœç”¨å¤§æ ¹å †ï¼Œå°±è¦å¯¹å…¨é‡å…ƒç´ è¿›è¡Œå…¨éƒ¨æ’åºï¼›åä¹‹ï¼Œç»´æŠ¤ä¸€ä¸ªå¤§å°ä¸ºkçš„å°æ ¹å †ï¼Œæœ€ç»ˆç•™ä¸‹çš„å †é¡¶ï¼Œå°±æ˜¯topkå¤§</li></ul><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findKthLargest</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> pq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> x <span class="token operator">:</span> nums <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            pq<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> pq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> k <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                pq<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> pq<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(nlogk)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>ï¼Œéå†å…ƒç´  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ï¼Œå †è°ƒæ•´ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(logk)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></p></li></ul><h1 id="å¿«é€Ÿé€‰æ‹©"><a class="markdownIt-Anchor" href="#å¿«é€Ÿé€‰æ‹©"></a> å¿«é€Ÿé€‰æ‹©</h1><p>å¿«é€Ÿæ’åºçš„æ¯æ¬¡åˆ’åˆ†ï¼Œä¼šç¡®å®šä¸€ä¸ªpivotå…ƒç´ çš„æœ€ç»ˆä½ç½®ï¼Œåœ¨pivotå·¦è¾¹çš„å…ƒç´ éƒ½æ¯”pivotå°ï¼›å³è¾¹çš„éƒ½æ¯”pivotå¤§ï¼ˆä½†éƒ½ä¸ä¸€å®šæœ‰åºï¼‰ã€‚</p><p>å¿«é€Ÿé€‰æ‹©åŸºäºå¿«é€Ÿæ’åºçš„åˆ’åˆ†æ€æƒ³ï¼Œæ¯æ¬¡åˆ’åˆ†ä¹‹åï¼Œå¾—åˆ°pivotå…ƒç´ çš„ä¸‹æ ‡ï¼Œå¹¶ä¸åƒå¿«é€Ÿæ’åºé‚£æ ·é€’å½’åœ°å¯¹å·¦å³ä¸¤ä¸ªå­åŒºé—´è¿›è¡Œåˆ†æ²»å¤„ç†ã€‚</p><p>è€Œæ˜¯åˆ¤æ–­å½“å‰pivotå…ƒç´ çš„ä¸‹æ ‡ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>i</mi><mi>v</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">pivot\_idx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span></span></span></span> å’Œå¾…æ±‚ topk å…ƒç´ çš„ä¸‹æ ‡ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi><mo>:</mo><mo>=</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><mi>h</mi><mo>âˆ’</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">k\_idx := nums.length-k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span> ä½œæ¯”è¾ƒï¼Œå¦‚æœï¼š</p><ul><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>i</mi><mi>v</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi><mo>=</mo><mo>=</mo><mi>k</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">pivot\_idx == k\_idx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span></span></span></span>ï¼Œç›´æ¥è¿”å› <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mo stretchy="false">[</mo><mi>p</mi><mi>i</mi><mi>v</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums[pivot\_idx]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord mathdefault">p</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span><span class="mclose">]</span></span></span></span></li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>i</mi><mi>v</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi><mo>&gt;</mo><mi>k</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">pivot\_idx &gt; k\_idx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span></span></span></span>ï¼Œè¯´æ˜ç›®æ ‡çš„Kåº”è¯¥åœ¨å·¦åŠåŒºé—´ï¼Œåˆ™é€’å½’åœ¨å·¦åŠåŒºé—´è¿›è¡Œå¤„ç†</li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>i</mi><mi>v</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi><mo>&lt;</mo><mi>k</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">pivot\_idx &lt; k\_idx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span></span></span></span>ï¼Œè¯´æ˜ç›®æ ‡çš„Kåº”è¯¥åœ¨å³åŠåŒºé—´ï¼Œåˆ™é€’å½’åœ¨å³åŠåŒºé—´è¿›è¡Œå¤„ç†</li></ul><p>å¯ä»¥çœ‹å‡ºï¼Œç›¸å¯¹äºæœ´ç´ å¿«æ’ï¼Œå¿«é€Ÿé€‰æ‹©ç›¸å½“äºè¿›è¡Œäº†ä¸€æ¬¡â€œäºŒåˆ†â€å‰ªæå¤„ç†ï¼Œæ¯æ¬¡åˆ’åˆ†å®Œä¹‹åï¼Œå¹¶æ²¡æœ‰åƒå¿«é€Ÿæ’åºé‚£æ ·å¯¹å·¦å³ä¸¤ä¸ªå­åŒºé—´éƒ½è¿›è¡Œé€’å½’å¤„ç†ã€‚</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findKthLargest</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">quick_select</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span>length<span class="token operator">-</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> nums<span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token operator">-</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> piv <span class="token operator">=</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> left <span class="token operator">&lt;</span> right <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// rightæ‰¾æ¯”pivå°çš„</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span> left <span class="token operator">&lt;</span> right <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">>=</span> piv <span class="token punctuation">)</span> right<span class="token operator">--</span><span class="token punctuation">;</span>            nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span> left <span class="token operator">&lt;</span> right <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> piv <span class="token punctuation">)</span> left<span class="token operator">++</span><span class="token punctuation">;</span>            nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// pivæ”¾å…¥æœ€ç»ˆä½ç½®</span>        nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">=</span> piv<span class="token punctuation">;</span>        <span class="token keyword">return</span> left<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">quick_select</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> k_index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> left <span class="token operator">&lt;</span> right <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> piv_idx <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> k_index <span class="token operator">==</span> piv_idx <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// topk ç´¢å¼•æ¯”pivç´¢å¼•å¤§</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> k_index <span class="token operator">></span> piv_idx <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// å¾€å³æœç´¢</span>                <span class="token function">quick_select</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> piv_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">,</span> k_index<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token function">quick_select</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> left<span class="token punctuation">,</span> piv_idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> k_index<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li><p><em><strong>æ—¶é—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ï¼Œå…·ä½“è¯æ˜å‚è§ã€Šç®—æ³•å¯¼è®ºã€‹</strong></em></p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(logn)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ï¼Œé€’å½’è°ƒç”¨æ ˆçš„å¼€é”€</p></li></ul><h1 id="å†™åœ¨åé¢"><a class="markdownIt-Anchor" href="#å†™åœ¨åé¢"></a> å†™åœ¨åé¢</h1><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>O</mi><mi>P</mi><mi>K</mi></mrow><annotation encoding="application/x-tex">TOP K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> é—®é¢˜ä½œä¸ºç®—æ³•é¢˜æ¥è€ƒå¯Ÿï¼Œä¸»è¦è¿˜æ˜¯è€ƒå¯Ÿã€Œå¿«é€Ÿé€‰æ‹©ã€çš„ï¼Œå› æ­¤åŠ¡å¿…è¦æŒæ¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœæ¶‰åŠåˆ°æµ·é‡æ•°æ®å¤„ç†ï¼Œå¯èƒ½éœ€è¦ç”¨åˆ°å¤–éƒ¨æ’åºï¼ŒMapReduceå¤„ç†ç­‰ã€‚</p><p>æœ€åï¼Œå†è´´ä¸€ä¸ªå †æ’åºå’Œå½’å¹¶æ’åºçš„æ¨¡æ¿ã€‚</p><h2 id="å †æ’åºæ¨¡æ¿"><a class="markdownIt-Anchor" href="#å †æ’åºæ¨¡æ¿"></a> å †æ’åºæ¨¡æ¿</h2><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">sortArray</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">buildMaxHeap</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> n<span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// n-1è¶Ÿäº¤æ¢å’Œå»ºå †</span>            <span class="token function">swap</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å †é¡¶å’Œå †åº•äº¤æ¢ï¼ˆè¾“å‡ºå †é¡¶ï¼‰</span>            <span class="token function">adjust</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// æŠŠå‰©ä¸‹çš„i-1ä¸ªå…ƒç´ è°ƒæ•´æˆå †</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// åˆå§‹å»ºå †</span>    <span class="token keyword">void</span> <span class="token function">buildMaxHeap</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> len<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ä» [n/2] ~ 1,è°ƒæ•´å †</span>            <span class="token function">adjust</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// è°ƒæ•´kä¸ºæ ¹çš„å­æ ‘ä¸ºå¤§æ ¹å †</span>    <span class="token keyword">void</span> <span class="token function">adjust</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// nums[0]æš‚å­˜å½“å‰æ ¹èŠ‚ç‚¹</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>k<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> len<span class="token punctuation">;</span> i <span class="token operator">*=</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">&lt;</span> len <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> nums<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">>=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                k <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> tmp <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="å½’å¹¶æ’åºæ¨¡æ¿"><a class="markdownIt-Anchor" href="#å½’å¹¶æ’åºæ¨¡æ¿"></a> å½’å¹¶æ’åºæ¨¡æ¿</h2><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">void</span> <span class="token function">merge_sort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> low <span class="token operator">&lt;</span> high <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high<span class="token operator">-</span>low<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>            <span class="token function">merge_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">merge_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// åˆå¹¶</span>            <span class="token function">merge</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// åˆå¹¶ä¸¤ä¸ªæœ‰åºå­æ•°ç»„[low,mid] å’Œ [mid+1, high]</span>    <span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> mid<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>high<span class="token operator">-</span>low<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> low<span class="token punctuation">,</span> j <span class="token operator">=</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> i <span class="token operator">&lt;=</span> mid <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> high <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                tmp<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                tmp<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token comment">// å·¦è¾¹çš„å¤§äºå³è¾¹çš„ï¼Œè¯´æ˜ mid+1 ~ i ä¹‹é—´çš„éƒ½æ˜¯é€†åºå¯¹</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// å‰©ä½™çš„ç›´æ¥å¤åˆ¶è¿‡å»</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> i <span class="token operator">&lt;=</span> mid <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            tmp<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> j <span class="token operator">&lt;=</span> high <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            tmp<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> tmp<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•ä¸æ•°æ®ç»“æ„</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¿«é€Ÿé€‰æ‹©</tag>
      
      <tag>ä¼˜å…ˆé˜Ÿåˆ—</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ŒåŒºé—´å’Œã€é—®é¢˜</title>
    <link href="/2022/05/18/%E3%80%8C%E5%8C%BA%E9%97%B4%E5%92%8C%E3%80%8D%E9%97%AE%E9%A2%98/"/>
    <url>/2022/05/18/%E3%80%8C%E5%8C%BA%E9%97%B4%E5%92%8C%E3%80%8D%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h2 id="åŒºé—´å’Œ"><a class="markdownIt-Anchor" href="#åŒºé—´å’Œ"></a> åŒºé—´å’Œ</h2><p>å¯¹äºæ•°ç»„<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">nums</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span></span></span></span>ï¼Œæ‰€è°“ã€ŒåŒºé—´å’Œã€ï¼Œå°±æ˜¯æ±‚è§£æ•°ç»„<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">nums</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span></span></span></span>ä¸­åŒºé—´<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[i,j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>çš„å…ƒç´ å’Œï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo>+</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo><mo>+</mo><mo>â‹¯</mo><mo>+</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums[i]+nums[i+1]+\cdots+nums[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="minner">â‹¯</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span></span></p><p>ä½¿ç”¨<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>çš„ç©ºé—´å¤æ‚åº¦æ¥å®ç°<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>æ—¶é—´å¤æ‚åº¦çš„å¿«é€Ÿè®¡ç®—ï¼Œæ¥ä»£æ›¿é€ä¸ªç´¯åŠ çš„<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>æš´åŠ›è®¡ç®—</p><h2 id="åˆ†ç±»"><a class="markdownIt-Anchor" href="#åˆ†ç±»"></a> åˆ†ç±»</h2><ul><li>æ•°ç»„ä¸å¯å˜ï¼šå¯ç”¨ã€Œå‰ç¼€å’Œã€ã€ã€Œæ ‘çŠ¶æ•°ç»„ã€ã€ã€Œçº¿æ®µæ ‘ã€<ul><li>ä¸€ç»´å‰ç¼€å’Œ</li><li>äºŒç»´å‰ç¼€å’Œ</li></ul></li><li>æ•°ç»„å¯å˜ï¼šã€Œå‰ç¼€å’Œã€ä¸é€‚ç”¨<ul><li>å•ç‚¹ä¿®æ”¹</li><li>åŒºé—´ä¿®æ”¹</li></ul></li></ul><h2 id="å‰ç¼€å’Œ"><a class="markdownIt-Anchor" href="#å‰ç¼€å’Œ"></a> å‰ç¼€å’Œ</h2><p>æ‰€è°“ã€Œå‰ç¼€å’Œã€ï¼Œå°±æ˜¯ç”¨ä¸€ä¸ªæ•°ç»„<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">preSum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span></span></span></span>æ¥è®°å½•ä»<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums[0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>åˆ°<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span></span></span></span>ä¹‹é—´çš„å…ƒç´ å’Œï¼Œ</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>u</mi><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo>=</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>u</mi><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">]</mo><mo>+</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">preSum[i] = preSum[i-1]+nums[i] </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span></span></span></span></span></p><p>ä¸ºäº†è§£å†³æ•°ç»„è¶Šç•Œé—®é¢˜ï¼Œé€šå¸¸å¤šç”³è¯·ä¸€ä¸ªç©ºé—´ï¼Œä½¿å¾—<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">preSum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span></span></span></span>ä¸‹æ ‡ä»1å¼€å§‹ã€‚</p><h3 id="ä¸€ç»´å‰ç¼€å’Œ"><a class="markdownIt-Anchor" href="#ä¸€ç»´å‰ç¼€å’Œ"></a> ä¸€ç»´å‰ç¼€å’Œ</h3><p><a href="https://leetcode.cn/problems/range-sum-query-immutable/">LC 303. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„ä¸å¯å˜</a></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">NumArray</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pre_sum<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">NumArray</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// pre_sum[1]å¼€å§‹</span>        pre_sum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            pre_sum<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> pre_sum<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sumRange</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> pre_sum<span class="token punctuation">[</span>right<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> pre_sum<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li>æ—¶é—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></li><li>ç©ºé—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></li></ul><h3 id="äºŒç»´å‰ç¼€å’Œ"><a class="markdownIt-Anchor" href="#äºŒç»´å‰ç¼€å’Œ"></a> äºŒç»´å‰ç¼€å’Œ</h3><p><a href="https://leetcode.cn/problems/range-sum-query-2d-immutable/">LC 304. äºŒç»´åŒºåŸŸå’Œæ£€ç´¢ - çŸ©é˜µä¸å¯å˜</a></p><p>æ–¹æ³•ä¸€ ç»´æŠ¤æ¯ä¸€è¡Œ/åˆ—çš„ä¸€ç»´å‰ç¼€å’Œ</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">NumMatrix</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ç»´æŠ¤æ¯ä¸€è¡Œçš„å‰ç¼€å’Œ</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pres<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">NumMatrix</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> matrix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> m <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length<span class="token punctuation">,</span> n <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        pres <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                pres<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> pres<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sumRegion</span><span class="token punctuation">(</span><span class="token keyword">int</span> row1<span class="token punctuation">,</span> <span class="token keyword">int</span> col1<span class="token punctuation">,</span> <span class="token keyword">int</span> row2<span class="token punctuation">,</span> <span class="token keyword">int</span> col2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> row1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> row2<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            res <span class="token operator">+=</span> <span class="token punctuation">(</span>pres<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>col2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> pres<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>col1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li>æ—¶é—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>m</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(mn)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ï¼Œæ¯æ¬¡æ£€ç´¢åŒºé—´å’Œï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span></li><li>ç©ºé—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>m</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(mn)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></li></ul><p>æ–¹æ³•äºŒ ç»´æŠ¤äºŒç»´å‰ç¼€å’Œ</p><p>åˆå§‹è€ƒè™‘å››ä¸ªå•å…ƒæ ¼:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>u</mi><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo><mo>=</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>u</mi><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo><mo>+</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>u</mi><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>âˆ’</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>S</mi><mi>u</mi><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>+</mo><mi>m</mi><mi>a</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>x</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex">                    preSum[i + 1][j + 1] = preSum[i][j + 1] + preSum[i + 1][j] - preSum[i][j] + matrix[i][j];</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">x</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mpunct">;</span></span></span></span></span></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">NumMatrix</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preSum<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">NumMatrix</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> matrix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> m <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        preSum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// ä¸‹æ ‡ä»ç„¶ä»1å¼€å§‹</span>                preSum<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> preSum<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> preSum<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> preSum<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sumRegion</span><span class="token punctuation">(</span><span class="token keyword">int</span> row1<span class="token punctuation">,</span> <span class="token keyword">int</span> col1<span class="token punctuation">,</span> <span class="token keyword">int</span> row2<span class="token punctuation">,</span> <span class="token keyword">int</span> col2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// preSum[row1][col1]è¢«å‡äº†ä¸¤æ¬¡ï¼Œæœ€ååŠ ä¸Š</span>        <span class="token keyword">return</span> preSum<span class="token punctuation">[</span>row2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> preSum<span class="token punctuation">[</span>row1<span class="token punctuation">]</span><span class="token punctuation">[</span>col2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> preSum<span class="token punctuation">[</span>row2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col1<span class="token punctuation">]</span> <span class="token operator">+</span> preSum<span class="token punctuation">[</span>row1<span class="token punctuation">]</span><span class="token punctuation">[</span>col1<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li>æ—¶é—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>m</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(mn)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ï¼Œæ£€ç´¢åŒºé—´å’Œï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></li><li>ç©ºé—´å¤æ‚åº¦ï¼š<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>m</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(mn)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></li></ul><h2 id="æ ‘çŠ¶æ•°ç»„"><a class="markdownIt-Anchor" href="#æ ‘çŠ¶æ•°ç»„"></a> æ ‘çŠ¶æ•°ç»„</h2><p>å¦‚æœåŒºé—´å¯å˜/å¯ä¿®æ”¹ï¼Œé‚£ä¹ˆã€Œå‰ç¼€å’Œã€åº”è¯¥å°±å¤±æ•ˆäº†ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ã€Œæ ‘çŠ¶æ•°ç»„ã€ã€ã€Œçº¿æ®µæ ‘ã€ï¼Œç”±äºã€Œçº¿æ®µæ ‘ã€å®ç°èµ·æ¥æ¯”ã€Œæ ‘çŠ¶æ•°ç»„ã€å¤æ‚ï¼Œä¸”å¤šæ•°æƒ…å†µä¸‹çš„é—®é¢˜éƒ½å¯ä»¥ç”¨ã€Œæ ‘çŠ¶æ•°ç»„ã€å®ç°ï¼Œæ‰€ä»¥è¿™é‡Œæš‚ä¸”åªä»‹ç»ã€Œæ ‘çŠ¶æ•°ç»„ã€</p><p>æ¨¡æ¿</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// ä¸Šæ¥å…ˆæŠŠä¸‰ä¸ªæ–¹æ³•å†™å‡ºæ¥</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tree<span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">lowbit</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> x <span class="token operator">&amp;</span> <span class="token operator">-</span>x<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// æŸ¥è¯¢å‰ç¼€å’Œçš„æ–¹æ³•</span>    <span class="token keyword">int</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> ans <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> x<span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">-=</span> <span class="token function">lowbit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>             ans <span class="token operator">+=</span> tree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// åœ¨æ ‘çŠ¶æ•°ç»„ x ä½ç½®ä¸­å¢åŠ å€¼ u</span>    <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> u<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> x<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token function">lowbit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>             tree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> u<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// åˆå§‹åŒ–ã€Œæ ‘çŠ¶æ•°ç»„ã€ï¼Œè¦é»˜è®¤æ•°ç»„æ˜¯ä» 1 å¼€å§‹</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>         <span class="token function">add</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ä½¿ç”¨ã€Œæ ‘çŠ¶æ•°ç»„ã€ï¼š</span><span class="token punctuation">&#123;</span>       <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// åŸæœ‰çš„å€¼æ˜¯ nums[i]ï¼Œè¦ä½¿å¾—ä¿®æ”¹ä¸º valï¼Œéœ€è¦å¢åŠ  val - nums[i]</span>        <span class="token function">add</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> val <span class="token operator">-</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> <span class="token function">sumRange</span><span class="token punctuation">(</span><span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">query</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>ä½œè€…ï¼š<span class="token class-name">AC_OIer</span>é“¾æ¥ï¼šhttps<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>leetcode<span class="token punctuation">.</span>cn<span class="token operator">/</span>problems<span class="token operator">/</span>range<span class="token operator">-</span>sum<span class="token operator">-</span>query<span class="token operator">-</span>mutable<span class="token operator">/</span>solution<span class="token operator">/</span>guan<span class="token operator">-</span>yu<span class="token operator">-</span>ge<span class="token operator">-</span>lei<span class="token operator">-</span>qu<span class="token operator">-</span>jian<span class="token operator">-</span>he<span class="token operator">-</span>wen<span class="token operator">-</span>ti<span class="token operator">-</span>ru<span class="token operator">-</span>he<span class="token operator">-</span>x<span class="token operator">-</span><span class="token number">41</span>hv<span class="token operator">/</span>æ¥æºï¼šåŠ›æ‰£ï¼ˆ<span class="token class-name">LeetCode</span>ï¼‰è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•ä¸æ•°æ®ç»“æ„</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å‰ç¼€å’Œ</tag>
      
      <tag>åŒºé—´å’Œ</tag>
      
      <tag>æ ‘çŠ¶æ•°ç»„</tag>
      
      <tag>çº¿æ®µæ ‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ŒTrieæ ‘ã€çš„å®ç°</title>
    <link href="/2022/05/16/%E3%80%8CTrie%E6%A0%91%E3%80%8D%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <url>/2022/05/16/%E3%80%8CTrie%E6%A0%91%E3%80%8D%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a class="markdownIt-Anchor" href="#ä»‹ç»"></a> ä»‹ç»</h2><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>r</mi><mi>i</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">Trie</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span></span></span></span> æ ‘ï¼Œåˆå« <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">âŒˆ</mo></mrow><annotation encoding="application/x-tex">\lceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">âŒˆ</span></span></span></span> å‰ç¼€æ ‘ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">âŒ‹</mo></mrow><annotation encoding="application/x-tex">\rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">âŒ‹</span></span></span></span>ã€<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">âŒˆ</mo></mrow><annotation encoding="application/x-tex">\lceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">âŒˆ</span></span></span></span> å­—å…¸æ ‘ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">âŒ‹</mo></mrow><annotation encoding="application/x-tex">\rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">âŒ‹</span></span></span></span>ï¼Œæ˜¯ä¸€ç§å¤šå‰æ ‘ï¼Œç”¨æ¥è¿›è¡Œå¿«é€Ÿå‰ç¼€åŒ¹é…çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚</p><p>ä¸ä¸€èˆ¬å¤šå‰æ ‘ä¸åŒçš„æ˜¯ï¼Œ</p><ul><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>r</mi><mi>i</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">Trie</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span></span></span></span> çš„èŠ‚ç‚¹ä¸å­˜å‚¨èŠ‚ç‚¹ä¿¡æ¯ï¼Œä»…ä»…å­˜æ”¾ä¸€ä¸ªæ ‡è®°ä½ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi><mi>s</mi><mi>E</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">isEnd</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">n</span><span class="mord mathdefault">d</span></span></span></span> ï¼Œç”¨æ¥æ ‡è®°å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯è·¯å¾„çš„ç»ˆç‚¹ï¼Œå³ä» <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>o</mi><mi>o</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">root</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span></span></span></span> åˆ°å½“å‰èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå•è¯ã€‚</li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>r</mi><mi>i</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">Trie</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span></span></span></span> çš„èŠ‚ç‚¹ä¿¡æ¯å­˜æ”¾åœ¨æ ‘æä¸­ã€‚</li></ul><h2 id="åº”ç”¨"><a class="markdownIt-Anchor" href="#åº”ç”¨"></a> åº”ç”¨</h2><ul><li>å‰ç¼€åŒ¹é…</li><li>å•è¯è¡¥å…¨</li><li>å•è¯çº é”™</li></ul><h2 id="å®ç°"><a class="markdownIt-Anchor" href="#å®ç°"></a> å®ç°</h2><ol><li><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>r</mi><mi>i</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">Trie</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span></span></span></span> èŠ‚ç‚¹å®šä¹‰</p> <div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">TrieNode</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">boolean</span> isEnd<span class="token punctuation">;</span>          <span class="token comment">// æ˜¯å¦æ˜¯å•è¯ç»“å°¾</span>    <span class="token class-name">TrieNode</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">;</span>     <span class="token comment">// 26å‰æ ‘</span>    <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        isEnd <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        children <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>r</mi><mi>i</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">Trie</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span></span></span></span> å»ºç«‹</p><p>å¯¹äºç»™å®šçš„å­—ç¬¦ä¸² <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">word</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">d</span></span></span></span>ï¼Œéå†å…¶æ¯ä¸ªå­—ç¬¦ï¼Œä¸€æ¬¡åœ¨ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>r</mi><mi>i</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">Trie</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span></span></span></span> ä¸­æ£€æŸ¥å…¶æ˜¯å¦å­˜åœ¨ï¼Œ</p><ul><li>å¦‚æœå­˜åœ¨ï¼Œåˆ™ç»§ç»­å¾€ä¸‹æŸ¥æ‰¾ï¼›</li><li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åœ¨å¯¹åº”åˆ†æ”¯ä¸Šåˆ›å»ºèŠ‚ç‚¹ï¼Œç»§ç»­å¾€ä¸‹æŸ¥æ‰¾ã€‚ç›´è‡³éå†å®Œ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">word</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">d</span></span></span></span></li></ul><p>æœ€åï¼Œç½® <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi><mi>s</mi><mi>E</mi><mi>n</mi><mi>d</mi><mo>=</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">isEnd=true</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">n</span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">u</span><span class="mord mathdefault">e</span></span></span></span>ï¼Œè¡¨ç¤ºä»¥è¯¥èŠ‚ç‚¹ä¸ºç»“å°¾çš„å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªå®Œæ•´çš„å•è¯</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">TrieNode</span> p <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> idx <span class="token operator">=</span> word<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'a'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// æ–°å»ºèŠ‚ç‚¹</span>            p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// å¾€ä¸‹è¿­ä»£</span>        p <span class="token operator">=</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// æ ‡è®°ä¸ºå•è¯ç»“å°¾</span>    p<span class="token punctuation">.</span>isEnd <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>æŸ¥æ‰¾æ•´ä¸ªå­—ç¬¦ä¸² <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">word</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">d</span></span></span></span></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">TrieNode</span> p <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> idx <span class="token operator">=</span> word<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'a'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        p <span class="token operator">=</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// å¦‚æœwordæœ€åä¸€ä¸ªå­—ç¬¦æ˜¯å•è¯ç»“å°¾ï¼Œåˆ™æŸ¥æ‰¾æˆåŠŸï¼›å¦åˆ™ï¼Œwordåªæ˜¯trieä¸­çš„ä¸€ä¸ªå‰ç¼€</span>    <span class="token keyword">return</span> p<span class="token punctuation">.</span>isEnd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>æŸ¥æ‰¾å‰ç¼€ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">prefix</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">x</span></span></span></span></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">TrieNode</span> p <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> prefix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> idx <span class="token operator">=</span> prefix<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'a'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        p <span class="token operator">=</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// æŸ¥æ‰¾åˆ°prefixï¼Œè¯´æ˜trieä¸­è‚¯å®šå­˜åœ¨ä»¥prefixä¸ºå‰ç¼€çš„å•è¯</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>å®Œæ•´ä»£ç </p> <div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">TrieNode</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">boolean</span> isEnd<span class="token punctuation">;</span>          <span class="token comment">// æ˜¯å¦æ˜¯å•è¯ç»“å°¾</span>    <span class="token class-name">TrieNode</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">;</span>     <span class="token comment">// 26å‰æ ‘</span>    <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        isEnd <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        children <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">class</span> <span class="token class-name">Trie</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// trieæ ‘ï¼Œè¾¹å­˜æ”¾å­—ç¬¦ä¿¡æ¯ï¼ŒèŠ‚ç‚¹æ ‡è®°æ˜¯å¦æ˜¯å•è¯ç»“å°¾ï¼ŒåŠåç»­å­—ç¬¦æ˜¯ä»€ä¹ˆ</span>    <span class="token class-name">TrieNode</span> root<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Trie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">TrieNode</span> p <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> idx <span class="token operator">=</span> word<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'a'</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// æ–°å»ºèŠ‚ç‚¹</span>                p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// å¾€ä¸‹è¿­ä»£</span>            p <span class="token operator">=</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// æ ‡è®°ä¸ºå•è¯ç»“å°¾</span>        p<span class="token punctuation">.</span>isEnd <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">TrieNode</span> p <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> idx <span class="token operator">=</span> word<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'a'</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            p <span class="token operator">=</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// å¦‚æœwordæœ€åä¸€ä¸ªå­—ç¬¦æ˜¯å•è¯ç»“å°¾ï¼Œåˆ™æŸ¥æ‰¾æˆåŠŸï¼›å¦åˆ™ï¼Œwordåªæ˜¯trieä¸­çš„ä¸€ä¸ªå‰ç¼€</span>        <span class="token keyword">return</span> p<span class="token punctuation">.</span>isEnd<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">TrieNode</span> p <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> prefix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> idx <span class="token operator">=</span> prefix<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'a'</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            p <span class="token operator">=</span> p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// æŸ¥æ‰¾åˆ°prefixï¼Œè¯´æ˜trieä¸­è‚¯å®šå­˜åœ¨ä»¥prefixä¸ºå‰ç¼€çš„å•è¯</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li></ol>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•ä¸æ•°æ®ç»“æ„</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å‰ç¼€æ ‘</tag>
      
      <tag>Trie</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2022/05/16/hello-world/"/>
    <url>/2022/05/16/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="quick-start"><a class="markdownIt-Anchor" href="#quick-start"></a> Quick Start</h2><h3 id="create-a-new-post"><a class="markdownIt-Anchor" href="#create-a-new-post"></a> Create a new post</h3><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="run-server"><a class="markdownIt-Anchor" href="#run-server"></a> Run server</h3><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="generate-static-files"><a class="markdownIt-Anchor" href="#generate-static-files"></a> Generate static files</h3><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="deploy-to-remote-sites"><a class="markdownIt-Anchor" href="#deploy-to-remote-sites"></a> Deploy to remote sites</h3><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
